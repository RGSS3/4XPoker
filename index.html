<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ–‡æ˜4Xæ‰‘å…‹</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        primary: '#5D5CDE',
                        land: '#8BC34A',    // é™†åœ°ç»¿è‰²
                        ocean: '#03A9F4',   // æµ·æ´‹è“è‰²
                        desert: '#FFC107',  // æ²™æ¼ é»„è‰²
                        sky: '#9C27B0',     // å¤©ç©ºç´«è‰²
                        unexplored: '#9E9E9E', // æœªæ¢ç´¢ç°è‰²
                        explored: '#E0E0E0',   // å·²æ¢ç´¢ç™½è‰²
                        occupied: '#2196F3',   // å·²å é¢†è“è‰²
                        echo: '#4CAF50',     // å›å£°åŒºåŸŸç»¿è‰²
                        wonder: '#8BC34A',   // å¥‡è§‚åŒºåŸŸæµ…ç»¿è‰²
                        combat: '#F44336',   // æˆ˜æ–—åŒºåŸŸçº¢è‰²
                        disaster: '#FF5722'  // ç¾éš¾åŒºåŸŸæ©™è‰²
                    }
                }
            }
        }
    </script>
    <style>
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        @keyframes fadeOut {
            from { opacity: 1; }
            to { opacity: 0; }
        }
        
        .card-fade-in {
            animation: fadeIn 0.3s ease-in-out;
        }
        
        .card-fade-out {
            animation: fadeOut 0.3s ease-in-out;
        }
        
        .card {
            aspect-ratio: 2/3;
            perspective: 1000px;
        }
        
        .card-inner {
            transform-style: preserve-3d;
            transition: transform 0.6s;
        }
        
        .card-front, .card-back {
            backface-visibility: hidden;
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            border-radius: 0.5rem;
        }
        
        .card-back {
            transform: rotateY(180deg);
            background-image: repeating-linear-gradient(45deg, rgba(93, 92, 222, 0.1) 0, rgba(93, 92, 222, 0.1) 10px, transparent 10px, transparent 20px);
        }
        
        .dark .card-back {
            background-image: repeating-linear-gradient(45deg, rgba(93, 92, 222, 0.2) 0, rgba(93, 92, 222, 0.2) 10px, transparent 10px, transparent 20px);
        }
        
        /* èŠ±è‰²é¢œè‰²å®šä¹‰ */
        .heart {
            color: #E53E3E; /* çº¢è‰² */
        }
        
        .dark .heart {
            color: #FC8181; /* æ·±è‰²æ¨¡å¼ä¸‹çš„çº¢è‰² */
        }
        
        .diamond {
            color: #ED8936; /* æ©™è‰² */
        }
        
        .dark .diamond {
            color: #F6AD55; /* æ·±è‰²æ¨¡å¼ä¸‹çš„æ©™è‰² */
        }
        
        .spade {
            color: #805AD5; /* ç´«è‰² */
        }
        
        .dark .spade {
            color: #9F7AEA; /* æ·±è‰²æ¨¡å¼ä¸‹çš„ç´«è‰² */
        }
        
        .club {
            color: #2D3748; /* æ·±ç°è‰²/é»‘è‰² */
        }
        
        .dark .club {
            color: #E2E8F0; /* æ·±è‰²æ¨¡å¼ä¸‹çš„ç°ç™½è‰² */
        }

        /* æ¸¸æˆæ¿åŒºåŸŸç±»å‹æ ·å¼ */
        .region-unexplored {
            background-color: theme('colors.unexplored');
        }
        
        .region-explored {
            background-color: theme('colors.explored');
        }
        
        .region-occupied {
            background-color: theme('colors.occupied');
        }
        
        .region-echo {
            background-color: theme('colors.echo');
        }
        
        /* å¥‡è§‚æ ·å¼ */
        .wonder-orange {
            background-color: #FF9800;
            color: #fff;
        }
        
        .wonder-purple {
            background-color: #9C27B0;
            color: #fff;
        }
        
        .wonder-blue {
            background-color: #2196F3;
            color: #fff;
        }
        
        .dark .wonder-orange {
            background-color: #E65100;
        }
        
        .dark .wonder-purple {
            background-color: #6A1B9A;
        }
        
        .dark .wonder-blue {
            background-color: #0D47A1;
        }
        
        /* æ¢ç´¢çº¿è·¯æ ·å¼ */
        .path-land {
            border-left: 4px solid theme('colors.land');
        }
        
        .path-ocean {
            border-left: 4px solid theme('colors.ocean');
        }
        
        .path-desert {
            border-left: 4px solid theme('colors.desert');
        }
        
        .path-sky {
            border-left: 4px solid theme('colors.sky');
        }
        
        /* æ‰‹ç‰Œæ‚¬åœæ•ˆæœ */
        .hand-card:hover {
            transform: translateY(-10px);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }
        
        /* Ensure all inputs have at least 16px font size on mobile */
        @media (max-width: 768px) {
            input, button, select, textarea {
                font-size: 16px !important;
            }
        }
        
        /* Disable text selection for the game interface */
        body {
            user-select: none;
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
        }
        
        /* Re-enable text selection for input elements */
        input, textarea {
            user-select: text;
            -webkit-user-select: text;
            -moz-user-select: text;
            -ms-user-select: text;
        }
    </style>
</head>
<body class="bg-white dark:bg-gray-900 text-gray-900 dark:text-gray-100 min-h-screen">
    <div class="container mx-auto px-4 py-8 max-w-6xl">
        <!-- æ¸¸æˆæ ‡é¢˜å’Œä¿¡æ¯ -->
        <div class="text-center mb-4">
            <h1 class="text-3xl font-bold mb-2" data-i18n="gameTitle">æ–‡æ˜4Xæ‰‘å…‹</h1>
            <p class="text-sm md:text-base text-gray-600 dark:text-gray-400 mb-2" data-i18n="gameDescription">æ¢ç´¢ã€æ‰©å¼ ã€å¼€å‘ã€å¾æœï¼ä½¿ç”¨æ‰‘å…‹ç‰Œå»ºç«‹æ‚¨çš„æ–‡æ˜</p>
        </div>
        
        <!-- ç§å­è¾“å…¥åŒºåŸŸ -->
        <div class="flex flex-col md:flex-row justify-center items-center mb-4 gap-2">
            <div class="bg-gray-100 dark:bg-gray-800 rounded-lg p-3 shadow-md flex-grow max-w-xl w-full">
                <div class="flex flex-wrap gap-2 items-center">
                    <label for="seed-input" class="font-bold text-sm whitespace-nowrap">æ¸¸æˆç§å­:</label>
                    <div class="flex flex-1 min-w-0">
                        <input 
                            id="seed-input" 
                            type="text" 
                            class="flex-1 min-w-0 text-base p-2 border border-gray-300 dark:border-gray-600 rounded-l-md bg-white dark:bg-gray-700 text-gray-800 dark:text-gray-200"
                            placeholder="è¾“å…¥ç§å­å€¼æˆ–ä½¿ç”¨éšæœºç§å­" 
                            value="" 
                            spellcheck="false"
                        />
                        <button id="random-seed-btn" class="bg-gray-200 dark:bg-gray-700 hover:bg-gray-300 dark:hover:bg-gray-600 px-3 py-2 rounded-r-md text-gray-700 dark:text-gray-300 flex items-center">
                            ğŸ²
                        </button>
                    </div>
                    <button id="start-seed-game" class="bg-primary hover:bg-indigo-700 text-white px-4 py-2 rounded-lg whitespace-nowrap">
                        å¼€å§‹æ¸¸æˆ
                    </button>
                </div>
            </div>
        </div>
        
        <!-- æ¸¸æˆæ§åˆ¶å’Œä¿¡æ¯ -->
        <div class="flex flex-wrap justify-between items-center mb-4 gap-2">
            <!-- å¾—åˆ†å’Œå›åˆä¿¡æ¯ -->
            <div class="flex flex-col bg-gray-100 dark:bg-gray-800 rounded-lg p-2 shadow-md">
                <div class="flex items-center space-x-4">
                    <div class="text-xl font-bold"><span data-i18n="score">å¾—åˆ†</span>: <span id="score" class="text-primary">0</span></div>
                    <div class="text-lg"><span data-i18n="turn">å›åˆ</span>: <span id="turn-counter">1</span></div>
                </div>
                <div class="text-sm text-gray-600 dark:text-gray-400 flex space-x-3">
                    <div><span data-i18n="remainingCards">ç‰Œå †</span>: <span id="remaining-cards">47</span></div>
                    <div><span>å¼ƒç‰Œå †</span>: <span id="discard-count">0</span></div>
                </div>
            </div>
            
            <!-- ç§å­ä¿¡æ¯å’Œåˆ†äº« -->
            <div class="flex items-center bg-gray-100 dark:bg-gray-800 rounded-lg p-2 shadow-md">
                <span class="mr-2 text-sm" data-i18n="randomSeed">éšæœºç§å­</span>
                <code id="seed-display" class="bg-gray-200 dark:bg-gray-700 px-2 py-1 rounded text-xs break-all mr-2"></code>
                <div class="flex space-x-1">
                    <button id="random-seed" class="text-primary hover:text-primary-dark p-1 rounded text-xs" title="ç”Ÿæˆéšæœºç§å­">ğŸ²</button>
                    <button id="input-seed" class="text-primary hover:text-primary-dark p-1 rounded text-xs" title="è¾“å…¥ç§å­">âŒ¨ï¸</button>
                    <button id="copy-seed" class="text-primary hover:text-primary-dark p-1 rounded text-xs" title="å¤åˆ¶ç§å­">ğŸ“‹</button>
                    <button id="share-game" class="text-primary hover:text-primary-dark p-1 rounded text-xs" title="åˆ†äº«æ¸¸æˆ">â†—ï¸</button>
                </div>
            </div>
            
            <!-- æ¸¸æˆæ§åˆ¶æŒ‰é’® -->
            <div class="flex space-x-2">
                <button id="new-game-btn" class="bg-primary hover:bg-indigo-700 text-white px-3 py-1 rounded-lg text-sm">
                    <span data-i18n="newGame">æ–°æ¸¸æˆ</span>
                </button>
                <button id="undo-btn" class="bg-gray-200 dark:bg-gray-700 hover:bg-gray-300 dark:hover:bg-gray-600 text-gray-700 dark:text-gray-300 px-3 py-1 rounded-lg text-sm opacity-50" disabled>
                    <span data-i18n="undo">æ’¤é”€</span>
                </button>
                <button id="history-btn" class="bg-gray-200 dark:bg-gray-700 hover:bg-gray-300 dark:hover:bg-gray-600 text-gray-700 dark:text-gray-300 px-3 py-1 rounded-lg text-sm">
                    <span data-i18n="history">å†å²</span>
                </button>
            </div>
        </div>
        
        <!-- æ¸¸æˆåŒºåŸŸ -->
        <div class="flex flex-col md:flex-row gap-4">
            <!-- ä¸»æ¸¸æˆåŒºåŸŸ -->
            <div class="w-full md:w-3/4 bg-gray-100 dark:bg-gray-800 rounded-lg p-4 shadow-md overflow-x-auto">
                <div class="min-w-[800px]">
                    <!-- æ¸¸æˆåŒºåŸŸï¼š4åˆ—13è¡Œå¸ƒå±€ -->
                    <div class="flex justify-center">
                        <div class="grid grid-cols-4 gap-2 w-full max-w-2xl">
                            <!-- è·¯å¾„æ ‡é¢˜ -->
                            <div class="bg-land text-white rounded px-2 py-1 text-center font-bold">é™†åœ°</div>
                            <div class="bg-ocean text-white rounded px-2 py-1 text-center font-bold">æµ·æ´‹</div>
                            <div class="bg-desert text-white rounded px-2 py-1 text-center font-bold">æ²™æ¼ </div>
                            <div class="bg-sky text-white rounded px-2 py-1 text-center font-bold">å¤©ç©º</div>
                            
                            <!-- æ¸¸æˆåŒºåŸŸæ ¼å­ -->
                            <div id="land-regions" class="flex flex-col gap-1">
                                <!-- é™†åœ°åŒºåŸŸå°†é€šè¿‡JSåŠ¨æ€ç”Ÿæˆ -->
                            </div>
                            <div id="ocean-regions" class="flex flex-col gap-1">
                                <!-- æµ·æ´‹åŒºåŸŸå°†é€šè¿‡JSåŠ¨æ€ç”Ÿæˆ -->
                            </div>
                            <div id="desert-regions" class="flex flex-col gap-1">
                                <!-- æ²™æ¼ åŒºåŸŸå°†é€šè¿‡JSåŠ¨æ€ç”Ÿæˆ -->
                            </div>
                            <div id="sky-regions" class="flex flex-col gap-1">
                                <!-- å¤©ç©ºåŒºåŸŸå°†é€šè¿‡JSåŠ¨æ€ç”Ÿæˆ -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- å³ä¾§ä¿¡æ¯å’Œæ“ä½œåŒº -->
            <div class="w-full md:w-1/4 flex flex-col gap-4">
                <!-- æ¸¸æˆæ¶ˆæ¯åŒº -->
                <div class="bg-gray-100 dark:bg-gray-800 rounded-lg p-3 shadow-md h-24 overflow-y-auto">
                    <h3 class="text-sm font-bold mb-1 text-gray-700 dark:text-gray-300" data-i18n="gameMessages">æ¸¸æˆæ¶ˆæ¯</h3>
                    <div id="game-message" class="text-sm"></div>
                </div>
                
                <!-- è¡ŒåŠ¨åŒº -->
                <div class="bg-gray-100 dark:bg-gray-800 rounded-lg p-3 shadow-md">
                    <h3 class="text-sm font-bold mb-2 text-gray-700 dark:text-gray-300" data-i18n="actions">è¡ŒåŠ¨</h3>
                    <div class="space-y-2">
                        <div class="text-sm mb-2 text-gray-600 dark:text-gray-400 text-center">
                            <p data-i18n="selectCardFirst">å…ˆé€‰æ‹©æ‰‹ç‰Œï¼Œå†ç‚¹å‡»åŒºåŸŸ</p>
                        </div>
                        <div class="text-xs text-gray-500 dark:text-gray-400 mt-2">
                            <ul class="list-disc list-inside">
                                <li>æ¢ç´¢éœ€è¦ç‚¹æ•°â‰¥æ ¼å­ç­‰çº§çš„å¡ç‰Œ</li>
                                <li>é»‘æ¡ƒæ¢ç´¢æ—¶ç‚¹æ•°ç¿»å€</li>
                                <li>çº¢æ¡ƒå é¢†æ—¶å¾—åˆ†æé«˜</li>
                                <li>æ‰‹ç‰Œä¸Šé™ï¼š10å¼ </li>
                            </ul>
                        </div>
                    </div>
                </div>
                
                <!-- æ¸¸æˆæ—¥å¿— -->
                <div class="bg-gray-100 dark:bg-gray-800 rounded-lg p-3 shadow-md flex-grow overflow-y-auto">
                    <h3 class="text-sm font-bold mb-1 text-gray-700 dark:text-gray-300" data-i18n="gameLog">æ¸¸æˆæ—¥å¿—</h3>
                    <div id="game-log" class="text-xs space-y-1 h-40 overflow-y-auto"></div>
                </div>
            </div>
        </div>
        
        <!-- æ‰‹ç‰ŒåŒºåŸŸ -->
        <div class="mt-4">
            <div class="flex justify-between items-center mb-2">
                <h3 class="text-lg font-bold" data-i18n="yourHand">æ‚¨çš„æ‰‹ç‰Œ</h3>
                <div class="flex space-x-2">
                    <button id="discard-btn" class="bg-red-500 hover:bg-red-600 text-white py-1 px-3 rounded-lg text-sm flex items-center">
                        <span>å¼ƒç‰Œ</span>
                        <span class="ml-1 text-xs opacity-75">(é€‰ä¸­ç‰Œ)</span>
                    </button>
                    <button id="end-turn-btn" class="bg-yellow-600 hover:bg-yellow-700 text-white py-1 px-3 rounded-lg text-sm">
                        <span data-i18n="endTurn">ç»“æŸå›åˆ</span>
                    </button>
                </div>
            </div>
            <div class="flex flex-col">
                <div id="hand-container" class="flex justify-center gap-2 flex-wrap p-4 bg-gray-100 dark:bg-gray-800 rounded-lg min-h-[150px] relative">
                    <!-- æ‰‹ç‰Œå°†åœ¨è¿™é‡ŒåŠ¨æ€ç”Ÿæˆ -->
                </div>
                <div class="text-xs text-right mt-1 text-gray-500 dark:text-gray-400">
                    æ‰‹ç‰Œ: <span id="hand-count">0</span>/10
                </div>
            </div>
        </div>
        
        <!-- å½“å‰é€‰æ‹©çš„è¡ŒåŠ¨æç¤º -->
        <div id="action-info" class="mt-2 text-center text-sm text-gray-600 dark:text-gray-400 h-6"></div>
        
        <!-- æ¸¸æˆç»“æœå¼¹çª— -->
        <div id="result-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50">
            <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-lg max-w-md w-full mx-4">
                <h2 class="text-2xl font-bold mb-4 text-center" data-i18n="gameOver">æ¸¸æˆç»“æŸ</h2>
                <p class="text-lg mb-2"><span data-i18n="finalScore">æœ€ç»ˆå¾—åˆ†</span>: <span id="final-score" class="font-bold"></span></p>
                <p class="mb-4 text-sm text-gray-600 dark:text-gray-400" data-i18n="playAgainPrompt">å†æ¥ä¸€æ¬¡ï¼Œåˆ›å»ºæ›´å¼ºå¤§çš„æ–‡æ˜ï¼</p>
                <div class="flex flex-wrap justify-center gap-2">
                    <button id="play-again" class="bg-primary hover:bg-indigo-700 text-white px-4 py-2 rounded-lg" data-i18n="newGame">æ–°æ¸¸æˆ</button>
                    <button id="replay-same-seed" class="bg-yellow-500 hover:bg-yellow-600 text-white px-4 py-2 rounded-lg" data-i18n="replaySameSeed">é‡ç©æœ¬å±€</button>
                    <button id="share-result" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg" data-i18n="shareResult">åˆ†äº«æˆç»©</button>
                </div>
            </div>
        </div>
        
        <!-- å†å²æµè§ˆå™¨å¼¹çª— -->
        <div id="history-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50">
            <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-lg max-w-4xl w-full mx-4 max-h-[90vh] overflow-y-auto">
                <h2 class="text-xl font-bold mb-4 text-center" data-i18n="historyBrowser">å†å²æµè§ˆå™¨</h2>
                <div class="flex justify-between items-center mb-2">
                    <div class="text-sm">
                        <span data-i18n="turn">å›åˆ</span>: <span id="history-turn" class="font-bold">1</span> / 
                        <span data-i18n="move">æ“ä½œ</span>: <span id="history-index" class="font-bold">0</span> / <span id="history-total" class="font-bold">0</span>
                    </div>
                    <div class="text-sm">
                        <span data-i18n="score">å¾—åˆ†</span>: <span id="history-score" class="font-bold">0</span>
                    </div>
                </div>
                
                <!-- æµè§ˆæ§åˆ¶ -->
                <div class="flex justify-between items-center mb-3">
                    <button id="history-prev" class="bg-gray-200 dark:bg-gray-700 hover:bg-gray-300 dark:hover:bg-gray-600 text-gray-700 dark:text-gray-300 py-2 px-4 rounded-lg text-sm flex items-center">
                        <svg class="w-5 h-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
                        </svg>
                    </button>
                    <div class="text-center">
                        <span id="history-action-desc" class="text-sm"></span>
                    </div>
                    <button id="history-next" class="bg-gray-200 dark:bg-gray-700 hover:bg-gray-300 dark:hover:bg-gray-600 text-gray-700 dark:text-gray-300 py-2 px-4 rounded-lg text-sm flex items-center">
                        <svg class="w-5 h-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
                        </svg>
                    </button>
                </div>
                
                <!-- å†å²çŠ¶æ€æ˜¾ç¤º -->
                <div id="history-board" class="bg-white dark:bg-gray-900 rounded-lg p-2 mb-4">
                    <!-- å†å²çŠ¶æ€å°†åœ¨è¿™é‡ŒåŠ¨æ€æ˜¾ç¤º -->
                </div>
                
                <!-- å¯¼å‡ºæŒ‰é’® -->
                <div class="flex justify-center gap-2 mb-4">
                    <button id="export-html" class="bg-green-600 hover:bg-green-700 text-white px-3 py-1 rounded-lg text-sm flex items-center">
                        <svg class="w-4 h-4 mr-1" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" />
                        </svg>
                        <span>HTML</span>
                    </button>
                    <button id="export-txt" class="bg-blue-600 hover:bg-blue-700 text-white px-3 py-1 rounded-lg text-sm flex items-center">
                        <svg class="w-4 h-4 mr-1" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" />
                        </svg>
                        <span>TXT</span>
                    </button>
                </div>
                
                <!-- æ§åˆ¶æŒ‰é’® -->
                <div class="flex justify-center gap-3">
                    <button id="history-select" class="bg-primary hover:bg-indigo-700 text-white px-4 py-2 rounded-lg" data-i18n="selectThis">é€‰æ‹©æ­¤çŠ¶æ€</button>
                    <button id="history-cancel" class="bg-gray-200 dark:bg-gray-700 hover:bg-gray-300 dark:hover:bg-gray-600 text-gray-700 dark:text-gray-300 px-4 py-2 rounded-lg" data-i18n="cancel">å–æ¶ˆ</button>
                </div>
            </div>
        </div>
        
        <!-- æç¤ºå¼¹çª— -->
        <div id="toast" class="fixed bottom-4 left-1/2 transform -translate-x-1/2 bg-gray-800 text-white px-4 py-2 rounded-lg opacity-0 transition-opacity duration-300 z-50">
            <!-- æç¤ºå†…å®¹ -->
        </div>

        <script>
            // æ¸¸æˆå¸¸é‡
            const SUITS = ['heart', 'diamond', 'spade', 'club'];
            const SUIT_SYMBOLS = {
                'heart': 'â™¥',
                'diamond': 'â™¦',
                'spade': 'â™ ',
                'club': 'â™£'
            };
            const RANKS = ['A', '2', '3', '4', '5', '6', '7', '8', '9', '10', 'J', 'Q', 'K'];
            const RANK_VALUES = {
                'A': 14, '2': 2, '3': 3, '4': 4, '5': 5, '6': 6, '7': 7,
                '8': 8, '9': 9, '10': 10, 'J': 11, 'Q': 12, 'K': 13
            };
            
            // è·¯å¾„å®šä¹‰
            const PATHS = ['land', 'ocean', 'desert', 'sky'];
            const PATH_NAMES = {
                'land': 'é™†åœ°',
                'ocean': 'æµ·æ´‹',
                'desert': 'æ²™æ¼ ',
                'sky': 'å¤©ç©º'
            };
            
            // åŒºåŸŸç±»å‹
            const REGION_TYPES = {
                'standard': {
                    name: 'æ™®é€šåŒºåŸŸ',
                    color: 'explored',
                    explorePoints: 1,
                    occupyPoints: 1
                },
                'echo': {
                    name: 'å›å£°åŒºåŸŸ',
                    color: 'echo',
                    explorePoints: 1,
                    // occupyPointsåœ¨å é¢†æ—¶è®¡ç®—ï¼ˆ= ç‰Œå€¼ x 2ï¼‰
                },
                'wonder': {
                    name: 'å¥‡è§‚åŒºåŸŸ',
                    color: 'wonder',
                    explorePoints: 2,
                    // å¥‡è§‚æœ‰ç‰¹æ®Šå é¢†é€»è¾‘å’Œæ•ˆæœ
                }
            };
            
            // å¥‡è§‚å¼ºåº¦çº§åˆ«
            const WONDER_TIERS = {
                'orange': { color: 'orange', name: 'æ©™çº§å¥‡è§‚', baseScore: 7, effectMultiplier: 3 },
                'purple': { color: 'purple', name: 'ç´«çº§å¥‡è§‚', baseScore: 5, effectMultiplier: 2 },
                'blue': { color: 'blue', name: 'è“çº§å¥‡è§‚', baseScore: 3, effectMultiplier: 1 }
            };
            
            // å¥‡è§‚åç§°åˆ—è¡¨ï¼ˆä¸ƒå¤§å¥‡è¿¹å’ŒSCPä¸ƒå¤§åœ°ç‚¹ï¼‰
            const WONDER_NAMES = [
                'äºšå†å±±å¤§æ¸¯ç¯å¡”', 'å·´æ¯”ä¼¦ç©ºä¸­èŠ±å›­', 'å¥¥æ—åŒ¹äºšå®™æ–¯åƒ', 
                'é˜¿å°”å¿’å¼¥æ–¯ç¥åº™', 'æ‘©ç´¢æ‹‰æ–¯é™µå¢“', 'ç½—å¾·å²›å¤ªé˜³ç¥å·¨åƒ', 
                'äºšå†å±±å¤§å›¾ä¹¦é¦†', 'é‡‘å­—å¡”', 'ä¸‡é‡Œé•¿åŸ', 'åŸƒè²å°”é“å¡”',
                'SCP-2000 å¤å…´', 'SCP-3000 æ·±æµ·å·¨è›‡', 'SCP-1000 è¿œå¤æ£®æ—',
                'SCP-2317 ç ´ç¢ä¹‹é—¨', 'SCP-3999 ç»ˆç„‰ä¹‹åœ°', 'SCP-4000 é—å¿˜æ£®æ—',
                'SCP-001 å®ˆé—¨äºº'
            ];
            
            // å¥‡è§‚æ•ˆæœç±»å‹åŠå…¶æƒé‡
            const WONDER_EFFECTS = [
                { type: 'draw', name: 'æŠ½å¡', weight: 4, description: 'æ¯å›åˆé¢å¤–æŠ½ç‰Œ' },
                { type: 'score', name: 'å¾—åˆ†', weight: 6, description: 'æ¯å›åˆé¢å¤–å¾—åˆ†' },
                { type: 'explore', name: 'æ¢ç´¢', weight: 2, description: 'å é¢†æ—¶é¢å¤–æ¢ç´¢è¯¥è·¯å¾„ä¸Šçš„æ ¼å­' },
                { type: 'heart_bonus', name: 'çº¢æ¡ƒæ”¶è·', weight: 2, description: 'è¯¥è·¯å¾„ä¸Šæ¯ä¸ªçº¢æ¡ƒå é¢†æ¯å›åˆ+2åˆ†' },
                { type: 'spade_bonus', name: 'é»‘æ¡ƒæ”¶è·', weight: 2, description: 'è¯¥è·¯å¾„ä¸Šæ¯ä¸ªé»‘æ¡ƒå é¢†æ¯å›åˆ+2åˆ†' },
                { type: 'diamond_bonus', name: 'æ–¹ç‰‡æ”¶è·', weight: 2, description: 'è¯¥è·¯å¾„ä¸Šæ¯ä¸ªæ–¹ç‰‡å é¢†æ¯å›åˆ+2åˆ†' },
                { type: 'club_bonus', name: 'æ¢…èŠ±æ”¶è·', weight: 2, description: 'è¯¥è·¯å¾„ä¸Šæ¯ä¸ªæ¢…èŠ±å é¢†æ¯å›åˆ+2åˆ†' }
            ];
            
            // å¤šè¯­è¨€æ”¯æŒ
            const LANGUAGES = {
                'zh-CN': {
                    name: 'ä¸­æ–‡',
                    gameTitle: 'æ–‡æ˜4Xæ‰‘å…‹',
                    gameDescription: 'æ¢ç´¢ã€æ‰©å¼ ã€å¼€å‘ã€å¾æœï¼ä½¿ç”¨æ‰‘å…‹ç‰Œå»ºç«‹æ‚¨çš„æ–‡æ˜',
                    score: 'å¾—åˆ†',
                    turn: 'å›åˆ',
                    remainingCards: 'å‰©ä½™ç‰Œæ•°',
                    randomSeed: 'éšæœºç§å­',
                    newGame: 'æ–°æ¸¸æˆ',
                    undo: 'æ’¤é”€',
                    history: 'å†å²',
                    gameMessages: 'æ¸¸æˆæ¶ˆæ¯',
                    actions: 'è¡ŒåŠ¨',
                    explore: 'æ¢ç´¢',
                    occupy: 'å é¢†',
                    endTurn: 'ç»“æŸå›åˆ',
                    gameLog: 'æ¸¸æˆæ—¥å¿—',
                    yourHand: 'æ‚¨çš„æ‰‹ç‰Œ',
                    gameOver: 'æ¸¸æˆç»“æŸ',
                    finalScore: 'æœ€ç»ˆå¾—åˆ†',
                    playAgainPrompt: 'å†æ¥ä¸€æ¬¡ï¼Œåˆ›å»ºæ›´å¼ºå¤§çš„æ–‡æ˜ï¼',
                    replaySameSeed: 'é‡ç©æœ¬å±€',
                    shareResult: 'åˆ†äº«æˆç»©',
                    historyBrowser: 'å†å²æµè§ˆå™¨',
                    selectThis: 'é€‰æ‹©æ­¤çŠ¶æ€',
                    cancel: 'å–æ¶ˆ',
                    move: 'æ“ä½œ',
                    copy: 'å¤åˆ¶',
                    share: 'åˆ†äº«',
                    copied: 'å·²å¤åˆ¶åˆ°å‰ªè´´æ¿',
                    shareText: 'æˆ‘åœ¨æ–‡æ˜4Xæ‰‘å…‹æ¸¸æˆä¸­è·å¾—äº†{score}åˆ†ï¼éšæœºç§å­:{seed}ï¼Œæ¥æŒ‘æˆ˜æˆ‘å§ï¼',
                    selectCard: 'è¯·é€‰æ‹©ä¸€å¼ æ‰‹ç‰Œ',
                    selectRegion: 'è¯·é€‰æ‹©ä¸€ä¸ªåŒºåŸŸ',
                    noValidRegion: 'æ²¡æœ‰æœ‰æ•ˆçš„åŒºåŸŸå¯ä»¥é€‰æ‹©',
                    exploreDone: 'æ¢ç´¢æˆåŠŸï¼è·å¾—{points}åˆ†',
                    occupyDone: 'å é¢†æˆåŠŸï¼æ¯å›åˆè·å¾—{points}åˆ†',
                    turnEnded: 'å›åˆç»“æŸï¼Œè·å¾—{points}åˆ†',
                    cardDrawn: 'æŠ½äº†ä¸€å¼ ç‰Œï¼š{rank}{suit}',
                    gameStart: 'æ¸¸æˆå¼€å§‹ï¼èµ·å§‹æ‰‹ç‰Œï¼š5å¼ ',
                    notEnoughRank: 'å¡ç‰Œç‚¹æ•°ä¸è¶³ä»¥æ¢ç´¢è¯¥åŒºåŸŸ',
                    alreadyOccupied: 'è¯¥åŒºåŸŸå·²è¢«å é¢†',
                    notExplored: 'è¯¥åŒºåŸŸå°šæœªæ¢ç´¢',
                    infoSelectCardToExplore: 'è¯·é€‰æ‹©ä¸€å¼ æ‰‹ç‰Œè¿›è¡Œæ¢ç´¢',
                    infoSelectCardToOccupy: 'è¯·é€‰æ‹©ä¸€å¼ æ‰‹ç‰Œè¿›è¡Œå é¢†',
                    pathLand: 'é™†åœ°',
                    pathOcean: 'æµ·æ´‹',
                    pathDesert: 'æ²™æ¼ ',
                    pathSky: 'å¤©ç©º',
                    standardRegion: 'æ™®é€šåŒºåŸŸ',
                    echoRegion: 'å›å£°åŒºåŸŸ',
                    exploredRegion: 'å·²æ¢ç´¢',
                    unexploredRegion: 'æœªæ¢ç´¢',
                    occupiedRegion: 'å·²å é¢†',
                    regionRank: 'åŒºåŸŸç­‰çº§',
                    scoreThisTurn: 'æœ¬å›åˆå¾—åˆ†',
                    totalScore: 'æ€»å¾—åˆ†',
                    extraPoints: 'é¢å¤–ç‚¹æ•°',
                    heartBonus: 'çº¢å¿ƒåŠ æˆ',
                    spadeBonus: 'é»‘æ¡ƒåŠ æˆ',
                    echoBonus: 'å›å£°åŠ æˆ',
                    exportSuccess: 'å¯¼å‡ºæˆåŠŸ'
                },
                'en': {
                    name: 'English',
                    gameTitle: 'Civilization 4X Poker',
                    gameDescription: 'Explore, Expand, Exploit, Exterminate! Build your civilization with poker cards',
                    score: 'Score',
                    turn: 'Turn',
                    remainingCards: 'Cards Left',
                    randomSeed: 'Random Seed',
                    newGame: 'New Game',
                    undo: 'Undo',
                    history: 'History',
                    gameMessages: 'Game Messages',
                    actions: 'Actions',
                    explore: 'Explore',
                    occupy: 'Occupy',
                    endTurn: 'End Turn',
                    gameLog: 'Game Log',
                    yourHand: 'Your Hand',
                    gameOver: 'Game Over',
                    finalScore: 'Final Score',
                    playAgainPrompt: 'Play again to build an even greater civilization!',
                    replaySameSeed: 'Replay Same Game',
                    shareResult: 'Share Result',
                    historyBrowser: 'History Browser',
                    selectThis: 'Select This State',
                    cancel: 'Cancel',
                    move: 'Move',
                    copy: 'Copy',
                    share: 'Share',
                    copied: 'Copied to clipboard',
                    shareText: 'I scored {score} points in Civilization 4X Poker! Random seed:{seed}, challenge me!',
                    selectCard: 'Please select a card from your hand',
                    selectRegion: 'Please select a region',
                    noValidRegion: 'No valid region to select',
                    exploreDone: 'Exploration successful! Gained {points} points',
                    occupyDone: 'Occupation successful! Gain {points} points per turn',
                    turnEnded: 'Turn ended, gained {points} points',
                    cardDrawn: 'Drew a card: {rank}{suit}',
                    gameStart: 'Game started! Initial hand: 5 cards',
                    notEnoughRank: 'Card rank not high enough to explore this region',
                    alreadyOccupied: 'This region is already occupied',
                    notExplored: 'This region is not explored yet',
                    infoSelectCardToExplore: 'Select a card to explore',
                    infoSelectCardToOccupy: 'Select a card to occupy',
                    pathLand: 'Land',
                    pathOcean: 'Ocean',
                    pathDesert: 'Desert',
                    pathSky: 'Sky',
                    standardRegion: 'Standard Region',
                    echoRegion: 'Echo Region',
                    exploredRegion: 'Explored',
                    unexploredRegion: 'Unexplored',
                    occupiedRegion: 'Occupied',
                    regionRank: 'Region Rank',
                    scoreThisTurn: 'Score this turn',
                    totalScore: 'Total score',
                    extraPoints: 'Extra points',
                    heartBonus: 'Heart bonus',
                    spadeBonus: 'Spade bonus',
                    echoBonus: 'Echo bonus',
                    exportSuccess: 'Export successful'
                }
            };
            
            // æ¸¸æˆçŠ¶æ€
            let gameState = {
                deck: [],            // ç‰Œå †
                hand: [],            // æ‰‹ç‰Œ
                discardPile: [],     // å¼ƒç‰Œå †
                score: 0,            // æ€»åˆ†æ•°
                turn: 1,             // å½“å‰å›åˆ
                currentSeed: '',     // å½“å‰ç§å­
                selectedCard: null,  // å½“å‰é€‰æ‹©çš„æ‰‹ç‰Œç´¢å¼•
                selectedAction: '',  // å½“å‰é€‰æ‹©çš„è¡ŒåŠ¨
                regions: {},         // æ¸¸æˆåŒºåŸŸçŠ¶æ€
                gameOver: false      // æ¸¸æˆæ˜¯å¦ç»“æŸ
            };
            
            // å†å²è®°å½•çŠ¶æ€
            let history = [];
            let currentHistoryIndex = -1;
            let currentBrowsingIndex = 0;
            
            // æ¸¸æˆæ—¥å¿—æ•°æ®
            let gameLogData = [];
            
            // å½“å‰è¯­è¨€
            let currentLanguage = 'zh-CN';
            
            // åˆå§‹åŒ–éšæœºæ•°ç”Ÿæˆå™¨
            let seededRandom = null;
            
            // DOMå…ƒç´ 
            const scoreDisplay = document.getElementById('score');
            const turnCounter = document.getElementById('turn-counter');
            const remainingCardsDisplay = document.getElementById('remaining-cards');
            const handContainer = document.getElementById('hand-container');
            const gameMessageElement = document.getElementById('game-message');
            const actionInfoElement = document.getElementById('action-info');
            const seedDisplay = document.getElementById('seed-display');
            const resultModal = document.getElementById('result-modal');
            const finalScoreDisplay = document.getElementById('final-score');
            const toastElement = document.getElementById('toast');
            const gameLogElement = document.getElementById('game-log');
            
            // éšæœºåŠ æƒé€‰æ‹©å‡½æ•°
            function weightedRandomSelect(items, weights) {
                const totalWeight = weights.reduce((sum, weight) => sum + weight, 0);
                let random = seededRandom() * totalWeight;
                
                for (let i = 0; i < items.length; i++) {
                    random -= weights[i];
                    if (random <= 0) {
                        return items[i];
                    }
                }
                
                // å¦‚æœå‡ºç°èˆå…¥è¯¯å·®ï¼Œè¿”å›æœ€åä¸€é¡¹
                return items[items.length - 1];
            }
            
            // åˆ›å»ºå¥‡è§‚
            function createWonder(rank) {
                // ä¸ºå¥‡è§‚é€‰æ‹©ä¸€ä¸ªéšæœºåç§°
                const wonderNameIndex = Math.floor(seededRandom() * WONDER_NAMES.length);
                const wonderName = WONDER_NAMES[wonderNameIndex];
                
                // æ ¹æ®ç­‰çº§ç¡®å®šå¥‡è§‚å¼ºåº¦ï¼Œç­‰çº§è¶Šé«˜å¼ºåº¦è¶Šé«˜çš„æ¦‚ç‡è¶Šå¤§
                let tierWeights;
                if (rank >= 9) {
                    // 9çº§ä»¥ä¸Š: æ©™è‰²>ç´«è‰²>è“è‰²
                    tierWeights = [5, 3, 2]; // æ©™è‰², ç´«è‰², è“è‰²
                } else if (rank >= 6) {
                    // 6-8çº§: ç´«è‰²>è“è‰²>æ©™è‰²
                    tierWeights = [2, 5, 3]; // æ©™è‰², ç´«è‰², è“è‰²
                } else {
                    // å…¶ä»–ç­‰çº§: è“è‰²>ç´«è‰²>æ©™è‰²
                    tierWeights = [1, 3, 6]; // æ©™è‰², ç´«è‰², è“è‰²
                }
                
                const tierKeys = Object.keys(WONDER_TIERS);
                const selectedTierKey = weightedRandomSelect(tierKeys, tierWeights);
                const tier = WONDER_TIERS[selectedTierKey];
                
                // é€‰æ‹©å¥‡è§‚æ•ˆæœ
                const effectWeights = WONDER_EFFECTS.map(effect => effect.weight);
                const selectedEffect = weightedRandomSelect(WONDER_EFFECTS, effectWeights);
                
                // å¦‚æœæ˜¯èŠ±è‰²æ”¶è·æ•ˆæœï¼Œç®€åŒ–åç§°æ˜¾ç¤º
                if (selectedEffect.type.includes('_bonus')) {
                    const suit = selectedEffect.type.split('_')[0];
                    selectedEffect.name = SUIT_SYMBOLS[suit];
                }
                
                // è®¾ç½®ç»Ÿä¸€çš„å é¢†æ¡ä»¶ - å¯ä»¥ä½¿ç”¨Jã€Qã€Kã€Aæˆ–è€…ä»»æ„çº¢å¿ƒ
                const occupyCondition = { 
                    type: 'multiple', 
                    display: 'Jã€Qã€Kã€Aæˆ–çº¢å¿ƒ'
                };
                
                return {
                    name: wonderName,
                    tier: selectedTierKey,
                    effect: selectedEffect,
                    occupyCondition: occupyCondition,
                    revealed: false // æœªæ¢ç´¢å‰ä¸æ˜¾ç¤ºå¥‡è§‚åç§°
                };
            }
            
            // æ£€æŸ¥å¡ç‰‡æ˜¯å¦æ»¡è¶³å¥‡è§‚çš„å é¢†æ¡ä»¶
            function cardMeetsWonderCondition(card, wonderData) {
                const condition = wonderData.occupyCondition;
                
                if (condition.type === 'rank') {
                    return card.rank === condition.rank;
                } else if (condition.type === 'suit') {
                    return card.suit === condition.suit;
                } else if (condition.type === 'multiple') {
                    // æ£€æŸ¥æ˜¯å¦æ˜¯Jã€Qã€Kã€Aæˆ–çº¢å¿ƒ
                    return card.rank === 'J' || 
                           card.rank === 'Q' || 
                           card.rank === 'K' || 
                           card.rank === 'A' || 
                           card.suit === 'heart';
                }
                
                return false;
            }
            
            // åˆå§‹åŒ–æ¸¸æˆåŒºåŸŸ
            function initializeGameRegions() {
                // åˆå§‹åŒ–åŒºåŸŸæ•°æ®ç»“æ„
                gameState.regions = {};
                
                // ä¸ºæ¯æ¡è·¯å¾„åˆå§‹åŒ–åŒºåŸŸ
                for (const pathId of PATHS) {
                    gameState.regions[pathId] = Array(13).fill().map((_, index) => {
                        const rank = index + 1;
                        let type = 'standard';
                        let wonderData = null;
                        
                        // 6-8çº§æœ‰æœºä¼šç”Ÿæˆå¥‡è§‚åŒºåŸŸ
                        if (rank >= 6 && rank <= 8) {
                            // 50%æ¦‚ç‡ä¸ºå›å£°åŒºåŸŸï¼Œ20%æ¦‚ç‡ä¸ºå¥‡è§‚åŒºåŸŸï¼Œ30%æ¦‚ç‡ä¸ºæ™®é€šåŒºåŸŸ
                            const randomVal = seededRandom();
                            if (randomVal < 0.2) {
                                type = 'wonder';
                                wonderData = createWonder(rank);
                            } else if (randomVal < 0.7) {
                                type = 'echo';
                            }
                        }
                        // 9çº§ä»¥ä¸Šæœ‰æ›´é«˜æ¦‚ç‡ç”Ÿæˆå¥‡è§‚
                        else if (rank >= 9) {
                            // 30%æ¦‚ç‡ä¸ºå¥‡è§‚åŒºåŸŸï¼Œ40%æ¦‚ç‡ä¸ºå›å£°åŒºåŸŸï¼Œ30%æ¦‚ç‡ä¸ºæ™®é€šåŒºåŸŸ
                            const randomVal = seededRandom();
                            if (randomVal < 0.3) {
                                type = 'wonder';
                                wonderData = createWonder(rank);
                            } else if (randomVal < 0.7) {
                                type = 'echo';
                            }
                        }
                        // 1-4çº§æŒ‰åŸæ¥é€»è¾‘å¤„ç†
                        else if (rank <= 4) {
                            // 20%æ¦‚ç‡ä¸ºå›å£°åŒºåŸŸ
                            if (seededRandom() < 0.2) {
                                type = 'echo';
                            }
                        }
                        // 5çº§æš‚æ—¶ä¸å¤„ç†ç¾éš¾æˆ–æˆ˜äº‰åŒºåŸŸï¼Œä»ä½¿ç”¨æ™®é€šé€»è¾‘
                        else if (rank === 5) {
                            // 20%æ¦‚ç‡ä¸ºå›å£°åŒºåŸŸ
                            if (seededRandom() < 0.2) {
                                type = 'echo';
                            }
                        }
                        
                        return {
                            pathId,              // è·¯å¾„ID
                            rank,                // åŒºåŸŸç­‰çº§ (1-13)
                            type,                // åŒºåŸŸç±»å‹
                            wonderData,          // å¥‡è§‚æ•°æ®ï¼ˆå¦‚æœæ˜¯å¥‡è§‚ï¼‰
                            status: 'unexplored',// çŠ¶æ€: unexplored, explored, occupied
                            occupyCard: null,    // å é¢†çš„å¡ç‰Œ
                            points: 0            // æ¯å›åˆæä¾›çš„åˆ†æ•°
                        };
                    });
                    
                    // æ¸²æŸ“åŒºåŸŸ
                    const regionContainer = document.getElementById(`${pathId}-regions`);
                    regionContainer.innerHTML = '';
                    
                    // å€’åºæ¸²æŸ“åŒºåŸŸï¼ˆä»13åˆ°1ï¼‰ï¼Œæ˜¾ç¤ºæœ€é«˜ç­‰çº§(13)åœ¨é¡¶éƒ¨
                    for (let i = 12; i >= 0; i--) {
                        const region = gameState.regions[pathId][i];
                        const regionElement = document.createElement('div');
                        
                        // ä½¿ç”¨ä¸æ‰‹ç‰Œä¸€è‡´çš„å°ºå¯¸
                        regionElement.className = 'rounded-md w-16 h-24 md:w-20 md:h-30 border shadow-md flex flex-col items-center justify-center cursor-pointer relative';
                        
                        // æ ¹æ®åŒºåŸŸçŠ¶æ€è°ƒæ•´æ ·å¼
                        if (region.status === 'unexplored') {
                            regionElement.classList.add('bg-gray-400', 'dark:bg-gray-700');
                        } else if (region.status === 'explored') {
                            regionElement.classList.add('bg-white', 'dark:bg-gray-600');
                        } else if (region.status === 'occupied') {
                            regionElement.classList.add('bg-blue-100', 'dark:bg-blue-800');
                        }
                        
                        // å¦‚æœæ˜¯å›å£°åŒºåŸŸï¼Œæ·»åŠ ç‰¹æ®Šæ ·å¼
                        if (region.type === 'echo' && region.status !== 'occupied') {
                            regionElement.classList.add('bg-green-200', 'dark:bg-green-800');
                        }
                        
                        // å¦‚æœæ˜¯å¥‡è§‚åŒºåŸŸï¼Œæ·»åŠ ç‰¹æ®Šæ ·å¼
                        if (region.type === 'wonder' && region.wonderData) {
                            const tierClass = `wonder-${region.wonderData.tier}`;
                            regionElement.classList.add(tierClass);
                        }
                        
                        regionElement.dataset.path = pathId;
                        regionElement.dataset.rank = i + 1;
                        regionElement.dataset.type = region.type;
                        
                        // åŒºåŸŸç­‰çº§æ˜¾ç¤º
                        const rankElement = document.createElement('div');
                        rankElement.className = 'text-sm font-bold absolute top-1 left-1';
                        rankElement.textContent = i + 1; // ç›´æ¥æ˜¾ç¤ºæ•°å­—1-13
                        regionElement.appendChild(rankElement);
                        
                        // çŠ¶æ€æ ‡è¯†
                        const statusIndicator = document.createElement('div');
                        statusIndicator.className = 'absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 text-xs font-bold';
                        
                        if (region.status === 'unexplored') {
                            // æœªæ¢ç´¢çš„å¥‡è§‚æ˜¾ç¤ºä¸º???
                            if (region.type === 'wonder') {
                                statusIndicator.textContent = '???';
                                statusIndicator.className += ' text-white';
                            } else {
                                statusIndicator.textContent = 'æœªæ¢ç´¢';
                                statusIndicator.className += ' text-gray-100 dark:text-gray-300';
                            }
                        } else if (region.status === 'explored') {
                            statusIndicator.textContent = 'å¯å é¢†';
                            statusIndicator.className += ' text-green-600 dark:text-green-400';
                        }
                        
                        // åªæœ‰åœ¨éå é¢†çŠ¶æ€ä¸‹æ‰æ·»åŠ çŠ¶æ€æŒ‡ç¤ºå™¨
                        if (region.status !== 'occupied') {
                            regionElement.appendChild(statusIndicator);
                        }
                        
                        // åŒºåŸŸç±»å‹æŒ‡ç¤ºå™¨ï¼ˆå›å£°åŒºåŸŸï¼‰
                        if (region.type === 'echo' && region.status !== 'occupied') {
                            const typeIndicator = document.createElement('div');
                            typeIndicator.className = 'absolute top-1 right-1 w-2 h-2 rounded-full bg-green-400 dark:bg-green-300';
                            regionElement.appendChild(typeIndicator);
                        }
                        
                        // æ·»åŠ ç‚¹å‡»äº‹ä»¶
                        regionElement.addEventListener('click', () => handleRegionClick(pathId, i));
                        
                        regionContainer.appendChild(regionElement);
                    }
                }
            }
            
            // æ£€æŸ¥åŒºåŸŸæ˜¯å¦å¯ä»¥è¢«æ¢ç´¢ï¼ˆå¿…é¡»ç›¸é‚»äºå·²æ¢ç´¢æˆ–å·²å é¢†åŒºåŸŸï¼‰
            function canExploreRegion(pathId, index) {
                // è·å–åŒä¸€è·¯å¾„ä¸­rankå€¼ä½1çš„åŒºåŸŸ
                const lowerRankIndex = index - 1;
                
                // å¦‚æœæ˜¯æœ€ä½ç­‰çº§(1)ï¼Œæ€»æ˜¯å¯ä»¥æ¢ç´¢
                if (index === 0) return true;
                
                // æ£€æŸ¥ä½ä¸€çº§åŒºåŸŸæ˜¯å¦å·²è¢«æ¢ç´¢æˆ–å é¢†
                if (lowerRankIndex >= 0) {
                    const lowerRegion = gameState.regions[pathId][lowerRankIndex];
                    if (lowerRegion.status === 'explored' || lowerRegion.status === 'occupied') {
                        return true;
                    }
                }
                
                return false;
            }
            
            // åœ¨æ ¼å­ä¸Šæ˜¾ç¤ºä¸´æ—¶é”™è¯¯æç¤º
            function showErrorOnRegion(regionElement, message) {
                // åˆ›å»ºé”™è¯¯æç¤ºå…ƒç´ 
                const errorTooltip = document.createElement('div');
                errorTooltip.className = 'absolute inset-0 bg-red-500 bg-opacity-80 flex items-center justify-center rounded-md z-10';
                errorTooltip.style.animation = 'fadeIn 0.2s ease-out';
                
                const textElement = document.createElement('div');
                textElement.className = 'text-white text-xs font-bold px-1 text-center';
                textElement.textContent = message;
                
                errorTooltip.appendChild(textElement);
                regionElement.appendChild(errorTooltip);
                
                // 2ç§’åè‡ªåŠ¨ç§»é™¤
                setTimeout(() => {
                    errorTooltip.style.animation = 'fadeOut 0.5s ease-out';
                    setTimeout(() => {
                        if (regionElement.contains(errorTooltip)) {
                            regionElement.removeChild(errorTooltip);
                        }
                    }, 500);
                }, 2000);
            }
            
            // å¤„ç†åŒºåŸŸç‚¹å‡»äº‹ä»¶
            function handleRegionClick(pathId, index) {
                // è·å–åŒºåŸŸå…ƒç´ 
                const regionContainer = document.getElementById(`${pathId}-regions`);
                const displayIndex = 12 - index;
                const regionElement = regionContainer.children[displayIndex];
                
                // æ£€æŸ¥æ˜¯å¦é€‰æ‹©äº†æ‰‹ç‰Œ
                if (gameState.selectedCard === null) {
                    showErrorOnRegion(regionElement, t('selectCard'));
                    showMessage(t('selectCard'));
                    return;
                }
                
                const region = gameState.regions[pathId][index];
                const card = gameState.hand[gameState.selectedCard];
                const cardRank = RANK_VALUES[card.rank];
                
                // è‡ªåŠ¨åˆ¤æ–­æ“ä½œç±»å‹
                if (region.status === 'unexplored') {
                    // æ¢ç´¢æ“ä½œ
                    
                    // è®¡ç®—æœ‰æ•ˆç‚¹æ•°ï¼ˆé»‘æ¡ƒç¿»å€ï¼‰
                    let effectiveRank = cardRank;
                    if (card.suit === 'spade') {
                        effectiveRank = cardRank * 2;
                    }
                    
                    // æ£€æŸ¥å¡ç‰Œç‚¹æ•°æ˜¯å¦è¶³å¤Ÿ
                    if (effectiveRank < region.rank) {
                        showErrorOnRegion(regionElement, t('notEnoughRank'));
                        showMessage(t('notEnoughRank'));
                        return;
                    }
                    
                    // æ£€æŸ¥æ˜¯å¦å¯ä»¥æ¢ç´¢è¯¥åŒºåŸŸï¼ˆå¿…é¡»ç›¸é‚»äºå·²æ¢ç´¢åŒºåŸŸï¼‰
                    if (!canExploreRegion(pathId, index)) {
                        showErrorOnRegion(regionElement, 'åªèƒ½æ¢ç´¢ç›¸é‚»æ ¼å­');
                        showMessage('åªèƒ½æ¢ç´¢å·²æ¢ç´¢åŒºåŸŸç›¸é‚»çš„æ ¼å­');
                        return;
                    }
                    
                    // æ‰§è¡Œæ¢ç´¢è¡ŒåŠ¨
                    exploreRegion(pathId, index, gameState.selectedCard);
                } 
                else if (region.status === 'explored') {
                    // å é¢†æ“ä½œ
                    occupyRegion(pathId, index, gameState.selectedCard);
                }
                else if (region.status === 'occupied') {
                    // å·²è¢«å é¢†
                    showErrorOnRegion(regionElement, t('alreadyOccupied'));
                    showMessage(t('alreadyOccupied'));
                }
            }
            
            // æ¢ç´¢åŒºåŸŸ
            function exploreRegion(pathId, index, cardIndex) {
                // è·å–é€‰æ‹©çš„å¡ç‰Œå’ŒåŒºåŸŸ
                const card = gameState.hand[cardIndex];
                const region = gameState.regions[pathId][index];
                const cardRank = RANK_VALUES[card.rank];
                
                // è®¡ç®—æ¢ç´¢å¾—åˆ†
                let points = REGION_TYPES[region.type].explorePoints;
                let bonusInfo = '';
                
                // é»‘æ¡ƒæ¢ç´¢æ•ˆæœï¼šrankå€¼ç¿»å€
                // é»‘æ¡ƒçš„å¡ç‰Œåœ¨æ¢ç´¢æ—¶ï¼Œç›¸å½“äºç‚¹æ•°ç¿»å€
                let effectiveRank = cardRank;
                if (card.suit === 'spade') {
                    effectiveRank = cardRank * 2;
                    bonusInfo = `(${t('spadeBonus')}: rank ${cardRank}â†’${effectiveRank})`;
                }
                
                // å¦‚æœæœ‰æ•ˆrankå€¼å°äºåŒºåŸŸç­‰çº§ï¼Œæ— æ³•æ¢ç´¢
                if (effectiveRank < region.rank) {
                    showMessage(t('notEnoughRank'));
                    return;
                }
                
                // æ›´æ–°åˆ†æ•°
                gameState.score += points;
                scoreDisplay.textContent = gameState.score;
                
                // æ›´æ–°åŒºåŸŸçŠ¶æ€
                region.status = 'explored';
                
                // æ›´æ–°åŒºåŸŸæ˜¾ç¤º
                updateRegionDisplay(pathId, index);
                
                // ä»æ‰‹ç‰Œä¸­ç§»é™¤å¡ç‰Œï¼ŒåŠ å…¥å¼ƒç‰Œå †
                gameState.discardPile.push(card);
                gameState.hand.splice(cardIndex, 1);
                
                // æ›´æ–°å¼ƒç‰Œå †è®¡æ•°
                updateDiscardCount();
                
                // é‡æ–°æ¸²æŸ“æ‰‹ç‰Œ
                renderHand();
                
                // è®°å½•æ“ä½œ
                addLogEntry(`${t('explore')}: ${PATH_NAMES[pathId]} ${region.rank} (${card.rank}${SUIT_SYMBOLS[card.suit]}) +${points}åˆ† ${bonusInfo}`);
                
                // æ˜¾ç¤ºæ¶ˆæ¯
                showMessage(t('exploreDone', {points: points}));
                
                // é‡ç½®é€‰æ‹©çŠ¶æ€
                resetSelectionState();
                
                // ä¿å­˜æ¸¸æˆçŠ¶æ€åˆ°å†å²è®°å½•
                addToHistory(saveGameState());
            }
            
            // å¤„ç†å¥‡è§‚å é¢†æ•ˆæœ
            function processWonderEffects(region, pathId) {
                const wonderTier = region.wonderData.tier;
                const effect = region.wonderData.effect;
                const tierData = WONDER_TIERS[wonderTier];
                const multiplier = tierData.effectMultiplier;
                
                let points = 0;
                let effectDescription = '';
                let immediatePoints = tierData.baseScore;
                
                // å¤„ç†ä¸åŒçš„å¥‡è§‚æ•ˆæœç±»å‹
                switch(effect.type) {
                    case 'draw':
                        // æŠ½å¡æ•ˆæœï¼šæ¯å›åˆé¢å¤–æŠ½ç‰Œ
                        // è¿™ä¸ªæ•ˆæœä¼šåœ¨endTurnä¸­å¤„ç†
                        region.wonderEffect = {
                            type: 'draw',
                            value: multiplier
                        };
                        effectDescription = `æ¯å›åˆå¤šæŠ½${multiplier}å¼ `;
                        points = 0; // è¿™ä¸ªæ•ˆæœä¸æä¾›ç›´æ¥åˆ†æ•°
                        break;
                        
                    case 'score':
                        // å¾—åˆ†æ•ˆæœï¼šæ¯å›åˆé¢å¤–å¾—åˆ†
                        points = 10 * multiplier; // æ©™è‰²+30/t, ç´«è‰²+20/t, è“è‰²+10/t
                        effectDescription = `æ¯å›åˆ+${points}åˆ†`;
                        break;
                        
                    case 'explore':
                        // æ¢ç´¢æ•ˆæœï¼šç«‹å³æ¢ç´¢è¯¥è·¯å¾„ä¸Šçš„é¢å¤–æ ¼å­
                        const extraExplores = multiplier;
                        
                        // æ‰¾åˆ°å½“å‰å·²æ¢ç´¢çš„æœ€é«˜ç­‰çº§åŒºåŸŸ
                        let highestExploredRank = 0;
                        for (const r of gameState.regions[pathId]) {
                            if (r.status !== 'unexplored' && r.rank > highestExploredRank) {
                                highestExploredRank = r.rank;
                            }
                        }
                        
                        // æ¢ç´¢é¢å¤–çš„æ ¼å­
                        let exploredCount = 0;
                        for (let i = 0; i < gameState.regions[pathId].length && exploredCount < extraExplores; i++) {
                            const r = gameState.regions[pathId][i];
                            if (r.rank > highestExploredRank && r.status === 'unexplored') {
                                r.status = 'explored';
                                updateRegionDisplay(pathId, i);
                                exploredCount++;
                            }
                        }
                        
                        effectDescription = `é¢å¤–æ¢ç´¢äº†${exploredCount}æ ¼`;
                        break;
                        
                    case 'heart_bonus':
                    case 'spade_bonus':
                    case 'diamond_bonus':
                    case 'club_bonus':
                        // èŠ±è‰²æ”¶è·æ•ˆæœï¼šè¯¥è·¯å¾„ä¸Šçš„å¯¹åº”èŠ±è‰²æ¯å›åˆæŒ‰3Ã—nÂ²è®¡åˆ†
                        const suit = effect.type.split('_')[0]; // 'heart', 'spade', 'diamond', 'club'
                        
                        region.wonderEffect = {
                            type: 'suit_bonus',
                            suit: suit,
                            pathId: pathId,
                            formula: 'squared' // ä½¿ç”¨3Ã—nÂ²å…¬å¼
                        };
                        
                        // è®¡ç®—å½“å‰è·¯å¾„ä¸Šå·²æœ‰çš„è¯¥èŠ±è‰²ç‰Œæ•°
                        let suitCount = 0;
                        for (const r of gameState.regions[pathId]) {
                            if (r.status === 'occupied' && r.occupyCard && r.occupyCard.suit === suit) {
                                suitCount++;
                            }
                        }
                        
                        // ä½¿ç”¨æ–°å…¬å¼ï¼š3 Ã— (èŠ±è‰²æ•°é‡)Â²
                        points = 3 * (suitCount * suitCount);
                        effectDescription = `${PATH_NAMES[pathId]}è·¯å¾„ä¸Š${SUIT_SYMBOLS[suit]}ï¼š3Ã—æ•°é‡Â²åˆ†/å›åˆ`;
                        break;
                }
                
                // ç«‹å³å¢åŠ åˆ†æ•°
                gameState.score += immediatePoints;
                scoreDisplay.textContent = gameState.score;
                
                return {
                    points,
                    effectDescription,
                    immediatePoints
                };
            }
            
            // å é¢†åŒºåŸŸ
            function occupyRegion(pathId, index, cardIndex) {
                // è·å–é€‰æ‹©çš„å¡ç‰Œå’ŒåŒºåŸŸ
                const card = gameState.hand[cardIndex];
                const region = gameState.regions[pathId][index];
                const cardRank = RANK_VALUES[card.rank];
                
                // æ£€æŸ¥æ˜¯å¦æ˜¯å¥‡è§‚åŒºåŸŸï¼Œéœ€è¦ç‰¹æ®Šå¤„ç†
                if (region.type === 'wonder' && region.wonderData) {
                    // æ£€æŸ¥å¡ç‰Œæ˜¯å¦æ»¡è¶³å¥‡è§‚å é¢†æ¡ä»¶
                    if (!cardMeetsWonderCondition(card, region.wonderData)) {
                        const condition = region.wonderData.occupyCondition;
                        let errorMsg = '';
                        
                        if (condition.type === 'rank') {
                            errorMsg = `éœ€è¦ä½¿ç”¨${condition.display}å é¢†æ­¤å¥‡è§‚`;
                        } else if (condition.type === 'suit') {
                            errorMsg = `éœ€è¦ä½¿ç”¨${condition.display}å é¢†æ­¤å¥‡è§‚`;
                        }
                        
                        // æ˜¾ç¤ºé”™è¯¯æ¶ˆæ¯
                        const regionContainer = document.getElementById(`${pathId}-regions`);
                        const displayIndex = 12 - index;
                        const regionElement = regionContainer.children[displayIndex];
                        showErrorOnRegion(regionElement, errorMsg);
                        showMessage(errorMsg);
                        return;
                    }
                    
                    // å¤„ç†å¥‡è§‚æ•ˆæœ
                    const wonderEffectResult = processWonderEffects(region, pathId);
                    
                    // æ›´æ–°åŒºåŸŸçŠ¶æ€
                    region.status = 'occupied';
                    region.occupyCard = card;
                    region.points = wonderEffectResult.points; // æ¯å›åˆå¾—åˆ†
                    
                    // æ›´æ–°åŒºåŸŸæ˜¾ç¤º
                    updateRegionDisplay(pathId, index);
                    
                    // æ›´æ–°æ‰€æœ‰èŠ±è‰²æ”¶è·å¥‡è§‚çš„å¾—åˆ†
                    updateAllSuitBonusWonders(pathId, card.suit);
                    
                    // ä»æ‰‹ç‰Œä¸­ç§»é™¤å¡ç‰Œ
                    gameState.hand.splice(cardIndex, 1);
                    
                    // é‡æ–°æ¸²æŸ“æ‰‹ç‰Œ
                    renderHand();
                    
                    // è®°å½•æ“ä½œå’Œå¥‡è§‚æ•ˆæœ
                    const wonderTierName = WONDER_TIERS[region.wonderData.tier].name;
                    addLogEntry(`${t('occupy')}: ${PATH_NAMES[pathId]} ${region.rank} å¥‡è§‚ã€Œ${region.wonderData.name}ã€(${card.rank}${SUIT_SYMBOLS[card.suit]}) å³æ—¶+${wonderEffectResult.immediatePoints}åˆ† ${wonderEffectResult.points > 0 ? '+' + wonderEffectResult.points + 'åˆ†/å›åˆ' : ''} æ•ˆæœ: ${wonderEffectResult.effectDescription}`);
                    
                    // æ˜¾ç¤ºæ¶ˆæ¯
                    showMessage(`å é¢†å¥‡è§‚æˆåŠŸï¼è·å¾—${wonderEffectResult.immediatePoints}åˆ†ï¼Œ${wonderEffectResult.effectDescription}`);
                    
                    // é‡ç½®é€‰æ‹©çŠ¶æ€
                    resetSelectionState();
                    
                    // ä¿å­˜æ¸¸æˆçŠ¶æ€åˆ°å†å²è®°å½•
                    addToHistory(saveGameState());
                    return;
                }
                
                // éå¥‡è§‚åŒºåŸŸçš„å¸¸è§„å é¢†é€»è¾‘
                let points = 0;
                let bonusInfo = '';
                
                if (region.type === 'standard') {
                    // æ™®é€šåŒºåŸŸå›ºå®šå¾—åˆ† - é»˜è®¤1åˆ†/å›åˆ
                    points = REGION_TYPES.standard.occupyPoints;
                    
                    // çº¢æ¡ƒæ•ˆæœï¼šå¾—åˆ†ç¿»å€ï¼ˆå›ºå®šå€¼å˜ä¸º2åˆ†/å›åˆï¼‰
                    if (card.suit === 'heart') {
                        points = 2; // çº¢æ¡ƒç›´æ¥ç»™2åˆ†ï¼Œè€Œä¸æ˜¯1åˆ†
                        bonusInfo = `(${t('heartBonus')}: 1â†’2)`;
                    }
                } else if (region.type === 'echo') {
                    // å›å£°åŒºåŸŸæ­£å¸¸å¾—åˆ† = ç‰Œç‚¹æ•° Ã— 2
                    points = cardRank * 2;
                    
                    // çº¢æ¡ƒæ•ˆæœï¼šå›å£°åŒºåŸŸå¾—åˆ†å˜ä¸º ç‰Œç‚¹æ•°Ã—2 + 2
                    if (card.suit === 'heart') {
                        // æ˜¾ç¤ºåŸå§‹å¾—åˆ†å’ŒåŠ æˆåçš„å¾—åˆ†ï¼Œä»¥ä¾¿æ›´æ¸…æ™°
                        let originalPoints = points;
                        points += 2; // é¢å¤–+2åˆ†
                        bonusInfo = `(${t('heartBonus')}: ${originalPoints}â†’${points})`;
                    }
                    
                    // æ·»åŠ å›å£°åŒºåŸŸæ ‡è¯†
                    if (!bonusInfo) {
                        bonusInfo = t('echoBonus');
                    } else {
                        bonusInfo += ` ${t('echoBonus')}`;
                    }
                }
                
                // æ›´æ–°åŒºåŸŸçŠ¶æ€
                region.status = 'occupied';
                region.occupyCard = card;
                region.points = points;
                
                // æ›´æ–°åŒºåŸŸæ˜¾ç¤º
                updateRegionDisplay(pathId, index);
                
                // æ›´æ–°æ‰€æœ‰èŠ±è‰²æ”¶è·å¥‡è§‚çš„å¾—åˆ†æ˜¾ç¤º
                updateAllSuitBonusWonders();
                
                // ä»æ‰‹ç‰Œä¸­ç§»é™¤å¡ç‰Œ
                gameState.hand.splice(cardIndex, 1);
                
                // é‡æ–°æ¸²æŸ“æ‰‹ç‰Œ
                renderHand();
                
                // è®°å½•æ“ä½œ
                addLogEntry(`${t('occupy')}: ${PATH_NAMES[pathId]} ${region.rank} (${card.rank}${SUIT_SYMBOLS[card.suit]}) +${points}åˆ†/å›åˆ ${bonusInfo}`);
                
                // æ˜¾ç¤ºæ¶ˆæ¯
                showMessage(t('occupyDone', {points: points}));
                
                // é‡ç½®é€‰æ‹©çŠ¶æ€
                resetSelectionState();
                
                // ä¿å­˜æ¸¸æˆçŠ¶æ€åˆ°å†å²è®°å½•
                addToHistory(saveGameState());
            }
            
            // æ›´æ–°åŒºåŸŸæ˜¾ç¤º
            function updateRegionDisplay(pathId, index) {
                const region = gameState.regions[pathId][index];
                const regionContainer = document.getElementById(`${pathId}-regions`);
                
                // æ³¨æ„ï¼šæˆ‘ä»¬å€’åºæ¸²æŸ“äº†åŒºåŸŸï¼Œæ‰€ä»¥ç´¢å¼•éœ€è¦è°ƒæ•´
                // åœ¨å€’åºæ¸²æŸ“ä¸­ï¼Œç´¢å¼•12(13)åœ¨å®¹å™¨çš„ç¬¬0ä¸ªä½ç½®ï¼Œç´¢å¼•0(1)åœ¨å®¹å™¨çš„ç¬¬12ä¸ªä½ç½®
                const displayIndex = 12 - index;
                const regionElement = regionContainer.children[displayIndex];
                
                // æ¸…ç©ºç°æœ‰å†…å®¹
                regionElement.innerHTML = '';
                
                // æ›´æ–°æ ·å¼ - ä½¿ç”¨ä¸æ‰‹ç‰Œå¤§å°ä¸€è‡´çš„å°ºå¯¸
                regionElement.className = 'rounded-md w-16 h-24 md:w-20 md:h-30 border shadow-md flex flex-col items-center justify-center cursor-pointer relative';
                
                // æ ¹æ®åŒºåŸŸçŠ¶æ€å’Œç±»å‹è®¾ç½®æ ·å¼
                if (region.status === 'unexplored') {
                    regionElement.classList.add('bg-gray-400', 'dark:bg-gray-700');
                } else if (region.status === 'explored') {
                    regionElement.classList.add('bg-white', 'dark:bg-gray-600');
                } else if (region.status === 'occupied') {
                    regionElement.classList.add('bg-blue-100', 'dark:bg-blue-800');
                }
                
                // å¦‚æœæ˜¯å›å£°åŒºåŸŸï¼Œæ·»åŠ ç‰¹æ®Šæ ·å¼
                if (region.type === 'echo' && region.status !== 'occupied') {
                    regionElement.classList.add('bg-green-200', 'dark:bg-green-800');
                }
                
                // å¦‚æœæ˜¯å¥‡è§‚åŒºåŸŸï¼Œæ·»åŠ ç‰¹æ®Šæ ·å¼
                if (region.type === 'wonder' && region.wonderData) {
                    // æ ¹æ®å¥‡è§‚çº§åˆ«æ·»åŠ ç›¸åº”çš„æ ·å¼ç±»
                    const tierClass = `wonder-${region.wonderData.tier}`;
                    regionElement.classList.add(tierClass);
                }
                
                // åŒºåŸŸç­‰çº§æ˜¾ç¤ºï¼ˆé¡¶éƒ¨ï¼‰
                const rankElement = document.createElement('div');
                rankElement.className = 'text-sm font-bold absolute top-1 left-1';
                rankElement.textContent = index + 1; // æ˜¾ç¤ºæ•°å­—1-13
                regionElement.appendChild(rankElement);
                
                // æ ¹æ®åŒºåŸŸç±»å‹å’ŒçŠ¶æ€æ·»åŠ ä¸åŒçš„å†…å®¹
                if (region.type === 'wonder') {
                    // å¥‡è§‚åŒºåŸŸç‰¹æ®Šæ˜¾ç¤º
                    if (region.status === 'unexplored') {
                        // æœªæ¢ç´¢çš„å¥‡è§‚æ˜¾ç¤ºä¸º???ï¼Œä½†æ˜¾ç¤ºé¢œè‰²çº§åˆ«
                        const unknownElement = document.createElement('div');
                        unknownElement.className = 'text-lg font-bold text-white text-center';
                        unknownElement.textContent = '???';
                        regionElement.appendChild(unknownElement);
                    } 
                    else if (region.status === 'explored') {
                        // å·²æ¢ç´¢å¥‡è§‚æ˜¾ç¤ºåç§°å’Œæ¡ä»¶
                        const nameElement = document.createElement('div');
                        nameElement.className = 'text-xs font-bold text-center px-1 mb-1';
                        nameElement.textContent = region.wonderData.name;
                        regionElement.appendChild(nameElement);
                        
                        // æ˜¾ç¤ºå é¢†æ¡ä»¶
                        const conditionElement = document.createElement('div');
                        conditionElement.className = 'text-xs text-center';
                        conditionElement.textContent = 'éœ€è¦: Jã€Qã€Kã€Aæˆ–çº¢å¿ƒ';
                        regionElement.appendChild(conditionElement);
                        
                        // æ˜¾ç¤ºå¥‡è§‚æ•ˆæœ
                        const effectElement = document.createElement('div');
                        effectElement.className = 'text-xs text-center mt-1 px-1';
                        const effectText = region.wonderData.effect.name;
                        effectElement.textContent = `[${effectText}]`;
                        regionElement.appendChild(effectElement);
                    }
                    else if (region.status === 'occupied') {
                        // å·²å é¢†å¥‡è§‚æ˜¾ç¤ºåç§°å’Œæ•ˆæœ
                        const nameElement = document.createElement('div');
                        nameElement.className = 'text-xs font-bold text-center px-1 mb-1';
                        nameElement.textContent = region.wonderData.name;
                        regionElement.appendChild(nameElement);
                        
                        // å¡ç‰Œå±•ç¤º
                        if (region.occupyCard) {
                            const card = region.occupyCard;
                            const cardElement = document.createElement('div');
                            cardElement.className = 'flex items-center justify-center';
                            
                            const cardRank = document.createElement('div');
                            cardRank.className = 'text-sm font-bold';
                            cardRank.textContent = card.rank;
                            
                            const cardSuit = document.createElement('div');
                            cardSuit.className = `${card.suit} text-lg`;
                            cardSuit.textContent = SUIT_SYMBOLS[card.suit];
                            
                            cardElement.appendChild(cardRank);
                            cardElement.appendChild(cardSuit);
                            regionElement.appendChild(cardElement);
                        }
                        
                        // å¥‡è§‚æ•ˆæœ
                        const effectElement = document.createElement('div');
                        effectElement.className = 'text-xs text-center mt-1 px-1';
                        const effectText = region.wonderData.effect.name;
                        effectElement.textContent = `[${effectText}]`;
                        regionElement.appendChild(effectElement);
                        
                        // å¾—åˆ†æ˜¾ç¤º
                        if (region.points > 0) {
                            const pointsElement = document.createElement('div');
                            pointsElement.className = 'absolute bottom-1 right-1 text-xs font-bold bg-blue-200 dark:bg-blue-600 px-1 rounded';
                            pointsElement.textContent = `+${region.points}`;
                            regionElement.appendChild(pointsElement);
                        }
                    }
                } 
                else {
                    // éå¥‡è§‚åŒºåŸŸçš„å¸¸è§„æ˜¾ç¤º
                    // çŠ¶æ€æ ‡è¯† - åªæœ‰åœ¨éå é¢†çŠ¶æ€æ—¶æ‰æ·»åŠ 
                    if (region.status !== 'occupied') {
                        const statusIndicator = document.createElement('div');
                        statusIndicator.className = 'absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 text-xs font-bold';
                        
                        if (region.status === 'unexplored') {
                            statusIndicator.textContent = 'æœªæ¢ç´¢';
                            statusIndicator.className += ' text-gray-100 dark:text-gray-300';
                        } else if (region.status === 'explored') {
                            statusIndicator.textContent = 'å¯å é¢†';
                            statusIndicator.className += ' text-green-600 dark:text-green-400';
                        }
                        
                        regionElement.appendChild(statusIndicator);
                    }
                    
                    // å¦‚æœæ˜¯å›å£°åŒºåŸŸï¼Œæ·»åŠ æ ‡è¯†
                    if (region.type === 'echo' && region.status !== 'occupied') {
                        const typeIndicator = document.createElement('div');
                        typeIndicator.className = 'absolute top-1 right-1 w-2 h-2 rounded-full bg-green-400 dark:bg-green-300';
                        regionElement.appendChild(typeIndicator);
                    }
                    
                    // å¦‚æœæ˜¯å é¢†çŠ¶æ€ï¼Œæ˜¾ç¤ºå¡ç‰Œå’Œå¾—åˆ†
                    if (region.status === 'occupied' && region.occupyCard) {
                        const card = region.occupyCard;
                        
                        // å¡ç‰Œä¿¡æ¯ï¼ˆä¸­é—´ï¼‰
                        const cardInfo = document.createElement('div');
                        cardInfo.className = 'flex flex-col items-center justify-center';
                        
                        // å¡ç‰Œä¸­å¿ƒæ˜¾ç¤º
                        const cardRank = document.createElement('div');
                        cardRank.className = 'text-lg font-bold';
                        cardRank.textContent = card.rank;
                        
                        const cardSuit = document.createElement('div');
                        cardSuit.className = `${card.suit} text-2xl`;
                        cardSuit.textContent = SUIT_SYMBOLS[card.suit];
                        
                        cardInfo.appendChild(cardRank);
                        cardInfo.appendChild(cardSuit);
                        regionElement.appendChild(cardInfo);
                        
                        // å¾—åˆ†æ˜¾ç¤ºï¼ˆåº•éƒ¨ï¼‰
                        const pointsElement = document.createElement('div');
                        pointsElement.className = 'absolute bottom-1 right-1 text-xs font-bold bg-blue-200 dark:bg-blue-600 px-1 rounded';
                        pointsElement.textContent = `+${region.points}`;
                        regionElement.appendChild(pointsElement);
                    }
                }
            }
            
            // å¼ƒç‰Œ
            function discardCard() {
                if (gameState.selectedCard === null) {
                    showMessage('è¯·å…ˆé€‰æ‹©è¦å¼ƒæ‰çš„æ‰‹ç‰Œ');
                    return;
                }
                
                // è·å–é€‰ä¸­çš„å¡ç‰Œ
                const card = gameState.hand[gameState.selectedCard];
                
                // åŠ å…¥å¼ƒç‰Œå †
                gameState.discardPile.push(card);
                
                // ä»æ‰‹ç‰Œä¸­ç§»é™¤
                gameState.hand.splice(gameState.selectedCard, 1);
                
                // æ›´æ–°å¼ƒç‰Œå †è®¡æ•°
                updateDiscardCount();
                
                // è®°å½•æ“ä½œ
                addLogEntry(`å¼ƒç‰Œ: ${card.rank}${SUIT_SYMBOLS[card.suit]}`);
                
                // é‡ç½®é€‰æ‹©çŠ¶æ€
                resetSelectionState();
                
                // é‡æ–°æ¸²æŸ“æ‰‹ç‰Œ
                renderHand();
                
                // æ˜¾ç¤ºæ¶ˆæ¯
                showMessage(`å·²å¼ƒæ‰ ${card.rank}${SUIT_SYMBOLS[card.suit]}`);
                
                // ä¿å­˜æ¸¸æˆçŠ¶æ€åˆ°å†å²è®°å½•
                addToHistory(saveGameState());
            }
            
            // æ˜¾ç¤ºå¼ƒç‰Œæç¤º
            function showDiscardPrompt() {
                // åˆ›å»ºå¼¹çª—æç¤º
                const promptOverlay = document.createElement('div');
                promptOverlay.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
                
                const promptBox = document.createElement('div');
                promptBox.className = 'bg-white dark:bg-gray-800 p-5 rounded-lg shadow-lg max-w-md w-full mx-4 text-center';
                
                const title = document.createElement('h3');
                title.className = 'text-xl font-bold mb-3';
                title.textContent = 'æ‰‹ç‰Œå·²è¾¾ä¸Šé™';
                
                const message = document.createElement('p');
                message.className = 'mb-4';
                message.textContent = 'æ‚¨çš„æ‰‹ç‰Œå·²è¾¾åˆ°ä¸Šé™(10å¼ )ã€‚è¯·å…ˆå¼ƒæ‰ä¸€äº›æ‰‹ç‰Œï¼Œç„¶åå†ç»“æŸå›åˆã€‚';
                
                const button = document.createElement('button');
                button.className = 'bg-primary hover:bg-indigo-700 text-white px-4 py-2 rounded-lg';
                button.textContent = 'ç¡®å®š';
                button.addEventListener('click', () => {
                    document.body.removeChild(promptOverlay);
                });
                
                promptBox.appendChild(title);
                promptBox.appendChild(message);
                promptBox.appendChild(button);
                promptOverlay.appendChild(promptBox);
                
                document.body.appendChild(promptOverlay);
            }
            
            // ç»“æŸå›åˆ
            function endTurn() {
                // å¦‚æœæ‰‹ç‰Œå·²æ»¡ä¸”ç‰Œåº“è¿˜æœ‰ç‰Œï¼Œæç¤ºç©å®¶å…ˆå¼ƒç‰Œ
                const MAX_HAND_SIZE = 10;
                if (gameState.hand.length >= MAX_HAND_SIZE && gameState.deck.length > 0) {
                    showDiscardPrompt();
                    return;
                }
                
                // è®¡ç®—å›åˆå¾—åˆ†å’Œå¥‡è§‚æ•ˆæœ
                let turnPoints = 0;
                let extraDraws = 0;  // è®°å½•å¥‡è§‚æä¾›çš„é¢å¤–æŠ½ç‰Œæ¬¡æ•°
                let wonderEffects = []; // è®°å½•æ¿€æ´»çš„å¥‡è§‚æ•ˆæœ
                
                // éå†æ‰€æœ‰åŒºåŸŸï¼Œç»“ç®—å é¢†åŒºåŸŸçš„åˆ†æ•°å’Œå¥‡è§‚æ•ˆæœ
                for (const pathId of PATHS) {
                    for (const region of gameState.regions[pathId]) {
                        // ç»“ç®—åŸºç¡€å¾—åˆ†
                        if (region.status === 'occupied' && region.points > 0) {
                            turnPoints += region.points;
                        }
                        
                        // å¤„ç†å¥‡è§‚ç‰¹æ®Šæ•ˆæœ
                        if (region.status === 'occupied' && region.type === 'wonder' && region.wonderData && region.wonderEffect) {
                            const effect = region.wonderEffect;
                            
                            // å¤„ç†æŠ½å¡æ•ˆæœ
                            if (effect.type === 'draw') {
                                extraDraws += effect.value;
                                wonderEffects.push(`ã€Œ${region.wonderData.name}ã€: å¤šæŠ½${effect.value}å¼ `);
                            }
                            
                            // å¤„ç†èŠ±è‰²åŠ æˆæ•ˆæœ
                            if (effect.type === 'suit_bonus') {
                                // é‡æ–°è®¡ç®—èŠ±è‰²æ•°é‡å’Œå¾—åˆ†
                                if (effect.formula === 'squared') {
                                    // è®¡ç®—è¯¥è·¯å¾„ä¸ŠåŒ¹é…èŠ±è‰²çš„æ•°é‡
                                    let suitCount = 0;
                                    for (const r of gameState.regions[effect.pathId]) {
                                        if (r.status === 'occupied' && r.occupyCard && r.occupyCard.suit === effect.suit) {
                                            suitCount++;
                                        }
                                    }
                                    
                                    // ä½¿ç”¨3Ã—nÂ²å…¬å¼è®¡ç®—å¾—åˆ†
                                    const newPoints = 3 * (suitCount * suitCount);
                                    
                                    // æ›´æ–°åŒºåŸŸå¾—åˆ†
                                    region.points = newPoints;
                                    
                                    // è®°å½•æ•ˆæœæè¿°
                                    wonderEffects.push(`ã€Œ${region.wonderData.name}ã€: ${PATH_NAMES[effect.pathId]}è·¯å¾„ä¸Š${SUIT_SYMBOLS[effect.suit]}(${suitCount}ä¸ª): ${newPoints}åˆ†/å›åˆ`);
                                } else {
                                    wonderEffects.push(`ã€Œ${region.wonderData.name}ã€: ${PATH_NAMES[effect.pathId]}è·¯å¾„ä¸Šçš„${SUIT_SYMBOLS[effect.suit]}æ”¶è·æ•ˆæœ`);
                                }
                            }
                        }
                    }
                }
                
                // æ›´æ–°æ€»åˆ†
                gameState.score += turnPoints;
                scoreDisplay.textContent = gameState.score;
                
                // å¢åŠ å›åˆæ•°
                gameState.turn++;
                turnCounter.textContent = gameState.turn;
                
                // è®°å½•æ“ä½œå’Œå¥‡è§‚æ•ˆæœ
                let logMessage = `${t('endTurn')}: +${turnPoints}åˆ†`;
                if (wonderEffects.length > 0) {
                    logMessage += ` (å¥‡è§‚æ•ˆæœ: ${wonderEffects.join(", ")})`;
                }
                addLogEntry(logMessage);
                
                // æŠ½ç‰Œå¤„ç† - å…ˆæŠ½åŸºç¡€ç‰Œï¼Œç„¶åæŠ½å¥‡è§‚æä¾›çš„é¢å¤–ç‰Œ
                let cardsDrawn = [];
                
                // åŸºç¡€æŠ½ç‰Œ - æ¯å›åˆæŠ½1å¼ 
                if (gameState.deck.length > 0) {
                    const card = drawCard();
                    gameState.hand.push(card);
                    cardsDrawn.push(`${card.rank}${SUIT_SYMBOLS[card.suit]}`);
                }
                
                // å¥‡è§‚é¢å¤–æŠ½ç‰Œ
                for (let i = 0; i < extraDraws && gameState.deck.length > 0; i++) {
                    const card = drawCard();
                    gameState.hand.push(card);
                    cardsDrawn.push(`${card.rank}${SUIT_SYMBOLS[card.suit]}`);
                }
                
                // è®°å½•æŠ½ç‰Œ
                if (cardsDrawn.length > 0) {
                    const drawMessage = cardsDrawn.length === 1
                        ? `æŠ½äº†ä¸€å¼ ç‰Œ: ${cardsDrawn[0]}`
                        : `æŠ½äº†${cardsDrawn.length}å¼ ç‰Œ: ${cardsDrawn.join(", ")}`;
                    addLogEntry(drawMessage);
                }
                
                // ç‰Œåº“ç©ºäº†çš„å¤„ç†
                if (gameState.deck.length === 0) {
                    // æ£€æŸ¥æ˜¯å¦è¿˜æœ‰æ‰‹ç‰Œ
                    if (gameState.hand.length === 0) {
                        // æ²¡æœ‰æ‰‹ç‰Œä¹Ÿæ²¡æœ‰ç‰Œåº“ï¼Œæ¸¸æˆç»“æŸ
                        gameState.gameOver = true;
                        finalScoreDisplay.textContent = gameState.score;
                        resultModal.classList.remove('hidden');
                        
                        // è®°å½•æ¸¸æˆç»“æŸ
                        addLogEntry(`æ¸¸æˆç»“æŸ! æœ€ç»ˆå¾—åˆ†: ${gameState.score}`);
                    } else {
                        // æç¤ºç©å®¶ç‰Œåº“å·²ç©º
                        showMessage('ç‰Œåº“å·²ç©ºï¼Œè¯·ç»§ç»­ä½¿ç”¨æ‰‹ç‰Œ');
                        addLogEntry(`ç‰Œåº“å·²ç©ºï¼Œç»§ç»­ä½¿ç”¨æ‰‹ç‰Œ`);
                    }
                }
                
                // é‡æ–°æ¸²æŸ“æ‰‹ç‰Œ
                renderHand();
                
                // æ˜¾ç¤ºæ¶ˆæ¯
                let turnMessage = t('turnEnded', {points: turnPoints});
                if (extraDraws > 0) {
                    turnMessage += ` é¢å¤–æŠ½äº†${extraDraws}å¼ ç‰Œ`;
                }
                showMessage(turnMessage);
                
                // æ£€æŸ¥æ¸¸æˆæ˜¯å¦ç»“æŸ
                checkGameOver();
                
                // ä¿å­˜æ¸¸æˆçŠ¶æ€åˆ°å†å²è®°å½•
                addToHistory(saveGameState());
            }
            
            // æ£€æŸ¥æ¸¸æˆæ˜¯å¦ç»“æŸ
            function checkGameOver() {
                // å¦‚æœæ²¡æœ‰ç‰Œå¯æŠ½å¹¶ä¸”æ‰‹ç‰Œä¸ºç©ºï¼Œæ¸¸æˆç»“æŸ
                if (gameState.deck.length === 0 && gameState.hand.length === 0) {
                    gameState.gameOver = true;
                    
                    // æ˜¾ç¤ºç»“æœå¼¹çª—
                    finalScoreDisplay.textContent = gameState.score;
                    resultModal.classList.remove('hidden');
                }
            }
            
            // åˆ›å»ºå¹¶æ´—ç‰Œ
            function createDeck() {
                const deck = [];
                
                for (const suit of SUITS) {
                    for (const rank of RANKS) {
                        deck.push({ suit, rank });
                    }
                }
                
                return deck;
            }
            
            // Fisher-Yatesæ´—ç‰Œï¼Œä½¿ç”¨seededRandom
            function shuffleDeck(deck) {
                const shuffled = [...deck];
                
                for (let i = shuffled.length - 1; i > 0; i--) {
                    const j = Math.floor(seededRandom() * (i + 1));
                    [shuffled[i], shuffled[j]] = [shuffled[j], shuffled[i]];
                }
                
                return shuffled;
            }
            
            // æŠ½ä¸€å¼ ç‰Œ
            function drawCard() {
                if (gameState.deck.length === 0) {
                    return null;
                }
                
                remainingCardsDisplay.textContent = gameState.deck.length - 1;
                return gameState.deck.pop();
            }
            
            // æ¸²æŸ“æ‰‹ç‰Œ
            function renderHand() {
                handContainer.innerHTML = '';
                
                if (gameState.hand.length === 0) {
                    const emptyText = document.createElement('div');
                    emptyText.className = 'text-gray-400 dark:text-gray-600 text-center w-full py-4';
                    emptyText.textContent = 'æ²¡æœ‰æ‰‹ç‰Œ';
                    handContainer.appendChild(emptyText);
                } else {
                    gameState.hand.forEach((card, index) => {
                        const cardElement = document.createElement('div');
                        cardElement.className = `card hand-card transition-transform duration-200 w-16 h-24 md:w-20 md:h-30 bg-white dark:bg-gray-800 border border-gray-300 dark:border-gray-700 rounded-lg shadow-md flex flex-col items-center justify-center ${gameState.selectedCard === index ? 'border-primary border-2 -translate-y-4' : ''}`;
                        cardElement.dataset.index = index;
                        
                        // å¡ç‰Œå†…å®¹
                        const rankElement = document.createElement('div');
                        rankElement.className = 'text-sm md:text-base';
                        rankElement.textContent = card.rank;
                        
                        const suitElement = document.createElement('div');
                        suitElement.className = `${card.suit} text-lg md:text-2xl`;
                        suitElement.textContent = SUIT_SYMBOLS[card.suit];
                        
                        cardElement.appendChild(rankElement);
                        cardElement.appendChild(suitElement);
                        
                        // æ·»åŠ ç‚¹å‡»äº‹ä»¶
                        cardElement.addEventListener('click', () => selectCard(index));
                        
                        handContainer.appendChild(cardElement);
                    });
                }
                
                // æ›´æ–°æ‰‹ç‰Œè®¡æ•°
                const handCountEl = document.getElementById('hand-count');
                if (handCountEl) {
                    handCountEl.textContent = gameState.hand.length;
                    
                    // å¦‚æœæ‰‹ç‰Œæ¥è¿‘ä¸Šé™ï¼Œé«˜äº®æ˜¾ç¤º
                    if (gameState.hand.length >= 8) {
                        handCountEl.className = 'font-bold';
                        if (gameState.hand.length >= 10) {
                            handCountEl.className += ' text-red-500 dark:text-red-400';
                        } else {
                            handCountEl.className += ' text-yellow-500 dark:text-yellow-400';
                        }
                    } else {
                        handCountEl.className = '';
                    }
                }
                
                // æ›´æ–°å¼ƒç‰ŒæŒ‰é’®çŠ¶æ€
                const discardBtn = document.getElementById('discard-btn');
                if (discardBtn) {
                    discardBtn.disabled = gameState.selectedCard === null;
                    discardBtn.classList.toggle('opacity-50', gameState.selectedCard === null);
                }
            }
            
            // é€‰æ‹©æ‰‹ç‰Œ
            function selectCard(index) {
                // å¦‚æœå·²ç»é€‰æ‹©äº†è¿™å¼ ç‰Œï¼Œå–æ¶ˆé€‰æ‹©
                if (gameState.selectedCard === index) {
                    gameState.selectedCard = null;
                    actionInfoElement.textContent = '';
                } else {
                    gameState.selectedCard = index;
                    const card = gameState.hand[index];
                    actionInfoElement.textContent = `å·²é€‰æ‹©: ${card.rank}${SUIT_SYMBOLS[card.suit]} - ç‚¹å‡»åŒºåŸŸæ‰§è¡Œæ“ä½œ`;
                }
                
                // é‡æ–°æ¸²æŸ“æ‰‹ç‰Œï¼Œæ˜¾ç¤ºé€‰ä¸­çŠ¶æ€
                renderHand();
            }
            
            // é€‰æ‹©è¡ŒåŠ¨
            function selectAction(action) {
                // å¦‚æœå·²ç»é€‰æ‹©äº†è¿™ä¸ªè¡ŒåŠ¨ï¼Œå–æ¶ˆé€‰æ‹©
                if (gameState.selectedAction === action) {
                    resetSelectionState();
                } else {
                    gameState.selectedAction = action;
                    gameState.selectedCard = null; // é‡ç½®é€‰ä¸­çš„å¡ç‰Œ
                    
                    // æ›´æ–°æŒ‰é’®æ ·å¼
                    document.getElementById('explore-btn').classList.toggle('ring-2', action === 'explore');
                    document.getElementById('occupy-btn').classList.toggle('ring-2', action === 'occupy');
                    
                    // æ˜¾ç¤ºç›¸å…³æç¤º
                    if (action === 'explore') {
                        showMessage(t('infoSelectCardToExplore'));
                    } else if (action === 'occupy') {
                        showMessage(t('infoSelectCardToOccupy'));
                    }
                }
                
                // æ›´æ–°æ“ä½œä¿¡æ¯
                updateActionInfo();
            }
            
            // é‡ç½®é€‰æ‹©çŠ¶æ€
            function resetSelectionState() {
                gameState.selectedAction = '';
                gameState.selectedCard = null;
                
                // é‡æ–°æ¸²æŸ“æ‰‹ç‰Œ
                renderHand();
                
                // æ¸…ç©ºæ“ä½œä¿¡æ¯
                actionInfoElement.textContent = '';
            }
            
            // æ›´æ–°æ“ä½œä¿¡æ¯
            function updateActionInfo() {
                if (!gameState.selectedAction) {
                    actionInfoElement.textContent = '';
                    return;
                }
                
                if (gameState.selectedCard === null) {
                    actionInfoElement.textContent = t('selectCard');
                } else {
                    const card = gameState.hand[gameState.selectedCard];
                    
                    if (gameState.selectedAction === 'explore') {
                        actionInfoElement.textContent = `æ¢ç´¢: ä½¿ç”¨ ${card.rank}${SUIT_SYMBOLS[card.suit]} æ¢ç´¢æœªå é¢†åŒºåŸŸ`;
                    } else if (gameState.selectedAction === 'occupy') {
                        actionInfoElement.textContent = `å é¢†: ä½¿ç”¨ ${card.rank}${SUIT_SYMBOLS[card.suit]} å é¢†å·²æ¢ç´¢åŒºåŸŸ`;
                    }
                }
            }
            
            // æ˜¾ç¤ºæ¶ˆæ¯
            function showMessage(message) {
                gameMessageElement.textContent = message;
                
                // æ·»åŠ åŠ¨ç”»æ•ˆæœ
                gameMessageElement.classList.add('text-primary');
                setTimeout(() => {
                    gameMessageElement.classList.remove('text-primary');
                }, 2000);
            }
            
            // æ·»åŠ æ—¥å¿—æ¡ç›®
            function addLogEntry(message) {
                const logEntry = document.createElement('div');
                logEntry.className = 'mb-1 pb-1 border-b border-gray-200 dark:border-gray-700';
                
                // å›åˆå‰ç¼€
                const turnPrefix = document.createElement('span');
                turnPrefix.className = 'font-bold';
                turnPrefix.textContent = `[${gameState.turn}] `;
                
                logEntry.appendChild(turnPrefix);
                logEntry.appendChild(document.createTextNode(message));
                
                gameLogElement.insertBefore(logEntry, gameLogElement.firstChild);
                
                // è®°å½•åˆ°æ—¥å¿—æ•°æ®
                gameLogData.push({
                    turn: gameState.turn,
                    message: message,
                    timestamp: new Date().toISOString(),
                    score: gameState.score
                });
            }
            
            // ä¿å­˜æ¸¸æˆçŠ¶æ€
            function saveGameState() {
                return {
                    deck: [...gameState.deck],
                    hand: [...gameState.hand],
                    discardPile: [...gameState.discardPile],
                    score: gameState.score,
                    turn: gameState.turn,
                    currentSeed: gameState.currentSeed,
                    regions: JSON.parse(JSON.stringify(gameState.regions)),
                    gameOver: gameState.gameOver
                };
            }
            
            // å°†æ–°çŠ¶æ€æ·»åŠ åˆ°å†å²è®°å½•
            function addToHistory(state) {
                // å¦‚æœåœ¨å†å²ä¸­é—´ç‚¹è¿›è¡Œäº†æ–°æ“ä½œï¼Œåˆ é™¤è¯¥ç‚¹ä¹‹åçš„æ‰€æœ‰å†å²
                if (currentHistoryIndex >= 0 && currentHistoryIndex < history.length - 1) {
                    history = history.slice(0, currentHistoryIndex + 1);
                }
                
                // æ·»åŠ æ–°çŠ¶æ€åˆ°å†å²è®°å½•
                history.push(state);
                currentHistoryIndex = history.length - 1;
                
                // æ›´æ–°æ’¤é”€æŒ‰é’®çŠ¶æ€
                updateUndoButton();
            }
            
            // æ¢å¤æ¸¸æˆçŠ¶æ€
            function restoreGameState(state) {
                // æ¢å¤æ‰€æœ‰æ¸¸æˆçŠ¶æ€
                gameState.deck = [...state.deck];
                gameState.hand = [...state.hand];
                gameState.discardPile = [...state.discardPile];
                gameState.score = state.score;
                gameState.turn = state.turn;
                gameState.currentSeed = state.currentSeed;
                gameState.regions = JSON.parse(JSON.stringify(state.regions));
                gameState.gameOver = state.gameOver;
                
                // é‡ç½®é€‰æ‹©çŠ¶æ€
                resetSelectionState();
                
                // æ›´æ–°UI
                scoreDisplay.textContent = gameState.score;
                turnCounter.textContent = gameState.turn;
                remainingCardsDisplay.textContent = gameState.deck.length;
                
                // é‡æ–°æ¸²æŸ“æ‰‹ç‰Œ
                renderHand();
                
                // æ›´æ–°æ‰€æœ‰åŒºåŸŸæ˜¾ç¤º
                updateAllRegionsDisplay();
                
                // æ›´æ–°æ’¤é”€æŒ‰é’®çŠ¶æ€
                updateUndoButton();
                
                // å¦‚æœæ¸¸æˆç»“æŸï¼Œæ˜¾ç¤ºç»“æœå¼¹çª—
                if (gameState.gameOver) {
                    finalScoreDisplay.textContent = gameState.score;
                    resultModal.classList.remove('hidden');
                } else {
                    resultModal.classList.add('hidden');
                }
            }
            
            // æ›´æ–°æ‰€æœ‰åŒºåŸŸæ˜¾ç¤º
            function updateAllRegionsDisplay() {
                for (const pathId of PATHS) {
                    for (let i = 0; i < 13; i++) {
                        updateRegionDisplay(pathId, i);
                    }
                }
            }
            
            // æ›´æ–°æ‰€æœ‰èŠ±è‰²æ”¶è·å¥‡è§‚çš„åˆ†æ•°
            function updateAllSuitBonusWonders(changedPathId = null, changedSuit = null) {
                // éå†æ‰€æœ‰è·¯å¾„å¯»æ‰¾èŠ±è‰²æ”¶è·å¥‡è§‚
                for (const pathId of PATHS) {
                    for (let i = 0; i < 13; i++) {
                        const region = gameState.regions[pathId][i];
                        
                        // æ£€æŸ¥æ˜¯å¦æ˜¯å·²å é¢†çš„å¥‡è§‚ä¸”æœ‰èŠ±è‰²æ”¶è·æ•ˆæœ
                        if (region.status === 'occupied' && 
                            region.type === 'wonder' && 
                            region.wonderData && 
                            region.wonderEffect && 
                            region.wonderEffect.type === 'suit_bonus') {
                            
                            const effect = region.wonderEffect;
                            
                            // å¦‚æœæŒ‡å®šäº†changedPathIdå’ŒchangedSuitï¼Œåªæ›´æ–°å—å½±å“çš„å¥‡è§‚
                            if (changedPathId && changedSuit) {
                                // å¦‚æœå¥‡è§‚ç›‘æ§çš„è·¯å¾„ä¸æ˜¯å˜æ›´çš„è·¯å¾„ï¼Œæˆ–è€…ç›‘æ§çš„èŠ±è‰²ä¸æ˜¯å˜æ›´çš„èŠ±è‰²ï¼Œåˆ™è·³è¿‡
                                if (effect.pathId !== changedPathId || effect.suit !== changedSuit) {
                                    continue;
                                }
                            }
                            
                            // è®¡ç®—è¯¥è·¯å¾„ä¸ŠåŒ¹é…èŠ±è‰²çš„æ•°é‡
                            let suitCount = 0;
                            for (const r of gameState.regions[effect.pathId]) {
                                if (r.status === 'occupied' && r.occupyCard && r.occupyCard.suit === effect.suit) {
                                    suitCount++;
                                }
                            }
                            
                            // ä½¿ç”¨3Ã—nÂ²å…¬å¼è®¡ç®—æ–°çš„å¾—åˆ†
                            const newPoints = 3 * (suitCount * suitCount);
                            
                            // å¦‚æœå¾—åˆ†å‘ç”Ÿå˜åŒ–ï¼Œæ›´æ–°åŒºåŸŸå¾—åˆ†
                            if (region.points !== newPoints) {
                                region.points = newPoints;
                                // æ›´æ–°åŒºåŸŸæ˜¾ç¤º
                                updateRegionDisplay(pathId, i);
                            }
                        }
                    }
                }
            }
            
            // æ›´æ–°æ’¤é”€æŒ‰é’®çŠ¶æ€
            function updateUndoButton() {
                const undoBtn = document.getElementById('undo-btn');
                
                undoBtn.disabled = currentHistoryIndex <= 0;
                undoBtn.classList.toggle('opacity-50', currentHistoryIndex <= 0);
            }
            
            // æ’¤é”€æ“ä½œ
            function undoMove() {
                if (currentHistoryIndex > 0) {
                    currentHistoryIndex--;
                    restoreGameState(history[currentHistoryIndex]);
                }
            }
            
            // åˆ›å»ºä¸€ä¸ªç§å­éšæœºæ•°ç”Ÿæˆå™¨
            function createSeededRandom(seed) {
                // ç®€å•çš„å“ˆå¸Œå‡½æ•°
                let hash = Array.from(seed).reduce((acc, char) => {
                    return ((acc << 5) - acc) + char.charCodeAt(0) | 0;
                }, 0);
                
                return function() {
                    const x = Math.sin(hash++) * 10000;
                    return x - Math.floor(x);
                };
            }
            
            // æ˜¾ç¤ºæç¤ºä¿¡æ¯
            function showToast(message) {
                toastElement.textContent = message;
                toastElement.classList.add('opacity-100');
                
                setTimeout(() => {
                    toastElement.classList.remove('opacity-100');
                }, 2000);
            }
            
            // å¤åˆ¶ç§å­
            function copySeed() {
                navigator.clipboard.writeText(gameState.currentSeed).then(() => {
                    showToast(t('copied'));
                });
            }
            
            // åˆ†äº«æ¸¸æˆ
            function shareGame() {
                let shareUrl;
                
                // å¤„ç† about:srcdoc ç‰¹æ®Šæƒ…å†µï¼ˆåœ¨ Poe ç¯å¢ƒä¸­ï¼‰
                if (!window.location.href || window.location.href === "about:srcdoc") {
                    // åœ¨ Poe iframe ä¸­ä½¿ç”¨å›ºå®šçš„ URL
                    shareUrl = "https://poe.com/4XPoker";
                } else {
                    // åœ¨å…¶ä»–ç¯å¢ƒä¸­ä½¿ç”¨å½“å‰ URL çš„åŸºç¡€éƒ¨åˆ†
                    const url = new URL(window.location.href);
                    shareUrl = url.origin + url.pathname;
                }
                
                // ä½¿ç”¨ code å‚æ•°æ›¿ä»£ seed å‚æ•°
                shareUrl += "?code=" + encodeURIComponent(gameState.currentSeed);
                
                const shareText = t('shareText', {
                    score: gameState.score,
                    seed: gameState.currentSeed
                });
                
                // å°†å®Œæ•´çš„åˆ†äº«é“¾æ¥æ·»åŠ åˆ°æ–‡æœ¬æœ«å°¾
                const fullShareText = `${shareText}\n${shareUrl}`;
                
                navigator.clipboard.writeText(fullShareText).then(() => {
                    showToast(t('copied'));
                }).catch(err => {
                    console.error('Share failed:', err);
                });
            }
            
            // æ›´æ–°å¼ƒç‰Œå †è®¡æ•°
            function updateDiscardCount() {
                const discardCountEl = document.getElementById('discard-count');
                if (discardCountEl) {
                    discardCountEl.textContent = gameState.discardPile.length;
                }
            }
            
            // å¼€å§‹æ–°æ¸¸æˆ
            function startGame(seed = null) {
                // ç”Ÿæˆæˆ–ä½¿ç”¨æä¾›çš„ç§å­
                gameState.currentSeed = seed || crypto.randomUUID();
                seedDisplay.textContent = gameState.currentSeed;
                
                // åˆå§‹åŒ–éšæœºæ•°ç”Ÿæˆå™¨
                seededRandom = createSeededRandom(gameState.currentSeed);
                
                // é‡ç½®æ¸¸æˆçŠ¶æ€
                gameState.deck = createDeck();
                gameState.deck = shuffleDeck(gameState.deck);
                gameState.hand = [];
                gameState.discardPile = [];
                gameState.score = 0;
                gameState.turn = 1;
                gameState.gameOver = false;
                
                // é‡ç½®é€‰æ‹©çŠ¶æ€
                resetSelectionState();
                
                // åˆå§‹åŒ–æ¸¸æˆåŒºåŸŸ
                initializeGameRegions();
                
                // æŠ½5å¼ èµ·å§‹æ‰‹ç‰Œ
                for (let i = 0; i < 5; i++) {
                    if (gameState.deck.length > 0) {
                        gameState.hand.push(drawCard());
                    }
                }
                
                // æ›´æ–°UI
                scoreDisplay.textContent = gameState.score;
                turnCounter.textContent = gameState.turn;
                remainingCardsDisplay.textContent = gameState.deck.length;
                updateDiscardCount();
                
                // æ¸²æŸ“æ‰‹ç‰Œ
                renderHand();
                
                // éšè—ç»“æœå¼¹çª—
                resultModal.classList.add('hidden');
                
                // é‡ç½®æ¸¸æˆæ—¥å¿—
                gameLogElement.innerHTML = '';
                gameLogData = [];
                
                // æ·»åŠ æ¸¸æˆå¼€å§‹æ—¥å¿—
                addLogEntry(t('gameStart'));
                
                // é‡ç½®å†å²è®°å½•å¹¶ä¿å­˜åˆå§‹çŠ¶æ€
                history = [];
                currentHistoryIndex = -1;
                addToHistory(saveGameState());
            }
            
            // ç¿»è¯‘å‡½æ•°
            function t(key, replacements = {}) {
                let text = LANGUAGES[currentLanguage][key] || LANGUAGES['en'][key] || key;
                
                // åº”ç”¨æ›¿æ¢
                for (const [placeholder, value] of Object.entries(replacements)) {
                    text = text.replace(`{${placeholder}}`, value);
                }
                
                return text;
            }
            
            // æ£€æµ‹ç”¨æˆ·çš„æµè§ˆå™¨è¯­è¨€
            function detectBrowserLanguage() {
                const browserLang = navigator.language || navigator.userLanguage;
                const shortLang = browserLang.split('-')[0];
                
                // æ£€æŸ¥æ˜¯å¦æœ‰å®Œå…¨åŒ¹é…
                if (LANGUAGES[browserLang]) {
                    return browserLang;
                }
                
                // æ£€æŸ¥è¯­è¨€åŒ¹é…
                for (const lang in LANGUAGES) {
                    if (lang.startsWith(shortLang)) {
                        return lang;
                    }
                }
                
                // é»˜è®¤ä¸ºä¸­æ–‡
                return 'zh-CN';
            }
            
            // åº”ç”¨ç¿»è¯‘
            function applyTranslations() {
                document.querySelectorAll('[data-i18n]').forEach(element => {
                    const key = element.getAttribute('data-i18n');
                    element.textContent = t(key);
                });
            }
            
            // æ£€æŸ¥æš—é»‘æ¨¡å¼
            function checkDarkMode() {
                if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
                    document.documentElement.classList.add('dark');
                }
                
                window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', event => {
                    if (event.matches) {
                        document.documentElement.classList.add('dark');
                    } else {
                        document.documentElement.classList.remove('dark');
                    }
                });
            }
            
            // åˆå§‹åŒ–äº‹ä»¶ç›‘å¬å™¨
            function setupEventListeners() {
                // æ–°æ¸¸æˆæŒ‰é’®
                document.getElementById('new-game-btn').addEventListener('click', () => startGame());
                
                // æ’¤é”€æŒ‰é’®
                document.getElementById('undo-btn').addEventListener('click', undoMove);
                
                // ç»“æŸå›åˆæŒ‰é’®
                document.getElementById('end-turn-btn').addEventListener('click', endTurn);
                
                // å¼ƒç‰ŒæŒ‰é’®
                document.getElementById('discard-btn').addEventListener('click', discardCard);
                
                // å¤åˆ¶ç§å­æŒ‰é’®
                document.getElementById('copy-seed').addEventListener('click', copySeed);
                
                // åˆ†äº«æ¸¸æˆæŒ‰é’®
                document.getElementById('share-game').addEventListener('click', shareGame);
                
                // é¡¶éƒ¨ç§å­è¾“å…¥æ¡†éšæœºç§å­æŒ‰é’®
                document.getElementById('random-seed-btn').addEventListener('click', () => {
                    const newSeed = crypto.randomUUID();
                    const seedInput = document.getElementById('seed-input');
                    seedInput.value = newSeed;
                    seedInput.classList.add('bg-yellow-100', 'dark:bg-yellow-900');
                    setTimeout(() => {
                        seedInput.classList.remove('bg-yellow-100', 'dark:bg-yellow-900');
                    }, 1000);
                });
                
                // é¡¶éƒ¨ç§å­è¾“å…¥æ¡†å¼€å§‹æ¸¸æˆæŒ‰é’®
                document.getElementById('start-seed-game').addEventListener('click', () => {
                    const seedInput = document.getElementById('seed-input');
                    const seed = seedInput.value.trim();
                    if (seed) {
                        startGame(seed);
                        // æ›´æ–°æ¸¸æˆæ§åˆ¶åŒºçš„ç§å­æ˜¾ç¤º
                        seedDisplay.textContent = seed;
                    } else {
                        seedInput.classList.add('border-red-500');
                        setTimeout(() => {
                            seedInput.classList.remove('border-red-500');
                        }, 1000);
                    }
                });
                
                // ç§å­è¾“å…¥æ¡†å›è½¦é”®è§¦å‘å¼€å§‹æ¸¸æˆ
                document.getElementById('seed-input').addEventListener('keydown', (e) => {
                    if (e.key === 'Enter') {
                        document.getElementById('start-seed-game').click();
                    }
                });
                
                // éšæœºç§å­æŒ‰é’®ï¼ˆé¡¶éƒ¨ä¿¡æ¯åŒºï¼‰
                document.getElementById('random-seed').addEventListener('click', () => {
                    const newSeed = crypto.randomUUID();
                    // æ›´æ–°æ˜¾ç¤ºå’Œæ¸¸æˆçŠ¶æ€ä¸­çš„ç§å­
                    seedDisplay.textContent = newSeed;
                    gameState.currentSeed = newSeed;
                    
                    // åŒæ—¶æ›´æ–°ç§å­è¾“å…¥æ¡†
                    const seedInput = document.getElementById('seed-input');
                    if (seedInput) {
                        seedInput.value = newSeed;
                    }
                    
                    // é«˜äº®æ˜¾ç¤ºæç¤ºå·²æ›´æ–°
                    seedDisplay.classList.add('bg-yellow-100', 'dark:bg-yellow-900');
                    setTimeout(() => {
                        seedDisplay.classList.remove('bg-yellow-100', 'dark:bg-yellow-900');
                    }, 1000);
                });
                
                // æ˜¾ç¤ºè¾“å…¥ç§å­å¼¹çª—
            function showSeedInputPrompt() {
                // åˆ›å»ºå¼¹çª—æç¤º
                const promptOverlay = document.createElement('div');
                promptOverlay.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
                
                const promptBox = document.createElement('div');
                promptBox.className = 'bg-white dark:bg-gray-800 p-5 rounded-lg shadow-lg max-w-md w-full mx-4';
                
                const title = document.createElement('h3');
                title.className = 'text-xl font-bold mb-3 text-center';
                title.textContent = 'è¾“å…¥ç§å­';
                
                const message = document.createElement('p');
                message.className = 'mb-4 text-sm text-gray-600 dark:text-gray-400';
                message.textContent = 'è¾“å…¥ä¸€ä¸ªç§å­å€¼æ¥å¼€å§‹ç›¸åŒçš„æ¸¸æˆï¼Œæˆ–ä½¿ç”¨å½“å‰ç§å­é‡ç©ã€‚';
                
                const inputContainer = document.createElement('div');
                inputContainer.className = 'mb-4';
                
                const input = document.createElement('input');
                input.type = 'text';
                input.className = 'w-full p-2 border border-gray-300 dark:border-gray-600 rounded bg-white dark:bg-gray-700 text-gray-800 dark:text-gray-200';
                input.placeholder = 'è¾“å…¥ç§å­å€¼';
                input.value = gameState.currentSeed;
                input.spellcheck = false;
                
                inputContainer.appendChild(input);
                
                const buttonContainer = document.createElement('div');
                buttonContainer.className = 'flex justify-between gap-3';
                
                const startButton = document.createElement('button');
                startButton.className = 'bg-primary hover:bg-indigo-700 text-white px-4 py-2 rounded-lg flex-1';
                startButton.textContent = 'å¼€å§‹æ¸¸æˆ';
                startButton.addEventListener('click', () => {
                    const seed = input.value.trim();
                    if (seed) {
                        document.body.removeChild(promptOverlay);
                        startGame(seed);
                    } else {
                        input.classList.add('border-red-500');
                    }
                });
                
                const cancelButton = document.createElement('button');
                cancelButton.className = 'bg-gray-200 dark:bg-gray-700 hover:bg-gray-300 dark:hover:bg-gray-600 text-gray-700 dark:text-gray-300 px-4 py-2 rounded-lg flex-1';
                cancelButton.textContent = 'å–æ¶ˆ';
                cancelButton.addEventListener('click', () => {
                    document.body.removeChild(promptOverlay);
                });
                
                buttonContainer.appendChild(startButton);
                buttonContainer.appendChild(cancelButton);
                
                promptBox.appendChild(title);
                promptBox.appendChild(message);
                promptBox.appendChild(inputContainer);
                promptBox.appendChild(buttonContainer);
                promptOverlay.appendChild(promptBox);
                
                document.body.appendChild(promptOverlay);
                
                // è‡ªåŠ¨èšç„¦è¾“å…¥æ¡†
                setTimeout(() => {
                    input.focus();
                    input.select();
                }, 100);
                
                // æ·»åŠ æŒ‰å›è½¦é”®æäº¤
                input.addEventListener('keydown', (e) => {
                    if (e.key === 'Enter') {
                        startButton.click();
                    }
                });
            }
            
            // è¾“å…¥ç§å­æŒ‰é’®
            document.getElementById('input-seed').addEventListener('click', () => {
                showSeedInputPrompt();
            });
                
                // æ¸¸æˆç»“æŸå¼¹çª—çš„æŒ‰é’®
                document.getElementById('play-again').addEventListener('click', () => startGame());
                document.getElementById('replay-same-seed').addEventListener('click', () => startGame(gameState.currentSeed));
                document.getElementById('share-result').addEventListener('click', shareGame);
                
                // å†å²æµè§ˆå™¨æŒ‰é’®
                document.getElementById('history-btn').addEventListener('click', () => {
                    // æ˜¾ç¤ºå†å²æµè§ˆå™¨
                    const historyModal = document.getElementById('history-modal');
                    if (historyModal) {
                        historyModal.classList.remove('hidden');
                    }
                });
                
                // å†å²æµè§ˆå™¨çš„å–æ¶ˆæŒ‰é’®
                document.getElementById('history-cancel').addEventListener('click', () => {
                    const historyModal = document.getElementById('history-modal');
                    if (historyModal) {
                        historyModal.classList.add('hidden');
                    }
                });
            }
            
            // åˆå§‹åŒ–
            function init() {
                // è®¾ç½®å½“å‰è¯­è¨€
                currentLanguage = detectBrowserLanguage();
                
                // åº”ç”¨ç¿»è¯‘
                applyTranslations();
                
                // æ£€æŸ¥æš—é»‘æ¨¡å¼
                checkDarkMode();
                
                // è®¾ç½®äº‹ä»¶ç›‘å¬å™¨
                setupEventListeners();
                
                // æ£€æŸ¥URLæ˜¯å¦åŒ…å«ç§å­å‚æ•°ï¼ˆæ”¯æŒcodeæˆ–seedå‚æ•°ï¼‰
                let seedFromURL = null;
                try {
                    const urlParams = new URLSearchParams(window.location.search);
                    // ä¼˜å…ˆä½¿ç”¨codeå‚æ•°ï¼Œå¦‚æœæ²¡æœ‰åˆ™å°è¯•ä½¿ç”¨seedå‚æ•°
                    seedFromURL = urlParams.get('code') || urlParams.get('seed');
                } catch (error) {
                    console.error("Error parsing URL parameters:", error);
                }
                
                // å¦‚æœæœ‰URLç§å­ï¼ŒåŒæ—¶æ›´æ–°ç§å­è¾“å…¥æ¡†
                if (seedFromURL) {
                    const seedInput = document.getElementById('seed-input');
                    if (seedInput) {
                        seedInput.value = seedFromURL;
                    }
                }
                
                // å¼€å§‹æ¸¸æˆ
                startGame(seedFromURL);
            }
            
            // å½“é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–æ¸¸æˆ
            window.addEventListener('DOMContentLoaded', init);
        </script>
    </div>
</body>
</html>

