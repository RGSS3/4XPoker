<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ–‡æ˜4Xæ‰‘å…‹</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        primary: '#5D5CDE',
                        land: '#8BC34A',    // é™†åœ°ç»¿è‰²
                        ocean: '#03A9F4',   // æµ·æ´‹è“è‰²
                        desert: '#FFC107',  // æ²™æ¼ é»„è‰²
                        sky: '#9C27B0',     // å¤©ç©ºç´«è‰²
                        unexplored: '#9E9E9E', // æœªæ¢ç´¢ç°è‰²
                        explored: '#E0E0E0',   // å·²æ¢ç´¢ç™½è‰²
                        occupied: '#2196F3',   // å·²å é¢†è“è‰²
                        echo: '#4CAF50',     // å›å£°åŒºåŸŸç»¿è‰²
                        wonder: '#8BC34A',   // å¥‡è§‚åŒºåŸŸæµ…ç»¿è‰²
                        combat: '#F44336',   // æˆ˜æ–—åŒºåŸŸçº¢è‰²
                        disaster: '#FF5722'  // ç¾éš¾åŒºåŸŸæ©™è‰²
                    }
                }
            }
        }
    </script>
    <style>
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        @keyframes fadeOut {
            from { opacity: 1; }
            to { opacity: 0; }
        }
        
        .card-fade-in {
            animation: fadeIn 0.3s ease-in-out;
        }
        
        .card-fade-out {
            animation: fadeOut 0.3s ease-in-out;
        }
        
        .card {
            aspect-ratio: 2/3;
            perspective: 1000px;
        }
        
        .card-inner {
            transform-style: preserve-3d;
            transition: transform 0.6s;
        }
        
        .card-front, .card-back {
            backface-visibility: hidden;
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            border-radius: 0.5rem;
        }
        
        .card-back {
            transform: rotateY(180deg);
            background-image: repeating-linear-gradient(45deg, rgba(93, 92, 222, 0.1) 0, rgba(93, 92, 222, 0.1) 10px, transparent 10px, transparent 20px);
        }
        
        .dark .card-back {
            background-image: repeating-linear-gradient(45deg, rgba(93, 92, 222, 0.2) 0, rgba(93, 92, 222, 0.2) 10px, transparent 10px, transparent 20px);
        }
        
        /* èŠ±è‰²é¢œè‰²å®šä¹‰ */
        .heart {
            color: #E53E3E; /* çº¢è‰² */
        }
        
        .dark .heart {
            color: #FC8181; /* æ·±è‰²æ¨¡å¼ä¸‹çš„çº¢è‰² */
        }
        
        .diamond {
            color: #ED8936; /* æ©™è‰² */
        }
        
        .dark .diamond {
            color: #F6AD55; /* æ·±è‰²æ¨¡å¼ä¸‹çš„æ©™è‰² */
        }
        
        .spade {
            color: #805AD5; /* ç´«è‰² */
        }
        
        .dark .spade {
            color: #9F7AEA; /* æ·±è‰²æ¨¡å¼ä¸‹çš„ç´«è‰² */
        }
        
        .club {
            color: #2D3748; /* æ·±ç°è‰²/é»‘è‰² */
        }
        
        .dark .club {
            color: #E2E8F0; /* æ·±è‰²æ¨¡å¼ä¸‹çš„ç°ç™½è‰² */
        }

        /* æ¸¸æˆæ¿åŒºåŸŸç±»å‹æ ·å¼ */
        .region-unexplored {
            background-color: theme('colors.unexplored');
        }
        
        .region-explored {
            background-color: theme('colors.explored');
        }
        
        .region-occupied {
            background-color: theme('colors.occupied');
        }
        
        .region-echo {
            background-color: theme('colors.echo');
        }
        
        /* å¥‡è§‚æ ·å¼ - ä½¿ç”¨ç™½è‰²èƒŒæ™¯å’ŒåŠ ç²—å½©è‰²è¾¹æ¡† */
        .wonder-orange {
            background-color: #FFFFFF;
            color: #000;
            border: 6px solid #FF9800;
            box-shadow: 0 0 0 2px #FF9800, inset 0 0 0 1px #FF9800;
            position: relative;
            z-index: 1;
        }
        
        .wonder-purple {
            background-color: #FFFFFF;
            color: #000;
            border: 6px solid #9C27B0;
            box-shadow: 0 0 0 2px #9C27B0, inset 0 0 0 1px #9C27B0;
            position: relative;
            z-index: 1;
        }
        
        .wonder-blue {
            background-color: #FFFFFF;
            color: #000;
            border: 6px solid #2196F3;
            box-shadow: 0 0 0 2px #2196F3, inset 0 0 0 1px #2196F3;
            position: relative;
            z-index: 1;
        }
        
        .dark .wonder-orange {
            background-color: #1a1a1a;
            color: #fff;
            border: 6px solid #FF9800;
            box-shadow: 0 0 0 2px #FF9800, inset 0 0 0 1px #FF9800;
        }
        
        .dark .wonder-purple {
            background-color: #1a1a1a;
            color: #fff;
            border: 6px solid #9C27B0;
            box-shadow: 0 0 0 2px #9C27B0, inset 0 0 0 1px #9C27B0;
        }
        
        .dark .wonder-blue {
            background-color: #1a1a1a;
            color: #fff;
            border: 6px solid #2196F3;
            box-shadow: 0 0 0 2px #2196F3, inset 0 0 0 1px #2196F3;
        }
        
        /* å¥‡è§‚é—ªå…‰æ•ˆæœ */
        .wonder-orange::before, .wonder-purple::before, .wonder-blue::before {
            content: '';
            position: absolute;
            top: -2px;
            left: -2px;
            right: -2px;
            bottom: -2px;
            border-radius: inherit;
            z-index: -1;
        }
        
        .wonder-orange::before {
            box-shadow: 0 0 10px 2px rgba(255, 152, 0, 0.6);
        }
        
        .wonder-purple::before {
            box-shadow: 0 0 10px 2px rgba(156, 39, 176, 0.6);
        }
        
        .wonder-blue::before {
            box-shadow: 0 0 10px 2px rgba(33, 150, 243, 0.6);
        }
        
        /* æˆ˜äº‰åŒºåŸŸæ ·å¼ */
        .combat-orange {
            background-color: rgba(255, 152, 0, 0.1);
            color: #000;
            border: 3px solid #FF9800;
            position: relative;
            z-index: 1;
        }
        
        .combat-purple {
            background-color: rgba(156, 39, 176, 0.1);
            color: #000;
            border: 3px solid #9C27B0;
            position: relative;
            z-index: 1;
        }
        
        .combat-blue {
            background-color: rgba(33, 150, 243, 0.1);
            color: #000;
            border: 3px solid #2196F3;
            position: relative;
            z-index: 1;
        }
        
        .dark .combat-orange {
            background-color: rgba(255, 152, 0, 0.2);
            color: #fff;
            border: 3px solid #FF9800;
        }
        
        .dark .combat-purple {
            background-color: rgba(156, 39, 176, 0.2);
            color: #fff;
            border: 3px solid #9C27B0;
        }
        
        .dark .combat-blue {
            background-color: rgba(156, 39, 176, 0.2);
            color: #fff;
            border: 3px solid #2196F3;
        }
        
        /* æ¢ç´¢çº¿è·¯æ ·å¼ */
        .path-land {
            border-left: 4px solid theme('colors.land');
        }
        
        .path-ocean {
            border-left: 4px solid theme('colors.ocean');
        }
        
        .path-desert {
            border-left: 4px solid theme('colors.desert');
        }
        
        .path-sky {
            border-left: 4px solid theme('colors.sky');
        }
        
        /* æ‰‹ç‰Œæ‚¬åœæ•ˆæœ */
        .hand-card:hover {
            transform: translateY(-10px);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }
        
        /* Ensure all inputs have at least 16px font size on mobile */
        @media (max-width: 768px) {
            input, button, select, textarea {
                font-size: 16px !important;
            }
        }
        
        /* Disable text selection for the game interface */
        body {
            user-select: none;
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
        }
        
        /* Re-enable text selection for input elements */
        input, textarea {
            user-select: text;
            -webkit-user-select: text;
            -moz-user-select: text;
            -ms-user-select: text;
        }
    </style>
</head>
<body class="bg-white dark:bg-gray-900 text-gray-900 dark:text-gray-100 min-h-screen">
    <div class="container mx-auto px-4 py-8 max-w-6xl">
        <!-- æ¸¸æˆæ ‡é¢˜å’Œä¿¡æ¯ -->
        <div class="text-center mb-4">
            <h1 class="text-3xl font-bold mb-2" data-i18n="gameTitle">æ–‡æ˜4Xæ‰‘å…‹</h1>
            <p class="text-sm md:text-base text-gray-600 dark:text-gray-400 mb-2" data-i18n="gameDescription">æ¢ç´¢ã€æ‰©å¼ ã€å¼€å‘ã€å¾æœï¼ä½¿ç”¨æ‰‘å…‹ç‰Œå»ºç«‹æ‚¨çš„æ–‡æ˜</p>
        </div>
        
        <!-- ç§å­è¾“å…¥åŒºåŸŸ -->
        <div class="flex flex-col md:flex-row justify-center items-center mb-4 gap-2">
            <div class="bg-gray-100 dark:bg-gray-800 rounded-lg p-3 shadow-md flex-grow max-w-xl w-full">
                <div class="flex flex-wrap gap-2 items-center">
                    <label for="seed-input" class="font-bold text-sm whitespace-nowrap">æ¸¸æˆç§å­:</label>
                    <div class="flex flex-1 min-w-0">
                        <input 
                            id="seed-input" 
                            type="text" 
                            class="flex-1 min-w-0 text-base p-2 border border-gray-300 dark:border-gray-600 rounded-l-md bg-white dark:bg-gray-700 text-gray-800 dark:text-gray-200"
                            placeholder="è¾“å…¥ç§å­å€¼æˆ–ä½¿ç”¨éšæœºç§å­" 
                            value="" 
                            spellcheck="false"
                        />
                        <button id="random-seed-btn" class="bg-gray-200 dark:bg-gray-700 hover:bg-gray-300 dark:hover:bg-gray-600 px-3 py-2 rounded-r-md text-gray-700 dark:text-gray-300 flex items-center">
                            ğŸ²
                        </button>
                    </div>
                    <button id="start-seed-game" class="bg-primary hover:bg-indigo-700 text-white px-4 py-2 rounded-lg whitespace-nowrap">
                        å¼€å§‹æ¸¸æˆ
                    </button>
                </div>
            </div>
        </div>
        
        <!-- æ¸¸æˆæ§åˆ¶å’Œä¿¡æ¯ -->
        <div class="flex flex-wrap justify-between items-center mb-4 gap-2">
            <!-- å¾—åˆ†å’Œå›åˆä¿¡æ¯ -->
            <div class="flex flex-col bg-gray-100 dark:bg-gray-800 rounded-lg p-2 shadow-md">
                <div class="flex items-center space-x-4">
                    <div class="text-xl font-bold"><span data-i18n="score">å¾—åˆ†</span>: <span id="score" class="text-primary">0</span></div>
                    <div class="text-lg"><span data-i18n="turn">å›åˆ</span>: <span id="turn-counter">1</span></div>
                </div>
                <div class="text-sm text-gray-600 dark:text-gray-400 flex space-x-3">
                    <div><span data-i18n="remainingCards">ç‰Œå †</span>: <span id="remaining-cards">47</span></div>
                    <div><span>å¼ƒç‰Œå †</span>: <span id="discard-count">0</span></div>
                </div>
            </div>
            
            <!-- ç§å­ä¿¡æ¯å’Œåˆ†äº« -->
            <div class="flex items-center bg-gray-100 dark:bg-gray-800 rounded-lg p-2 shadow-md">
                <span class="mr-2 text-sm" data-i18n="randomSeed">éšæœºç§å­</span>
                <code id="seed-display" class="bg-gray-200 dark:bg-gray-700 px-2 py-1 rounded text-xs break-all mr-2"></code>
                <div class="flex space-x-1">
                    <button id="random-seed" class="text-primary hover:text-primary-dark p-1 rounded text-xs" title="ç”Ÿæˆéšæœºç§å­">ğŸ²</button>
                    <button id="input-seed" class="text-primary hover:text-primary-dark p-1 rounded text-xs" title="è¾“å…¥ç§å­">âŒ¨ï¸</button>
                    <button id="copy-seed" class="text-primary hover:text-primary-dark p-1 rounded text-xs" title="å¤åˆ¶ç§å­">ğŸ“‹</button>
                    <button id="share-game" class="text-primary hover:text-primary-dark p-1 rounded text-xs" title="åˆ†äº«æ¸¸æˆ">â†—ï¸</button>
                </div>
            </div>
            
            <!-- æ¸¸æˆæ§åˆ¶æŒ‰é’® -->
            <div class="flex space-x-2">
                <button id="new-game-btn" class="bg-primary hover:bg-indigo-700 text-white px-3 py-1 rounded-lg text-sm">
                    <span data-i18n="newGame">æ–°æ¸¸æˆ</span>
                </button>
                <button id="undo-btn" class="bg-gray-200 dark:bg-gray-700 hover:bg-gray-300 dark:hover:bg-gray-600 text-gray-700 dark:text-gray-300 px-3 py-1 rounded-lg text-sm opacity-50" disabled>
                    <span data-i18n="undo">æ’¤é”€</span>
                </button>
                <button id="history-btn" class="bg-gray-200 dark:bg-gray-700 hover:bg-gray-300 dark:hover:bg-gray-600 text-gray-700 dark:text-gray-300 px-3 py-1 rounded-lg text-sm">
                    <span data-i18n="history">å†å²</span>
                </button>
            </div>
        </div>
        
        <!-- æ¸¸æˆåŒºåŸŸ -->
        <div class="flex flex-col md:flex-row gap-4" style="margin-bottom: 60px">
            <!-- ä¸»æ¸¸æˆåŒºåŸŸ -->
            <div class="w-full md:w-3/4 bg-gray-100 dark:bg-gray-800 rounded-lg px-1 py-4 md:p-4 shadow-md">
                <div class="">
                    <!-- æ¸¸æˆåŒºåŸŸï¼š4åˆ—13è¡Œå¸ƒå±€ -->
                    <div class="flex justify-center">
                        <div class="grid grid-cols-4 gap-2" style="width: fit-content">
                            <!-- è·¯å¾„æ ‡é¢˜ -->
                            <div class="bg-land text-white rounded px-2 py-1 text-center font-bold w-16 md:w-20 mx-auto flex items-center justify-center">é™†åœ°</div>
                            <div class="bg-ocean text-white rounded px-2 py-1 text-center font-bold w-16 md:w-20 mx-auto flex items-center justify-center">æµ·æ´‹</div>
                            <div class="bg-desert text-white rounded px-2 py-1 text-center font-bold w-16 md:w-20 mx-auto flex items-center justify-center">æ²™æ¼ </div>
                            <div class="bg-sky text-white rounded px-2 py-1 text-center font-bold w-16 md:w-20 mx-auto flex items-center justify-center">å¤©ç©º</div>
                            
                            <!-- æ¸¸æˆåŒºåŸŸæ ¼å­ -->
                            <div id="land-regions" class="flex flex-col gap-1">
                                <!-- é™†åœ°åŒºåŸŸå°†é€šè¿‡JSåŠ¨æ€ç”Ÿæˆ -->
                            </div>
                            <div id="ocean-regions" class="flex flex-col gap-1">
                                <!-- æµ·æ´‹åŒºåŸŸå°†é€šè¿‡JSåŠ¨æ€ç”Ÿæˆ -->
                            </div>
                            <div id="desert-regions" class="flex flex-col gap-1">
                                <!-- æ²™æ¼ åŒºåŸŸå°†é€šè¿‡JSåŠ¨æ€ç”Ÿæˆ -->
                            </div>
                            <div id="sky-regions" class="flex flex-col gap-1">
                                <!-- å¤©ç©ºåŒºåŸŸå°†é€šè¿‡JSåŠ¨æ€ç”Ÿæˆ -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- å³ä¾§ä¿¡æ¯å’Œæ“ä½œåŒº -->
            <div class="w-full md:w-1/4 flex flex-col gap-4">
                <!-- æ¸¸æˆæ¶ˆæ¯åŒº -->
                <div class="bg-gray-100 dark:bg-gray-800 rounded-lg p-3 shadow-md h-24 overflow-y-auto">
                    <h3 class="text-sm font-bold mb-1 text-gray-700 dark:text-gray-300" data-i18n="gameMessages">æ¸¸æˆæ¶ˆæ¯</h3>
                    <div id="game-message" class="text-sm"></div>
                </div>
                
                <!-- è¡ŒåŠ¨åŒº -->
                <div class="bg-gray-100 dark:bg-gray-800 rounded-lg p-3 shadow-md">
                    <h3 class="text-sm font-bold mb-2 text-gray-700 dark:text-gray-300" data-i18n="actions">è¡ŒåŠ¨</h3>
                    <div class="space-y-2">
                        <div class="text-sm mb-2 text-gray-600 dark:text-gray-400 text-center">
                            <p data-i18n="selectCardFirst">å…ˆé€‰æ‹©æ‰‹ç‰Œï¼Œå†ç‚¹å‡»åŒºåŸŸ</p>
                        </div>
                        <div class="text-xs text-gray-500 dark:text-gray-400 mt-2">
                            <ul class="list-disc list-inside">
                                <li>æ¢ç´¢éœ€è¦ç‚¹æ•°â‰¥æ ¼å­ç­‰çº§çš„å¡ç‰Œ</li>
                                <li>é»‘æ¡ƒæ¢ç´¢æ—¶ç‚¹æ•°ç¿»å€</li>
                                <li>çº¢æ¡ƒå é¢†æ—¶å¾—åˆ†æé«˜</li>
                                <li>æ‰‹ç‰Œä¸Šé™ï¼š<span id="rules-hand-limit">10</span>å¼  (äººå£å¥‡è§‚å¯æé«˜)</li>
                            </ul>
                        </div>
                    </div>
                </div>
                
                <!-- æ¸¸æˆæ—¥å¿— -->
                <div class="bg-gray-100 dark:bg-gray-800 rounded-lg p-3 shadow-md flex-grow overflow-y-auto">
                    <h3 class="text-sm font-bold mb-1 text-gray-700 dark:text-gray-300" data-i18n="gameLog">æ¸¸æˆæ—¥å¿—</h3>
                    <div id="game-log" class="text-xs space-y-1 h-40 overflow-y-auto"></div>
                </div>
            </div>
        </div>
        
        <!-- å½“å‰é€‰æ‹©çš„è¡ŒåŠ¨æç¤º -->
        <div id="action-info" class="text-center text-sm text-gray-600 dark:text-gray-400 h-6 mt-2 mb-20"></div>
        
        <!-- æµ®åŠ¨æ‰‹ç‰ŒåŒºåŸŸ -->
        <div class="fixed bottom-0 left-0 right-0 z-40 bg-white dark:bg-gray-900 border-t border-gray-200 dark:border-gray-700 shadow-lg">
            <div class="container mx-auto px-4 py-2 max-w-6xl">
                <!-- çŠ¶æ€ä¿¡æ¯è¡Œ -->
                <div class="flex justify-between items-center mb-1">
                    <div class="flex items-center space-x-2">
                        <div class="text-sm"><span>å¾—åˆ†</span>: <span id="float-score" class="text-primary font-bold">0</span></div>
                        <div class="text-sm border-l border-gray-300 dark:border-gray-700 pl-2"><span>å›åˆ</span>: <span id="float-turn">1</span></div>
                        <div class="text-sm border-l border-gray-300 dark:border-gray-700 pl-2"><span>ç‰Œå †</span>: <span id="float-deck">47</span></div>
                        <div class="text-sm border-l border-gray-300 dark:border-gray-700 pl-2"><span>å¼ƒç‰Œ</span>: <span id="float-discard">0</span></div>
                        <div class="text-sm border-l border-gray-300 dark:border-gray-700 pl-2 text-green-600 dark:text-green-400">
                            <span>æ¯å›åˆ</span>: <span id="float-points-per-turn">+0</span>
                        </div>
                        <div class="text-sm border-l border-gray-300 dark:border-gray-700 pl-2 text-yellow-600 dark:text-yellow-400">
                            <span>é¢„è®¡</span>: â‰ˆ<span id="estimated-score">0</span>
                        </div>
                    </div>
                    <div class="flex space-x-2">
                        <button id="discard-btn" class="bg-red-500 hover:bg-red-600 text-white py-1 px-3 rounded-lg text-sm flex items-center">
                            <span>å¼ƒç‰Œ</span>
                            <span class="ml-1 text-xs opacity-75">(<span id="selected-count">0</span>å¼ )</span>
                        </button>
                        <button id="end-turn-btn" class="bg-yellow-600 hover:bg-yellow-700 text-white py-1 px-3 rounded-lg text-sm">
                            <span data-i18n="endTurn">ç»“æŸå›åˆ</span>
                        </button>
                    </div>
                </div>
                
                <!-- æ‰‹ç‰ŒåŒºåŸŸ -->
                <div class="flex flex-col">
                    <h3 class="text-lg font-bold mb-1" data-i18n="yourHand">æ‚¨çš„æ‰‹ç‰Œ</h3>
                    <div id="hand-container" class="flex justify-center gap-2 flex-wrap p-2 bg-gray-100 dark:bg-gray-800 rounded-lg min-h-[120px] relative">
                        <!-- æ‰‹ç‰Œå°†åœ¨è¿™é‡ŒåŠ¨æ€ç”Ÿæˆ -->
                    </div>
                    <div class="text-xs text-right mt-1 text-gray-500 dark:text-gray-400">
                        æ‰‹ç‰Œ: <span id="hand-count">0</span>/<span id="hand-limit">10</span>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- å³ä¸‹è§’ä¿¡æ¯æ  -->
        <div class="fixed bottom-4 right-4 z-30">
            <div class="bg-gray-100 dark:bg-gray-800 rounded-lg p-2 shadow-md">
                <div class="flex items-center space-x-3">
                    <div class="font-bold text-sm"><span>å¾—åˆ†</span>: <span id="score-corner" class="text-primary">0</span></div>
                    <div class="text-sm"><span>å›åˆ</span>: <span id="turn-corner">1</span></div>
                </div>
                <div class="text-xs text-gray-600 dark:text-gray-400 flex space-x-2">
                    <div><span>ç‰Œå †</span>: <span id="remaining-corner">47</span></div>
                    <div><span>å¼ƒç‰Œ</span>: <span id="discard-corner">0</span></div>
                </div>
                <div class="text-xs mt-1 font-semibold text-green-600 dark:text-green-400">
                    <span>æ¯å›åˆ</span>: <span id="points-per-turn">+0</span>åˆ†
                </div>
            </div>
        </div>
        
        <!-- è·¯å¾„å¾æœæç¤ºå¼¹çª— -->
        <div id="conquest-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50">
            <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-lg max-w-md w-full mx-4 text-center transform scale-100 transition-transform duration-300">
                <h2 class="text-2xl font-bold mb-4 text-yellow-500 dark:text-yellow-400">å¾æœæˆå°±!</h2>
                <p id="conquest-message" class="text-lg mb-6"></p>
                <p class="mb-4 text-primary font-bold text-xl">+<span id="conquest-points">0</span>åˆ†</p>
                <button id="conquest-close" class="bg-primary hover:bg-indigo-700 text-white px-4 py-2 rounded-lg">
                    ç»§ç»­æ¸¸æˆ
                </button>
            </div>
        </div>
        
        <!-- æ¸¸æˆç»“æœå¼¹çª— -->
        <div id="result-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50">
            <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-lg max-w-md w-full mx-4">
                <h2 class="text-2xl font-bold mb-4 text-center" data-i18n="gameOver">æ¸¸æˆç»“æŸ</h2>
                <p class="text-lg mb-2"><span data-i18n="finalScore">æœ€ç»ˆå¾—åˆ†</span>: <span id="final-score" class="font-bold"></span></p>
                <p class="mb-4 text-sm text-gray-600 dark:text-gray-400" data-i18n="playAgainPrompt">å†æ¥ä¸€æ¬¡ï¼Œåˆ›å»ºæ›´å¼ºå¤§çš„æ–‡æ˜ï¼</p>
                <div class="flex flex-wrap justify-center gap-2">
                    <button id="play-again" class="bg-primary hover:bg-indigo-700 text-white px-4 py-2 rounded-lg" data-i18n="newGame">æ–°æ¸¸æˆ</button>
                    <button id="replay-same-seed" class="bg-yellow-500 hover:bg-yellow-600 text-white px-4 py-2 rounded-lg" data-i18n="replaySameSeed">é‡ç©æœ¬å±€</button>
                    <button id="share-result" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg" data-i18n="shareResult">åˆ†äº«æˆç»©</button>
                </div>
            </div>
        </div>
        
        <!-- å†å²æµè§ˆå™¨å¼¹çª— -->
        <div id="history-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50">
            <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-lg max-w-4xl w-full mx-4 max-h-[90vh] overflow-y-auto">
                <h2 class="text-xl font-bold mb-4 text-center" data-i18n="historyBrowser">å†å²æµè§ˆå™¨</h2>
                <div class="flex justify-between items-center mb-2">
                    <div class="text-sm">
                        <span data-i18n="turn">å›åˆ</span>: <span id="history-turn" class="font-bold">1</span> / 
                        <span data-i18n="move">æ“ä½œ</span>: <span id="history-index" class="font-bold">0</span> / <span id="history-total" class="font-bold">0</span>
                    </div>
                    <div class="text-sm">
                        <span data-i18n="score">å¾—åˆ†</span>: <span id="history-score" class="font-bold">0</span>
                    </div>
                </div>
                
                <!-- æµè§ˆæ§åˆ¶ -->
                <div class="flex justify-between items-center mb-3">
                    <button id="history-prev" class="bg-gray-200 dark:bg-gray-700 hover:bg-gray-300 dark:hover:bg-gray-600 text-gray-700 dark:text-gray-300 py-2 px-4 rounded-lg text-sm flex items-center">
                        <svg class="w-5 h-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
                        </svg>
                    </button>
                    <div class="text-center">
                        <span id="history-action-desc" class="text-sm"></span>
                    </div>
                    <button id="history-next" class="bg-gray-200 dark:bg-gray-700 hover:bg-gray-300 dark:hover:bg-gray-600 text-gray-700 dark:text-gray-300 py-2 px-4 rounded-lg text-sm flex items-center">
                        <svg class="w-5 h-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
                        </svg>
                    </button>
                </div>
                
                <!-- å†å²çŠ¶æ€æ˜¾ç¤º -->
                <div id="history-board" class="bg-white dark:bg-gray-900 rounded-lg p-1 md:p-2 mb-4">
                    <!-- å†å²çŠ¶æ€å°†åœ¨è¿™é‡ŒåŠ¨æ€æ˜¾ç¤º -->
                </div>
                
                <!-- å¯¼å‡ºæŒ‰é’® -->
                <div class="flex justify-center gap-2 mb-4">
                    <button id="export-html" class="bg-green-600 hover:bg-green-700 text-white px-3 py-1 rounded-lg text-sm flex items-center">
                        <svg class="w-4 h-4 mr-1" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" />
                        </svg>
                        <span>HTML</span>
                    </button>
                    <button id="export-txt" class="bg-blue-600 hover:bg-blue-700 text-white px-3 py-1 rounded-lg text-sm flex items-center">
                        <svg class="w-4 h-4 mr-1" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" />
                        </svg>
                        <span>TXT</span>
                    </button>
                </div>
                
                <!-- æ§åˆ¶æŒ‰é’® -->
                <div class="flex justify-center gap-3">
                    <button id="history-select" class="bg-primary hover:bg-indigo-700 text-white px-4 py-2 rounded-lg" data-i18n="selectThis">é€‰æ‹©æ­¤çŠ¶æ€</button>
                    <button id="history-cancel" class="bg-gray-200 dark:bg-gray-700 hover:bg-gray-300 dark:hover:bg-gray-600 text-gray-700 dark:text-gray-300 px-4 py-2 rounded-lg" data-i18n="cancel">å–æ¶ˆ</button>
                </div>
            </div>
        </div>
        
        <!-- æç¤ºå¼¹çª— -->
        <div id="toast" class="fixed bottom-4 left-1/2 transform -translate-x-1/2 bg-gray-800 text-white px-4 py-2 rounded-lg opacity-0 transition-opacity duration-300 z-50">
            <!-- æç¤ºå†…å®¹ -->
        </div>

        <script>
            // æ¸¸æˆå¸¸é‡
            const SUITS = ['heart', 'diamond', 'spade', 'club'];
            const SUIT_SYMBOLS = {
                'heart': 'â™¥',
                'diamond': 'â™¦',
                'spade': 'â™ ',
                'club': 'â™£'
            };
            const RANKS = ['A', '2', '3', '4', '5', '6', '7', '8', '9', '10', 'J', 'Q', 'K'];
            const RANK_VALUES = {
                'A': 14, '2': 2, '3': 3, '4': 4, '5': 5, '6': 6, '7': 7,
                '8': 8, '9': 9, '10': 10, 'J': 11, 'Q': 12, 'K': 13
            };
            
            // è·¯å¾„å®šä¹‰
            const PATHS = ['land', 'ocean', 'desert', 'sky'];
            const PATH_NAMES = {
                'land': 'é™†åœ°',
                'ocean': 'æµ·æ´‹',
                'desert': 'æ²™æ¼ ',
                'sky': 'å¤©ç©º'
            };
            
            // åŒºåŸŸç±»å‹
            const REGION_TYPES = {
                'standard': {
                    name: 'æ™®é€šåŒºåŸŸ',
                    color: 'explored',
                    explorePoints: 1,
                    occupyPoints: 1
                },
                'echo': {
                    name: 'å›å£°åŒºåŸŸ',
                    color: 'echo',
                    explorePoints: 1,
                    // occupyPointsåœ¨å é¢†æ—¶è®¡ç®—ï¼ˆ= ç‰Œå€¼ x 2ï¼‰
                },
                'wonder': {
                    name: 'å¥‡è§‚åŒºåŸŸ',
                    color: 'wonder',
                    explorePoints: 2,
                    // å¥‡è§‚æœ‰ç‰¹æ®Šå é¢†é€»è¾‘å’Œæ•ˆæœ
                },
                'combat': {
                    name: 'æˆ˜äº‰åŒºåŸŸ',
                    color: 'combat',
                    explorePoints: 2,
                    // æˆ˜äº‰åŒºåŸŸæœ‰ç‰¹æ®Šè§£é™¤é€»è¾‘å’Œæ•ˆæœ
                },
                'forgotten': {
                    name: 'é—å¿˜åŒºåŸŸ',
                    color: 'explored',
                    explorePoints: 1,
                    occupyPoints: 0  // é—å¿˜åŒºåŸŸå é¢†ä¸æä¾›åˆ†æ•°
                }
            };
            
            // å¥‡è§‚å¼ºåº¦çº§åˆ«
            const WONDER_TIERS = {
                'orange': { color: 'orange', name: 'æ©™çº§å¥‡è§‚', baseScore: 7, effectMultiplier: 3 },
                'purple': { color: 'purple', name: 'ç´«çº§å¥‡è§‚', baseScore: 5, effectMultiplier: 2 },
                'blue': { color: 'blue', name: 'è“çº§å¥‡è§‚', baseScore: 3, effectMultiplier: 1 }
            };
            
            // å¥‡è§‚åç§°åˆ—è¡¨ï¼ˆä¸ƒå¤§å¥‡è¿¹å’ŒSCPä¸ƒå¤§åœ°ç‚¹ï¼‰
            const WONDER_NAMES = [
                'äºšå†å±±å¤§æ¸¯ç¯å¡”', 'å·´æ¯”ä¼¦ç©ºä¸­èŠ±å›­', 'å¥¥æ—åŒ¹äºšå®™æ–¯åƒ', 
                'é˜¿å°”å¿’å¼¥æ–¯ç¥åº™', 'æ‘©ç´¢æ‹‰æ–¯é™µå¢“', 'ç½—å¾·å²›å¤ªé˜³ç¥å·¨åƒ', 
                'äºšå†å±±å¤§å›¾ä¹¦é¦†', 'é‡‘å­—å¡”', 'ä¸‡é‡Œé•¿åŸ', 'åŸƒè²å°”é“å¡”',
                'SCP-2000 å¤å…´', 'SCP-3000 æ·±æµ·å·¨è›‡', 'SCP-1000 è¿œå¤æ£®æ—',
                'SCP-2317 ç ´ç¢ä¹‹é—¨', 'SCP-3999 ç»ˆç„‰ä¹‹åœ°', 'SCP-4000 é—å¿˜æ£®æ—',
                'SCP-001 å®ˆé—¨äºº'
            ];
            
            // æˆ˜äº‰åŒºåŸŸåç§°åˆ—è¡¨ï¼ˆå¤ä»Šä¸­å¤–ç»å…¸æˆ˜äº‰ï¼‰
            const WAR_NAMES = [
                'ç‰¹æ´›ä¼Šæˆ˜äº‰', 'é©¬æ‹‰æ¾æˆ˜å½¹', 'æ¸©æ³‰å…³æˆ˜å½¹', 'è¨æ‹‰ç±³æ–¯æµ·æˆ˜', 
                'æ¥šæ±‰ä¹‹äº‰', 'èµ¤å£ä¹‹æˆ˜', 'å®˜æ¸¡ä¹‹æˆ˜', 'é•¿å¹³ä¹‹æˆ˜', 
                'åå­—å†›ä¸œå¾', 'ç™¾å¹´æˆ˜äº‰', 'ä¸‰åå¹´æˆ˜äº‰', 'æ‹¿ç ´ä»‘æˆ˜äº‰',
                'æ™®æ³•æˆ˜äº‰', 'åº“å›¾ä½å¤«æˆ˜å½¹', 'æ–¯å¤§æ—æ ¼å‹’æˆ˜å½¹', 'è¯ºæ›¼åº•ç™»é™†',
                'æœé²œæˆ˜äº‰', 'å¤ªå¹³æ´‹æˆ˜äº‰', 'çç æ¸¯äº‹ä»¶', 'æ²™ä¸˜ä¹‹æˆ˜'
            ];
            const COMBAT_CHECK_FUNCTIONS = {
                checkPair: cards => {
                    if (cards.length !== 2) return false;
                    const counts = {};
                    for (const card of cards) {
                        counts[card.rank] = (counts[card.rank] || 0) + 1;
                    }
                    return Object.values(counts).some(count => count >= 2);
                },
                checkAceAny: cards => cards.some(card => card.rank === 'A') && cards.length === 2,
                checkThreeKind: cards => findSameRankCards(cards, 3) && cards.length === 3,
                checkTwoPair: cards => {
                    if (cards.length !== 4) return false;
                    const counts = {};
                    for (const card of cards) {
                        counts[card.rank] = (counts[card.rank] || 0) + 1;
                    }
                    let pairCount = 0;
                    for (const rank in counts) {
                        if (counts[rank] >= 2) {
                            pairCount++;
                        }
                    }
                    return pairCount >= 2;
                },
                checkFlush: cards => {
                    if (cards.length !== 4) return false;
                    const suits = cards.map(card => card.suit);
                    const suitCounts = {};
                    for (const suit of suits) {
                        suitCounts[suit] = (suitCounts[suit] || 0) + 1;
                    }
                    return Object.values(suitCounts).some(count => count >= 4);
                },
                checkStraight: cards => {
                    if (cards.length !== 4) return false;
                    const values = cards.map(card => RANK_VALUES[card.rank]);
                    const uniqueValues = [...new Set(values)].sort((a, b) => a - b);
                    for (let i = 0; i <= uniqueValues.length - 4; i++) {
                        let isStraight = true;
                        for (let j = 0; j < 3; j++) {
                            if (uniqueValues[i + j + 1] !== uniqueValues[i + j] + 1) {
                                isStraight = false;
                                break;
                            }
                        }
                        if (isStraight) return true;
                    }
                    const hasAce = values.includes(14);
                    const has2 = values.includes(2);
                    const has3 = values.includes(3);
                    const has4 = values.includes(4);
                    if (hasAce && has2 && has3 && has4) {
                        return true;
                    }
                    return false;
                },
                checkFourKind: cards => findSameRankCards(cards, 4) && cards.length === 4
            };
            
            // æˆ˜äº‰åŒºåŸŸè§£é™¤ä»£ä»·ç±»å‹åŠå…¶æƒé‡
            const COMBAT_REQUIREMENTS = {
                'blue': [
                    {
                        type: 'pair', name: 'ä¸€å¯¹', display: 'ä»»æ„ä¸€å¯¹', weight: 2,
                        checkFnName: 'checkPair' // Store the key
                    },
                    {
                        type: 'ace_any', name: 'A+ä»»æ„ä¸€å¼ ç‰Œ', display: 'A+ä»»æ„ä¸€å¼ ç‰Œ', weight: 1,
                        checkFnName: 'checkAceAny' // Store the key
                    }
                ],
                'purple': [
                    {
                        type: 'three_kind', name: 'ä¸‰æ¡', display: 'ä¸‰å¼ ç›¸åŒç‚¹æ•°', weight: 2,
                        checkFnName: 'checkThreeKind' // Store the key
                    },
                    {
                        type: 'two_pair', name: 'ä¸¤å¯¹', display: 'ä¸¤å¯¹ä¸åŒç‚¹æ•°', weight: 2,
                        checkFnName: 'checkTwoPair' // Store the key
                    }
                ],
                'orange': [
                    {
                        type: 'flush', name: 'åŒèŠ±', display: 'å››å¼ åŒèŠ±è‰²', weight: 2,
                        checkFnName: 'checkFlush' // Store the key
                    },
                    {
                        type: 'straight', name: 'é¡ºå­', display: 'å››å¼ è¿ç»­ç‚¹æ•°', weight: 2,
                        checkFnName: 'checkStraight' // Store the key
                    },
                    {
                        type: 'four_kind', name: 'å››æ¡', display: 'å››å¼ ç›¸åŒç‚¹æ•°', weight: 1,
                        checkFnName: 'checkFourKind' // Store the key
                    }
                ]
            };
            

            // è¾…åŠ©å‡½æ•°ï¼šæ£€æŸ¥ç‰Œç»„ä¸­æ˜¯å¦æœ‰æŒ‡å®šæ•°é‡çš„åŒç‚¹æ•°ç‰Œ (è¿™ä¸ªå‡½æ•°æœ¬èº«æ˜¯æ­£ç¡®çš„)
            function findSameRankCards(cards, count) {
                const rankCounts = {};
                for (const card of cards) {
                    rankCounts[card.rank] = (rankCounts[card.rank] || 0) + 1;
                }
                return Object.values(rankCounts).some(c => c >= count);
            }
            
            // æˆ˜äº‰åŒºåŸŸä¸è§£é™¤çš„è´Ÿé¢æ•ˆæœç±»å‹åŠå…¶æƒé‡
           const COMBAT_EFFECTS = [
                {type: 'occupy_loss', name: 'æ²¦é™·', weight: 3,
                    description: 'ç§»é™¤æœ¬è·¯å¾„ä¸Š{count}å¼ å›åˆå¾—åˆ†æœ€é«˜çš„å é¢†å¡ï¼Œä¸åŒ…æ‹¬å¥‡è¿¹'},
                {type: 'wonder_loss', name: 'å¥‡è¿¹æ²¦é™·', weight: 2,
                    description: 'ä»ä¸Šå¾€ä¸‹ç§»é™¤æœ¬è·¯å¾„ä¸Š{count}å¼ å¥‡è¿¹çš„å é¢†å¡'},
                {type: 'income_loss', name: 'æ å¤º', weight: 2,
                    description: 'æœ¬å›åˆæŸå¤±è¯¥è·¯å¾„æ”¶å…¥çš„{multiplier}å€ (è“:3x, ç´«:5x, æ©™:10x)'}, // <-- ä¿®æ”¹è¿™é‡Œ
                {type: 'exploration_loss', name: 'æ¨¡å› å…¥ä¾µ', weight: 1,
                    description: 'ç›´æ¥æŠŠè¿™æ¡è·¯å¾„æœ€ä¸Šé¢{count}ä¸ªæ¢ç´¢/å é¢†åŒºåŸŸå˜ä¸ºæœªæ¢ç´¢çŠ¶æ€ï¼Œå¦‚æœ‰å é¢†ç‰Œç›´æ¥å¼ƒç‰Œ'},
                {type: 'area_loss', name: 'æœªæ¥ç ´å', weight: 1,
                    description: 'æŠŠè¿™å¼ å¡ä¸Šæ–¹çš„{count}ä¸ªæ ¼å­ç›´æ¥å˜ä¸ºé—å¿˜æ ¼å­'}
            ];
            
            // å¥‡è§‚æ•ˆæœç±»å‹åŠå…¶æƒé‡
            const WONDER_EFFECTS = [
                { type: 'draw', name: 'æŠ½å¡', weight: 4, description: 'æ¯å›åˆé¢å¤–æŠ½ç‰Œ' },
                { type: 'score', name: 'å¾—åˆ†', weight: 6, description: 'æ¯å›åˆé¢å¤–å¾—åˆ†' },
                { type: 'explore', name: 'æ¢ç´¢', weight: 2, description: 'å é¢†æ—¶é¢å¤–æ¢ç´¢è¯¥è·¯å¾„ä¸Šçš„æ ¼å­' },
                { type: 'population', name: 'äººå£', weight: 3, description: 'å¢åŠ æ‰‹ç‰Œä¸Šé™' },
                { type: 'heart_bonus', name: 'çº¢æ¡ƒæ”¶è·', weight: 2, description: 'è¯¥è·¯å¾„ä¸Šæ¯ä¸ªçº¢æ¡ƒå é¢†æ¯å›åˆ+2åˆ†' },
                { type: 'spade_bonus', name: 'é»‘æ¡ƒæ”¶è·', weight: 2, description: 'è¯¥è·¯å¾„ä¸Šæ¯ä¸ªé»‘æ¡ƒå é¢†æ¯å›åˆ+2åˆ†' },
                { type: 'diamond_bonus', name: 'æ–¹ç‰‡æ”¶è·', weight: 2, description: 'è¯¥è·¯å¾„ä¸Šæ¯ä¸ªæ–¹ç‰‡å é¢†æ¯å›åˆ+2åˆ†' },
                { type: 'club_bonus', name: 'æ¢…èŠ±æ”¶è·', weight: 2, description: 'è¯¥è·¯å¾„ä¸Šæ¯ä¸ªæ¢…èŠ±å é¢†æ¯å›åˆ+2åˆ†' }
            ];
            
            // å¤šè¯­è¨€æ”¯æŒ
            const LANGUAGES = {
                'zh-CN': {
                    name: 'ä¸­æ–‡',
                    gameTitle: 'æ–‡æ˜4Xæ‰‘å…‹',
                    gameDescription: 'æ¢ç´¢ã€æ‰©å¼ ã€å¼€å‘ã€å¾æœï¼ä½¿ç”¨æ‰‘å…‹ç‰Œå»ºç«‹æ‚¨çš„æ–‡æ˜',
                    score: 'å¾—åˆ†',
                    turn: 'å›åˆ',
                    remainingCards: 'å‰©ä½™ç‰Œæ•°',
                    randomSeed: 'éšæœºç§å­',
                    newGame: 'æ–°æ¸¸æˆ',
                    undo: 'æ’¤é”€',
                    history: 'å†å²',
                    gameMessages: 'æ¸¸æˆæ¶ˆæ¯',
                    actions: 'è¡ŒåŠ¨',
                    explore: 'æ¢ç´¢',
                    occupy: 'å é¢†',
                    endTurn: 'ç»“æŸå›åˆ',
                    gameLog: 'æ¸¸æˆæ—¥å¿—',
                    yourHand: 'æ‚¨çš„æ‰‹ç‰Œ',
                    gameOver: 'æ¸¸æˆç»“æŸ',
                    finalScore: 'æœ€ç»ˆå¾—åˆ†',
                    playAgainPrompt: 'å†æ¥ä¸€æ¬¡ï¼Œåˆ›å»ºæ›´å¼ºå¤§çš„æ–‡æ˜ï¼',
                    replaySameSeed: 'é‡ç©æœ¬å±€',
                    shareResult: 'åˆ†äº«æˆç»©',
                    historyBrowser: 'å†å²æµè§ˆå™¨',
                    selectThis: 'é€‰æ‹©æ­¤çŠ¶æ€',
                    cancel: 'å–æ¶ˆ',
                    move: 'æ“ä½œ',
                    copy: 'å¤åˆ¶',
                    share: 'åˆ†äº«',
                    copied: 'å·²å¤åˆ¶åˆ°å‰ªè´´æ¿',
                    shareText: 'æˆ‘åœ¨æ–‡æ˜4Xæ‰‘å…‹æ¸¸æˆä¸­è·å¾—äº†{score}åˆ†ï¼éšæœºç§å­:{seed}ï¼Œæ¥æŒ‘æˆ˜æˆ‘å§ï¼',
                    selectCard: 'è¯·é€‰æ‹©ä¸€å¼ æ‰‹ç‰Œ',
                    selectRegion: 'è¯·é€‰æ‹©ä¸€ä¸ªåŒºåŸŸ',
                    noValidRegion: 'æ²¡æœ‰æœ‰æ•ˆçš„åŒºåŸŸå¯ä»¥é€‰æ‹©',
                    exploreDone: 'æ¢ç´¢æˆåŠŸï¼è·å¾—{points}åˆ†',
                    occupyDone: 'å é¢†æˆåŠŸï¼æ¯å›åˆè·å¾—{points}åˆ†',
                    turnEnded: 'å›åˆç»“æŸï¼Œè·å¾—{points}åˆ†',
                    cardDrawn: 'æŠ½äº†ä¸€å¼ ç‰Œï¼š{rank}{suit}',
                    gameStart: 'æ¸¸æˆå¼€å§‹ï¼èµ·å§‹æ‰‹ç‰Œï¼š5å¼ ',
                    notEnoughRank: 'å¡ç‰Œç‚¹æ•°ä¸è¶³ä»¥æ¢ç´¢è¯¥åŒºåŸŸ',
                    alreadyOccupied: 'è¯¥åŒºåŸŸå·²è¢«å é¢†',
                    notExplored: 'è¯¥åŒºåŸŸå°šæœªæ¢ç´¢',
                    infoSelectCardToExplore: 'è¯·é€‰æ‹©ä¸€å¼ æ‰‹ç‰Œè¿›è¡Œæ¢ç´¢',
                    infoSelectCardToOccupy: 'è¯·é€‰æ‹©ä¸€å¼ æ‰‹ç‰Œè¿›è¡Œå é¢†',
                    pathLand: 'é™†åœ°',
                    pathOcean: 'æµ·æ´‹',
                    pathDesert: 'æ²™æ¼ ',
                    pathSky: 'å¤©ç©º',
                    standardRegion: 'æ™®é€šåŒºåŸŸ',
                    echoRegion: 'å›å£°åŒºåŸŸ',
                    exploredRegion: 'å·²æ¢ç´¢',
                    unexploredRegion: 'æœªæ¢ç´¢',
                    occupiedRegion: 'å·²å é¢†',
                    regionRank: 'åŒºåŸŸç­‰çº§',
                    scoreThisTurn: 'æœ¬å›åˆå¾—åˆ†',
                    totalScore: 'æ€»å¾—åˆ†',
                    extraPoints: 'é¢å¤–ç‚¹æ•°',
                    heartBonus: 'çº¢å¿ƒåŠ æˆ',
                    spadeBonus: 'é»‘æ¡ƒåŠ æˆ',
                    echoBonus: 'å›å£°åŠ æˆ',
                    exportSuccess: 'å¯¼å‡ºæˆåŠŸ',
                    forgottenRegion: 'é—å¿˜åŒºåŸŸ', // <-- Add this
                    clickToResolveCombat: 'ç‚¹å‡»è§£é™¤', // <-- Add this
                    combatEffectOccupyLoss: 'ç§»é™¤æœ¬è·¯å¾„ä¸Š{count}å¼ å›åˆå¾—åˆ†æœ€é«˜çš„å é¢†å¡ï¼Œä¸åŒ…æ‹¬å¥‡è¿¹',
                    combatEffectWonderLoss: 'ä»ä¸Šå¾€ä¸‹ç§»é™¤æœ¬è·¯å¾„ä¸Š{count}å¼ å¥‡è¿¹çš„å é¢†å¡',
                    combatEffectIncomeLoss: 'æœ¬å›åˆæŸå¤±è¯¥è·¯å¾„æ”¶å…¥çš„{multiplier}å€ (è“:3x, ç´«:5x, æ©™:10x)', // <-- ä¿®æ”¹è¿™é‡Œ
                    combatEffectExplorationLoss: 'ç›´æ¥æŠŠè¿™æ¡è·¯å¾„æœ€ä¸Šé¢{count}ä¸ªæ¢ç´¢/å é¢†åŒºåŸŸå˜ä¸ºæœªæ¢ç´¢çŠ¶æ€ï¼Œå¦‚æœ‰å é¢†ç‰Œç›´æ¥å¼ƒç‰Œ', // Clarified to include occupied
                    combatEffectAreaLoss: 'æŠŠè¿™å¼ å¡ä¸Šæ–¹çš„{count}ä¸ªæ ¼å­ç›´æ¥å˜ä¸ºé—å¿˜æ ¼å­',
                },
                'en': {
                    name: 'English',
                    gameTitle: 'Civilization 4X Poker',
                    gameDescription: 'Explore, Expand, Exploit, Exterminate! Build your civilization with poker cards',
                    score: 'Score',
                    turn: 'Turn',
                    remainingCards: 'Cards Left',
                    randomSeed: 'Random Seed',
                    newGame: 'New Game',
                    undo: 'Undo',
                    history: 'History',
                    gameMessages: 'Game Messages',
                    actions: 'Actions',
                    explore: 'Explore',
                    occupy: 'Occupy',
                    endTurn: 'End Turn',
                    gameLog: 'Game Log',
                    yourHand: 'Your Hand',
                    gameOver: 'Game Over',
                    finalScore: 'Final Score',
                    playAgainPrompt: 'Play again to build an even greater civilization!',
                    replaySameSeed: 'Replay Same Game',
                    shareResult: 'Share Result',
                    historyBrowser: 'History Browser',
                    selectThis: 'Select This State',
                    cancel: 'Cancel',
                    move: 'Move',
                    copy: 'Copy',
                    share: 'Share',
                    copied: 'Copied to clipboard',
                    shareText: 'I scored {score} points in Civilization 4X Poker! Random seed:{seed}, challenge me!',
                    selectCard: 'Please select a card from your hand',
                    selectRegion: 'Please select a region',
                    noValidRegion: 'No valid region to select',
                    exploreDone: 'Exploration successful! Gained {points} points',
                    occupyDone: 'Occupation successful! Gain {points} points per turn',
                    turnEnded: 'Turn ended, gained {points} points',
                    cardDrawn: 'Drew a card: {rank}{suit}',
                    gameStart: 'Game started! Initial hand: 5 cards',
                    notEnoughRank: 'Card rank not high enough to explore this region',
                    alreadyOccupied: 'This region is already occupied',
                    notExplored: 'This region is not explored yet',
                    infoSelectCardToExplore: 'Select a card to explore',
                    infoSelectCardToOccupy: 'Select a card to occupy',
                    pathLand: 'Land',
                    pathOcean: 'Ocean',
                    pathDesert: 'Desert',
                    pathSky: 'Sky',
                    standardRegion: 'Standard Region',
                    echoRegion: 'Echo Region',
                    exploredRegion: 'Explored',
                    unexploredRegion: 'Unexplored',
                    occupiedRegion: 'Occupied',
                    regionRank: 'Region Rank',
                    scoreThisTurn: 'Score this turn',
                    totalScore: 'Total score',
                    extraPoints: 'Extra points',
                    heartBonus: 'Heart bonus',
                    spadeBonus: 'Spade bonus',
                    echoBonus: 'Echo bonus',
                    exportSuccess: 'Export successful',
                    forgottenRegion: 'Forgotten Region', // <-- Add this
                    clickToResolveCombat: 'Click to Resolve', // <-- Add this
                    combatEffectOccupyLoss: 'Remove {count} highest scoring occupied cards on this path, excluding wonders',
                    combatEffectWonderLoss: 'Remove {count} occupied wonder cards from top down on this path',
                     combatEffectIncomeLoss: 'Lose {multiplier}x income from this path this turn (Blue:3x, Purple:5x, Orange:10x)', // <-- ä¿®æ”¹è¿™é‡Œ
                    combatEffectExplorationLoss: 'Revert top {count} explored/occupied regions on this path to unexplored, discarding occupied cards', // Clarified
                    combatEffectAreaLoss: 'Convert {count} regions above this card to forgotten regions',
                }
            };
            
            // æ¸¸æˆçŠ¶æ€
            let gameState = {
                deck: [],            // ç‰Œå †
                hand: [],            // æ‰‹ç‰Œ
                discardPile: [],     // å¼ƒç‰Œå †
                score: 0,            // æ€»åˆ†æ•°
                turn: 1,             // å½“å‰å›åˆ
                currentSeed: '',     // å½“å‰ç§å­
                selectedCards: [],   // å½“å‰é€‰æ‹©çš„æ‰‹ç‰Œç´¢å¼•æ•°ç»„ï¼ˆæ”¯æŒå¤šé€‰ï¼‰
                selectedAction: '',  // å½“å‰é€‰æ‹©çš„è¡ŒåŠ¨
                regions: {},         // æ¸¸æˆåŒºåŸŸçŠ¶æ€
                gameOver: false      // æ¸¸æˆæ˜¯å¦ç»“æŸ
            };
            
            // å†å²è®°å½•çŠ¶æ€
            let history = [];
            let currentHistoryIndex = -1;
            let currentBrowsingIndex = 0;
            
            // æ¸¸æˆæ—¥å¿—æ•°æ®
            let gameLogData = [];
            
            // å½“å‰è¯­è¨€
            let currentLanguage = 'zh-CN';
            
            // åˆå§‹åŒ–éšæœºæ•°ç”Ÿæˆå™¨
            let seededRandom = null;
            
            // DOMå…ƒç´ 
            const scoreDisplay = document.getElementById('score');
            const turnCounter = document.getElementById('turn-counter');
            const remainingCardsDisplay = document.getElementById('remaining-cards');
            const handContainer = document.getElementById('hand-container');
            const gameMessageElement = document.getElementById('game-message');
            const actionInfoElement = document.getElementById('action-info');
            const seedDisplay = document.getElementById('seed-display');
            const resultModal = document.getElementById('result-modal');
            const finalScoreDisplay = document.getElementById('final-score');
            const toastElement = document.getElementById('toast');
            const gameLogElement = document.getElementById('game-log');
            
            // éšæœºåŠ æƒé€‰æ‹©å‡½æ•°
            function weightedRandomSelect(items, weights) {
                const totalWeight = weights.reduce((sum, weight) => sum + weight, 0);
                let random = seededRandom() * totalWeight;
                
                for (let i = 0; i < items.length; i++) {
                    random -= weights[i];
                    if (random <= 0) {
                        return items[i];
                    }
                }
                
                // å¦‚æœå‡ºç°èˆå…¥è¯¯å·®ï¼Œè¿”å›æœ€åä¸€é¡¹
                return items[items.length - 1];
            }
            
            // åˆ›å»ºå¥‡è§‚
            function createWonder(rank) {
                // ä¸ºå¥‡è§‚é€‰æ‹©ä¸€ä¸ªéšæœºåç§°
                const wonderNameIndex = Math.floor(seededRandom() * WONDER_NAMES.length);
                const wonderName = WONDER_NAMES[wonderNameIndex];
                
                // æ ¹æ®ç­‰çº§ç¡®å®šå¥‡è§‚å¼ºåº¦ï¼Œæ˜ç¡®æŒ‡å®šä¸åŒç­‰çº§å¯¹åº”çš„å¥‡è§‚ç±»å‹
                let selectedTierKey;
                if (rank >= 12) {
                    // 12-13çº§: å¿…å®šæ˜¯æ©™è‰²å¥‡è§‚
                    selectedTierKey = 'orange';
                } else if (rank >= 9) {
                    // 9-11çº§: å¿…å®šæ˜¯ç´«è‰²å¥‡è§‚
                    selectedTierKey = 'purple';
                } else {
                    // 6-8çº§: å¿…å®šæ˜¯è“è‰²å¥‡è§‚
                    selectedTierKey = 'blue';
                }
                
                const tier = WONDER_TIERS[selectedTierKey];
                
                // é€‰æ‹©å¥‡è§‚æ•ˆæœ
                const effectWeights = WONDER_EFFECTS.map(effect => effect.weight);
                const selectedEffect = weightedRandomSelect(WONDER_EFFECTS, effectWeights);
                
                // å¦‚æœæ˜¯èŠ±è‰²æ”¶è·æ•ˆæœï¼Œç®€åŒ–åç§°æ˜¾ç¤º
                if (selectedEffect.type.includes('_bonus')) {
                    const suit = selectedEffect.type.split('_')[0];
                    selectedEffect.name = SUIT_SYMBOLS[suit];
                }
                
                // è®¾ç½®ç»Ÿä¸€çš„å é¢†æ¡ä»¶ - å¯ä»¥ä½¿ç”¨Jã€Qã€Kã€Aæˆ–è€…ä»»æ„çº¢å¿ƒ
                const occupyCondition = { 
                    type: 'multiple', 
                    display: 'Jã€Qã€Kã€Aæˆ–çº¢å¿ƒ'
                };
                
                return {
                    name: wonderName,
                    tier: selectedTierKey,
                    effect: selectedEffect,
                    occupyCondition: occupyCondition,
                    revealed: false // æœªæ¢ç´¢å‰ä¸æ˜¾ç¤ºå¥‡è§‚åç§°
                };
            }
            
            // æ£€æŸ¥å¡ç‰‡æ˜¯å¦æ»¡è¶³å¥‡è§‚çš„å é¢†æ¡ä»¶
            function cardMeetsWonderCondition(card, wonderData) {
                const condition = wonderData.occupyCondition;
                
                if (condition.type === 'rank') {
                    return card.rank === condition.rank;
                } else if (condition.type === 'suit') {
                    return card.suit === condition.suit;
                } else if (condition.type === 'multiple') {
                    // æ£€æŸ¥æ˜¯å¦æ˜¯Jã€Qã€Kã€Aæˆ–çº¢å¿ƒ
                    return card.rank === 'J' || 
                           card.rank === 'Q' || 
                           card.rank === 'K' || 
                           card.rank === 'A' || 
                           card.suit === 'heart';
                }
                
                return false;
            }
            
            // åˆ›å»ºæˆ˜äº‰åŒºåŸŸ
            function createCombatZone(rank) {
                // ä¸ºæˆ˜äº‰åŒºåŸŸé€‰æ‹©ä¸€ä¸ªéšæœºåç§°
                const warNameIndex = Math.floor(seededRandom() * WAR_NAMES.length);
                const warName = WAR_NAMES[warNameIndex];
                
                // æ ¹æ®ç­‰çº§ç¡®å®šæˆ˜äº‰åŒºåŸŸçš„å¼ºåº¦
                let selectedTierKey;
                if (rank >= 10) {
                    // 10-13çº§: æ©™è‰²æˆ˜äº‰åŒºåŸŸï¼ˆæœ€éš¾ï¼‰
                    selectedTierKey = 'orange';
                } else if (rank >= 7) {
                    // 7-9çº§: ç´«è‰²æˆ˜äº‰åŒºåŸŸï¼ˆä¸­ç­‰ï¼‰
                    selectedTierKey = 'purple';
                } else {
                    // 5-6çº§: è“è‰²æˆ˜äº‰åŒºåŸŸï¼ˆç®€å•ï¼‰
                    selectedTierKey = 'blue';
                }
                
                // é€‰æ‹©è§£é™¤è¦æ±‚
                const requirements = COMBAT_REQUIREMENTS[selectedTierKey];
                const reqWeights = requirements.map(req => req.weight);
                const selectedRequirement = weightedRandomSelect(requirements, reqWeights);
                
                // é€‰æ‹©ä¸è§£é™¤çš„æƒ©ç½šæ•ˆæœ
                const effectWeights = COMBAT_EFFECTS.map(effect => effect.weight);
                const selectedEffect = weightedRandomSelect(COMBAT_EFFECTS, effectWeights);
                
                // å¯¹äºæƒ©ç½šæ•ˆæœçš„ä¸¥é‡ç¨‹åº¦ï¼Œæ ¹æ®æˆ˜äº‰çº§åˆ«è®¾ç½®æ•°å€¼
                let effectSeverity;
                if (selectedTierKey === 'orange') {
                    effectSeverity = 3; // æœ€ä¸¥é‡
                } else if (selectedTierKey === 'purple') {
                    effectSeverity = 2; // ä¸­ç­‰
                } else {
                    effectSeverity = 1; // è½»å¾®
                }
                
                // å¯¹äºincome_lossï¼ˆæ å¤ºï¼‰æ•ˆæœï¼Œè®¾ç½®å…·ä½“çš„ç‚¹æ•°
                let lossPoints = 0;
                if (selectedEffect.type === 'income_loss') {
                    if (selectedTierKey === 'orange') {
                        lossPoints = 10;
                    } else if (selectedTierKey === 'purple') {
                        lossPoints = 5;
                    } else {
                        lossPoints = 3;
                    }
                }
                
                return {
                    name: warName,
                    tier: selectedTierKey,
                    requirement: selectedRequirement,
                    effect: {
                        ...selectedEffect,
                        severity: effectSeverity,
                        points: lossPoints
                    },
                    revealed: false, // æœªæ¢ç´¢å‰ä¸æ˜¾ç¤ºæˆ˜äº‰åŒºåŸŸè¯¦æƒ…
                    blocking: true   // é»˜è®¤é˜»ç¢è¿›ä¸€æ­¥æ¢ç´¢
                };
            }
            
            // æ£€æŸ¥å¡ç‰Œç»„åˆæ˜¯å¦æ»¡è¶³æˆ˜äº‰åŒºåŸŸè§£é™¤æ¡ä»¶çš„è¾…åŠ©å‡½æ•°
            function findSameRankCards(cards, count) {
                const rankCounts = {};
                
                for (const card of cards) {
                    rankCounts[card.rank] = (rankCounts[card.rank] || 0) + 1;
                }
                
                return Object.values(rankCounts).some(c => c >= count);
            }
            
            function getAllStandardCards() {
                const all = [];
                const allSuits = ['heart', 'diamond', 'spade', 'club']; // æ–¹ç‰‡è‡ªå·±ä¹Ÿå¯ä»¥æ˜¯æ›¿æ¢å€¼
                const allRanks = ['A', '2', '3', '4', '5', '6', '7', '8', '9', '10', 'J', 'Q', 'K'];

                for (const suit of allSuits) {
                    for (const rank of allRanks) {
                        all.push({ suit, rank });
                    }
                }
                return all;
            }

            // æ‰€æœ‰å¯èƒ½çš„æ ‡å‡†å¡ç‰Œï¼Œåªç”Ÿæˆä¸€æ¬¡
            const allPossibleStandardCards = getAllStandardCards();


            // é€’å½’å‡½æ•°ï¼šå°è¯•ä¸ºå½“å‰æ‰‹ç‰Œä¸­çš„æ–¹ç‰‡æŒ‡å®šå€¼
            // currentHand: å½“å‰æ­£åœ¨å°è¯•çš„ç‰Œç»„çŠ¶æ€ï¼ˆå…¶ä¸­æ–¹ç‰‡å¯èƒ½å·²è¢«æ›¿æ¢ï¼‰
            // diamondIndices: åŸå§‹æ‰‹ç‰Œä¸­æ‰€æœ‰æ–¹ç‰‡çš„ç´¢å¼•æ•°ç»„
            // currentIndexToAssign: diamondIndices ä¸­å½“å‰éœ€è¦å¤„ç†çš„æ–¹ç‰‡çš„ç´¢å¼•
            // checkFn: è¦æ£€æŸ¥çš„æ¨¡å¼å‡½æ•°
            function recursiveAssignDiamonds(currentHand, diamondIndices, currentIndexToAssign, checkFn) {
                // åŸºæœ¬æƒ…å†µï¼šæ‰€æœ‰æ–¹ç‰‡éƒ½å·²ç»æŒ‡å®šäº†å€¼
                if (currentIndexToAssign >= diamondIndices.length) {
                    // å¯¹æœ€ç»ˆå½¢æˆçš„ç‰Œç»„æ£€æŸ¥æ¨¡å¼
                    return checkFn(currentHand);
                }

                // è·å–å½“å‰è¦æŒ‡å®šå€¼çš„æ–¹ç‰‡åœ¨åŸå§‹æ‰‹ç‰Œä¸­çš„ç´¢å¼•
                const originalDiamondIndex = diamondIndices[currentIndexToAssign];

                // å°è¯•ä¸ºè¿™ä¸ªæ–¹ç‰‡æŒ‡å®šæ¯ä¸€ç§å¯èƒ½çš„æ ‡å‡†å¡ç‰Œå€¼
                for (const possibleCard of allPossibleStandardCards) {
                    // åˆ›å»ºä¸€ä¸ªæ–°ç‰Œç»„ï¼Œå°†å½“å‰æ–¹ç‰‡æ›¿æ¢ä¸º possibleCard
                    const nextHand = currentHand.map((card, idx) => {
                        return idx === originalDiamondIndex ? possibleCard : card;
                    });

                    // é€’å½’è°ƒç”¨ï¼Œå¤„ç†ä¸‹ä¸€ä¸ªæ–¹ç‰‡
                    if (recursiveAssignDiamonds(nextHand, diamondIndices, currentIndexToAssign + 1, checkFn)) {
                        return true; // å¦‚æœå‘ç°äº†ä»»ä½•ä¸€ä¸ªæœ‰æ•ˆçš„ç»„åˆï¼Œå°±è¿”å› true
                    }
                }

                // å¦‚æœä¸ºå½“å‰æ–¹ç‰‡å°è¯•äº†æ‰€æœ‰å¯èƒ½å€¼ï¼Œä½†éƒ½æ²¡æœ‰æ‰¾åˆ°æœ‰æ•ˆç»„åˆï¼Œåˆ™è¿”å› false
                return false;
            }

            // æ£€æŸ¥æ‰‹ç‰Œæ˜¯å¦æ»¡è¶³ç‰¹å®šæ¨¡å¼ï¼ˆè€ƒè™‘æ–¹ç‰‡é€šé…ç¬¦ï¼‰
            // cards: ç©å®¶å½“å‰é€‰æ‹©çš„æ‰‹ç‰Œæ•°ç»„ (Card å¯¹è±¡æ•°ç»„)
            // checkFn: ç”¨äºæ£€æŸ¥æ¨¡å¼çš„å‡½æ•°ï¼Œæ¥å—ä¸€ä¸ª Card å¯¹è±¡æ•°ç»„ä½œä¸ºå‚æ•°
            function hasPattern(cards, checkFn) {
                // æ‰¾åˆ°æ‰€æœ‰æ–¹ç‰‡åœ¨ä¼ å…¥çš„ cards æ•°ç»„ä¸­çš„ç´¢å¼•
                const diamondIndices = cards
                    .map((card, index) => ({ card, index }))
                    .filter(item => item.card.suit === 'diamond')
                    .map(item => item.index);

                // å¦‚æœæ²¡æœ‰æ–¹ç‰‡ï¼Œç›´æ¥æ£€æŸ¥æ¨¡å¼
                if (diamondIndices.length === 0) {
                    return checkFn(cards);
                }

                // å¦‚æœæœ‰æ–¹ç‰‡ï¼Œå¼€å§‹é€’å½’åˆ†é…å€¼å¹¶æ£€æŸ¥æ¨¡å¼
                return recursiveAssignDiamonds(cards, diamondIndices, 0, checkFn);
            }
            
            // åˆå§‹åŒ–æ¸¸æˆåŒºåŸŸ
            function initializeGameRegions() {
                // åˆå§‹åŒ–åŒºåŸŸæ•°æ®ç»“æ„
                gameState.regions = {};
                
                // ä¸ºæ¯æ¡è·¯å¾„åˆå§‹åŒ–åŒºåŸŸ
                for (const pathId of PATHS) {
                    gameState.regions[pathId] = Array(13).fill().map((_, index) => {
                        const rank = index + 1;
                        let type = 'standard';
                        let wonderData = null;
                        let combatData = null;
                        
                        // åŒºåŸŸç±»å‹çš„ç”Ÿæˆè§„åˆ™
                        
                        // 5-6çº§æœ‰æœºä¼šç”Ÿæˆæˆ˜äº‰åŒºåŸŸ
                        if (rank >= 5) {
                            // 100%æ¦‚ç‡ä¸ºæˆ˜äº‰åŒºåŸŸ, ç›®å‰è¿˜æ²¡æœ‰ç¾éš¾åŒºåŸŸ
                            const randomVal = seededRandom();
                            if (randomVal < 1) {
                                type = 'combat';
                                combatData = createCombatZone(rank);
                            }
                        }
                        // 7-8çº§åŒºåŸŸ
                        else if (rank >= 6 && rank <= 8) {
                            // 30%æ¦‚ç‡ä¸ºæˆ˜äº‰åŒºåŸŸ, 30%æ¦‚ç‡ä¸ºå¥‡è§‚, 20%æ¦‚ç‡ä¸ºå›å£°åŒºåŸŸ, 20%æ¦‚ç‡ä¸ºæ™®é€šåŒºåŸŸ
                            const randomVal = seededRandom();
                            if (randomVal < 0.3) {
                                type = 'combat';
                                combatData = createCombatZone(rank);
                            } else if (randomVal < 0.6) {
                                type = 'wonder';
                                wonderData = createWonder(rank);
                            } else if (randomVal < 0.8) {
                                type = 'echo';
                            }
                        }
                        // 9çº§åŠä»¥ä¸ŠåŒºåŸŸ
                        else if (rank >= 9) {
                            // 35%æ¦‚ç‡ä¸ºæˆ˜äº‰åŒºåŸŸ, 35%æ¦‚ç‡ä¸ºå¥‡è§‚, 20%æ¦‚ç‡ä¸ºå›å£°åŒºåŸŸ, 10%æ¦‚ç‡ä¸ºæ™®é€šåŒºåŸŸ
                            const randomVal = seededRandom();
                            if (randomVal < 0.35) {
                                type = 'combat';
                                combatData = createCombatZone(rank);
                            } else if (randomVal < 0.7) {
                                type = 'wonder';
                                wonderData = createWonder(rank);
                            } else if (randomVal < 0.9) {
                                type = 'echo';
                            }
                        }
                        // 1-4çº§åŒºåŸŸæŒ‰åŸæ¥é€»è¾‘å¤„ç†
                        else if (rank <= 4) {
                            // 20%æ¦‚ç‡ä¸ºå›å£°åŒºåŸŸ
                            if (seededRandom() < 0.2) {
                                type = 'echo';
                            }
                        }
                        
                        return {
                            pathId,              // è·¯å¾„ID
                            rank,                // åŒºåŸŸç­‰çº§ (1-13)
                            type,                // åŒºåŸŸç±»å‹
                            wonderData,          // å¥‡è§‚æ•°æ®ï¼ˆå¦‚æœæ˜¯å¥‡è§‚ï¼‰
                            combatData,          // æˆ˜äº‰åŒºåŸŸæ•°æ®ï¼ˆå¦‚æœæ˜¯æˆ˜äº‰åŒºåŸŸï¼‰
                            status: 'unexplored',// çŠ¶æ€: unexplored, explored, occupied
                            occupyCard: null,    // å é¢†çš„å¡ç‰Œ
                            points: 0            // æ¯å›åˆæä¾›çš„åˆ†æ•°
                        };
                    });
                    
                    // æ¸²æŸ“åŒºåŸŸ
                    const regionContainer = document.getElementById(`${pathId}-regions`);
                    regionContainer.innerHTML = '';
                    
                    // å€’åºæ¸²æŸ“åŒºåŸŸï¼ˆä»13åˆ°1ï¼‰ï¼Œæ˜¾ç¤ºæœ€é«˜ç­‰çº§(13)åœ¨é¡¶éƒ¨
                    for (let i = 12; i >= 0; i--) {
                        const region = gameState.regions[pathId][i];
                        const regionElement = document.createElement('div');
                        
                        // ä½¿ç”¨ä¸æ‰‹ç‰Œä¸€è‡´çš„å°ºå¯¸
                        regionElement.className = 'rounded-md w-16 h-24 md:w-20 md:h-30 border shadow-md flex flex-col items-center justify-center cursor-pointer relative';
                        
                        // æ ¹æ®åŒºåŸŸçŠ¶æ€è°ƒæ•´æ ·å¼
                        if (region.status === 'unexplored') {
                            regionElement.classList.add('bg-gray-400', 'dark:bg-gray-700');
                        } else if (region.status === 'explored') {
                            regionElement.classList.add('bg-white', 'dark:bg-gray-600');
                        } else if (region.status === 'occupied') {
                            regionElement.classList.add('bg-blue-100', 'dark:bg-blue-800');
                        }
                        
                        // å¦‚æœæ˜¯å›å£°åŒºåŸŸï¼Œæ·»åŠ ç‰¹æ®Šæ ·å¼
                        if (region.type === 'echo' && region.status !== 'occupied') {
                            regionElement.classList.add('bg-green-200', 'dark:bg-green-800');
                        }
                        
                        // å¦‚æœæ˜¯å¥‡è§‚åŒºåŸŸï¼Œæ·»åŠ ç‰¹æ®Šæ ·å¼
                        if (region.type === 'wonder' && region.wonderData) {
                            const tierClass = `wonder-${region.wonderData.tier}`;
                            regionElement.classList.add(tierClass);
                        }
                        
                        regionElement.dataset.path = pathId;
                        regionElement.dataset.rank = i + 1;
                        regionElement.dataset.type = region.type;
                        
                        // åŒºåŸŸç­‰çº§æ˜¾ç¤º
                        const rankElement = document.createElement('div');
                        rankElement.className = 'text-sm font-bold absolute top-1 left-1';
                        rankElement.textContent = i + 1; // ç›´æ¥æ˜¾ç¤ºæ•°å­—1-13
                        regionElement.appendChild(rankElement);
                        
                        // çŠ¶æ€æ ‡è¯†
                        const statusIndicator = document.createElement('div');
                        statusIndicator.className = 'absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 text-xs font-bold';
                        
                        if (region.status === 'unexplored') {
                            // æœªæ¢ç´¢çš„å¥‡è§‚æ˜¾ç¤ºä¸º???
                            if (region.type === 'wonder' || region.type === 'combat') {
                                statusIndicator.textContent = '???';
                                statusIndicator.className += ' text-white';
                            } else {
                                statusIndicator.textContent = 'æœªæ¢ç´¢';
                                statusIndicator.className += ' text-gray-100 dark:text-gray-300';
                            }
                        } else if (region.status === 'explored') {
                            statusIndicator.textContent = 'å¯å é¢†';
                            statusIndicator.className += ' text-green-600 dark:text-green-400';
                        }
                        
                        // åªæœ‰åœ¨éå é¢†çŠ¶æ€ä¸‹æ‰æ·»åŠ çŠ¶æ€æŒ‡ç¤ºå™¨
                        if (region.status !== 'occupied') {
                            regionElement.appendChild(statusIndicator);
                        }
                        
                        // åŒºåŸŸç±»å‹æŒ‡ç¤ºå™¨ï¼ˆå›å£°åŒºåŸŸï¼‰
                        if (region.type === 'echo' && region.status !== 'occupied') {
                            const typeIndicator = document.createElement('div');
                            typeIndicator.className = 'absolute top-1 right-1 w-2 h-2 rounded-full bg-green-400 dark:bg-green-300';
                            regionElement.appendChild(typeIndicator);
                        }
                        
                        // æ·»åŠ ç‚¹å‡»äº‹ä»¶
                        regionElement.addEventListener('click', () => handleRegionClick(pathId, i));
                        
                        regionContainer.appendChild(regionElement);
                    }
                }
            }

            // å°è¯•ä½¿ç”¨å½“å‰é€‰ä¸­çš„æ‰‹ç‰Œè§£é™¤æˆ˜äº‰åŒºåŸŸ
            function attemptResolveCombatWithCards(pathId, index) {
                const region = gameState.regions[pathId][index];

                if (region.type !== 'combat' || region.status !== 'explored' || !region.combatData) {
                    showMessage("è¿™ä¸æ˜¯ä¸€ä¸ªå¯ä»¥è§£é™¤çš„æˆ˜äº‰åŒºåŸŸ");
                    resetSelectionState();
                    return;
                }

                if (gameState.selectedCards.length === 0) {
                    showMessage('è¯·å…ˆé€‰æ‹©è¦ç”¨äºè§£é™¤æˆ˜äº‰çš„æ‰‹ç‰Œ');
                    return;
                }

                const selectedCards = gameState.selectedCards.map(idx => gameState.hand[idx]);
                const requirement = region.combatData.requirement;

                // Retrieve the check function using the stored name
                const checkFunction = COMBAT_CHECK_FUNCTIONS[requirement.checkFnName];

                if (typeof checkFunction !== 'function') {
                    console.error(`Error: Combat check function '${requirement.checkFnName}' not found or not a function for region ${pathId}-${index}`);
                    showMessage(`è§£é™¤å¤±è´¥ï¼šå†…éƒ¨é”™è¯¯ï¼Œæ— æ³•æ‰¾åˆ°æˆ˜äº‰è§£é™¤æ¡ä»¶`);
                    addLogEntry(`è§£é™¤å¤±è´¥: ${PATH_NAMES[pathId]} ${region.rank}çº§ã€Œ${region.combatData.name}ã€ï¼Œå†…éƒ¨æ¡ä»¶é”™è¯¯`);
                    resetSelectionState();
                    return;
                }


                if (hasPattern(selectedCards, checkFunction)) { // Pass the retrieved function
                    resolveCombatSuccessfully(pathId, index, gameState.selectedCards);
                } else {
                    showMessage(`è§£é™¤å¤±è´¥ï¼šé€‰ä¸­çš„æ‰‹ç‰Œä¸æ»¡è¶³æ¡ä»¶ "${requirement.display}"`);
                    addLogEntry(`è§£é™¤å¤±è´¥: ${PATH_NAMES[pathId]} ${region.rank}çº§ã€Œ${region.combatData.name}ã€ï¼Œé€‰ä¸­çš„ç‰Œä¸æ»¡è¶³æ¡ä»¶`);
                    resetSelectionState();
                }

                updateCornerInfo();
                addToHistory(saveGameState());
            }
            
            // æ£€æŸ¥åŒºåŸŸæ˜¯å¦å¯ä»¥è¢«æ¢ç´¢ï¼ˆå¿…é¡»ç›¸é‚»äºå·²æ¢ç´¢æˆ–å·²å é¢†åŒºåŸŸï¼‰
            function canExploreRegion(pathId, index) {
                // è·å–åŒä¸€è·¯å¾„ä¸­rankå€¼ä½1çš„åŒºåŸŸ
                const lowerRankIndex = index - 1;
                
                // å¦‚æœæ˜¯æœ€ä½ç­‰çº§(1)ï¼Œæ€»æ˜¯å¯ä»¥æ¢ç´¢
                if (index === 0) return true;
                
                // æ£€æŸ¥ä½ä¸€çº§åŒºåŸŸæ˜¯å¦å·²è¢«æ¢ç´¢æˆ–å é¢†
                if (lowerRankIndex >= 0) {
                    const lowerRegion = gameState.regions[pathId][lowerRankIndex];
                    if (lowerRegion.status === 'explored' || lowerRegion.status === 'occupied') {
                        return true;
                    }
                }
                
                return false;
            }

            // æ£€æŸ¥æ˜¯å¦æœ‰æˆ˜äº‰åŒºåŸŸé˜»ç¢æ›´é«˜çº§åŒºåŸŸçš„æ¢ç´¢
            function hasBlockingCombatZone(pathId, targetIndex) {
                // è·å–ç›®æ ‡åŒºåŸŸçš„ç­‰çº§
                const targetRank = targetIndex + 1;
                
                // æ£€æŸ¥è¯¥è·¯å¾„ä¸Šæ˜¯å¦æœ‰æˆ˜äº‰åŒºåŸŸé˜»å¡äº†æ›´é«˜çº§åŒºåŸŸçš„æ¢ç´¢
                for (let i = 0; i < targetIndex; i++) {
                    const region = gameState.regions[pathId][i];
                    // å¦‚æœæœ‰å·²æ¢ç´¢ä½†æœªè§£é™¤çš„æˆ˜äº‰åŒºåŸŸä¸”ä»åœ¨é˜»å¡ä¸­
                    if (region.status === 'explored' && 
                        region.type === 'combat' && 
                        region.combatData && 
                        region.combatData.blocking) {
                        return true;
                    }
                }
                return false;
            }
            

            
            // åœ¨æ ¼å­ä¸Šæ˜¾ç¤ºä¸´æ—¶é”™è¯¯æç¤º
            function showErrorOnRegion(regionElement, message) {
                // åˆ›å»ºé”™è¯¯æç¤ºå…ƒç´ 
                const errorTooltip = document.createElement('div');
                errorTooltip.className = 'absolute inset-0 bg-red-500 bg-opacity-80 flex items-center justify-center rounded-md z-10';
                errorTooltip.style.animation = 'fadeIn 0.2s ease-out';
                
                const textElement = document.createElement('div');
                textElement.className = 'text-white text-xs font-bold px-1 text-center';
                textElement.textContent = message;
                
                errorTooltip.appendChild(textElement);
                regionElement.appendChild(errorTooltip);
                
                // 2ç§’åè‡ªåŠ¨ç§»é™¤
                setTimeout(() => {
                    errorTooltip.style.animation = 'fadeOut 0.5s ease-out';
                    setTimeout(() => {
                        if (regionElement.contains(errorTooltip)) {
                            regionElement.removeChild(errorTooltip);
                        }
                    }, 500);
                }, 2000);
            }
            
            function handleRegionClick(pathId, index) {
                // è·å–åŒºåŸŸå…ƒç´ 
                const regionContainer = document.getElementById(`${pathId}-regions`);
                const displayIndex = 12 - index; // å€’åºæ¸²æŸ“çš„ç´¢å¼•
                const regionElement = regionContainer.children[displayIndex];

                const region = gameState.regions[pathId][index];

                // --- ä¿®æ”¹å¼€å§‹ ---
                // å¦‚æœæ˜¯å·²æ¢ç´¢çš„æˆ˜äº‰åŒºåŸŸ
                if (region.status === 'explored' && region.type === 'combat' && region.combatData) {
                    // å¦‚æœå·²ç»é€‰æ‹©äº†æ‰‹ç‰Œ (æ— è®ºæ˜¯å•é€‰è¿˜æ˜¯å¤šé€‰)
                    if (gameState.selectedCards.length > 0) {
                        // ç›´æ¥å°è¯•ä½¿ç”¨é€‰ä¸­çš„æ‰‹ç‰Œè§£é™¤æˆ˜äº‰
                        attemptResolveCombatWithCards(pathId, index);
                    } else {
                        // å¦‚æœæ²¡æœ‰é€‰æ‹©æ‰‹ç‰Œï¼Œæ˜¾ç¤ºè§£é™¤æˆ˜äº‰å¼¹çª—
                        showResolveCombatModal(pathId, index);
                    }
                    // å¤„ç†å®Œæˆ˜äº‰åŒºåŸŸç‚¹å‡»åï¼Œæ— è®ºå¦‚ä½•éƒ½è¿”å›ï¼Œä¸ç»§ç»­æ‰§è¡Œä¸‹é¢çš„æ¢ç´¢/å é¢†é€»è¾‘
                    return;
                }
                // --- ä¿®æ”¹ç»“æŸ ---


                // ä»¥ä¸‹æ˜¯åŸæœ‰çš„éæˆ˜äº‰åŒºåŸŸå¤„ç†é€»è¾‘

                // æ£€æŸ¥æ˜¯å¦é€‰æ‹©äº†æ‰‹ç‰Œ
                if (gameState.selectedCards.length === 0) {
                    showErrorOnRegion(regionElement, t('selectCard'));
                    showMessage(t('selectCard'));
                    return;
                }

                // ä»¥ä¸‹é€»è¾‘åªå…è®¸å•é€‰è¿›è¡Œæ¢ç´¢æˆ–å é¢†
                if (gameState.selectedCards.length > 1) {
                    // å¦‚æœä¸æ˜¯æˆ˜äº‰åŒºåŸŸï¼Œå¤šé€‰äº†å¡ç‰Œï¼Œè§†ä¸ºæ— æ•ˆæ“ä½œï¼Œæç¤ºç”¨æˆ·
                    showErrorOnRegion(regionElement, "æ­¤æ“ä½œåªèƒ½ä½¿ç”¨ä¸€å¼ ç‰Œ");
                    showMessage("æ¢ç´¢æˆ–å é¢†æ“ä½œåªèƒ½ä½¿ç”¨ä¸€å¼ ç‰Œï¼Œè¯·åªé€‰æ‹©ä¸€å¼ ");
                    resetSelectionState(); // å¤šé€‰åœ¨è¿™ç§æƒ…å†µä¸‹æ˜¯æ— æ•ˆçš„ï¼Œç›´æ¥é‡ç½®é€‰æ‹©
                    return;
                }


                // ä»¥ä¸‹æ˜¯å•é€‰å¡ç‰Œçš„æ¢ç´¢/å é¢†é€»è¾‘
                const cardIndex = gameState.selectedCards[0]; // åªå–ç¬¬ä¸€ä¸ªé€‰ä¸­çš„å¡ç‰Œ
                const card = gameState.hand[cardIndex];
                const cardRank = RANK_VALUES[card.rank];


                // è‡ªåŠ¨åˆ¤æ–­æ“ä½œç±»å‹
                if (region.status === 'unexplored') {
                    // æ¢ç´¢æ“ä½œ

                    // è®¡ç®—æœ‰æ•ˆç‚¹æ•°ï¼ˆé»‘æ¡ƒç¿»å€ï¼‰
                    let effectiveRank = cardRank;
                    if (card.suit === 'spade') {
                        effectiveRank = cardRank * 2;
                    }

                    // æ£€æŸ¥å¡ç‰Œç‚¹æ•°æ˜¯å¦è¶³å¤Ÿ
                    if (effectiveRank < region.rank) {
                        showErrorOnRegion(regionElement, t('notEnoughRank'));
                        showMessage(t('notEnoughRank'));
                        resetSelectionState(); // æ¢ç´¢å¤±è´¥ï¼Œé‡ç½®é€‰æ‹©
                        return;
                    }

                    // æ£€æŸ¥æ˜¯å¦å¯ä»¥æ¢ç´¢è¯¥åŒºåŸŸï¼ˆå¿…é¡»ç›¸é‚»äºå·²æ¢ç´¢åŒºåŸŸï¼‰
                    if (!canExploreRegion(pathId, index)) {
                        showErrorOnRegion(regionElement, 'åªèƒ½æ¢ç´¢ç›¸é‚»æ ¼å­');
                        showMessage('åªèƒ½æ¢ç´¢å·²æ¢ç´¢åŒºåŸŸç›¸é‚»çš„æ ¼å­');
                        resetSelectionState(); // æ¢ç´¢å¤±è´¥ï¼Œé‡ç½®é€‰æ‹©
                        return;
                    }

                    // æ£€æŸ¥æ˜¯å¦è¢«æˆ˜äº‰åŒºåŸŸé˜»å¡äº†æ›´é«˜çº§åŒºåŸŸçš„æ¢ç´¢
                    if (hasBlockingCombatZone(pathId, index)) {
                        showErrorOnRegion(regionElement, 'å¿…é¡»å…ˆè§£é™¤æˆ˜äº‰åŒºåŸŸ');
                        showMessage('æœ‰æˆ˜äº‰åŒºåŸŸé˜»ç¢äº†è¿›ä¸€æ­¥æ¢ç´¢ï¼Œè¯·å…ˆè§£é™¤æˆ˜äº‰');
                        resetSelectionState(); // æ¢ç´¢å¤±è´¥ï¼Œé‡ç½®é€‰æ‹©
                        return;
                    }

                    // æ‰§è¡Œæ¢ç´¢è¡ŒåŠ¨
                    exploreRegion(pathId, index); // exploreRegion å†…éƒ¨ä¼šå¤„ç†ç§»é™¤å¡ç‰Œã€æ›´æ–°çŠ¶æ€ã€æ—¥å¿—ã€é‡ç½®é€‰æ‹©ã€ä¿å­˜å†å²

                }
                else if (region.status === 'explored') {
                    // å é¢†æ“ä½œ (éæˆ˜äº‰åŒºåŸŸ)

                    // æ£€æŸ¥æ˜¯å¦æ˜¯é—å¿˜åŒºåŸŸï¼Œé—å¿˜åŒºåŸŸä¸èƒ½æ­£å¸¸å é¢†
                    /*
                    if (region.type === 'forgotten') {
                        showErrorOnRegion(regionElement, 'é—å¿˜åŒºåŸŸæ— æ³•å é¢†');
                        showMessage('é—å¿˜åŒºåŸŸæ— æ³•å é¢†');
                        resetSelectionState();
                        return;
                    }*/

                    // å é¢†åŒºåŸŸ
                    occupyRegion(pathId, index); // occupyRegion å†…éƒ¨ä¼šå¤„ç†ç§»é™¤å¡ç‰Œã€æ›´æ–°çŠ¶æ€ã€æ—¥å¿—ã€é‡ç½®é€‰æ‹©ã€ä¿å­˜å†å²

                }
                else if (region.status === 'occupied') {
                    // å·²è¢«å é¢†
                    showErrorOnRegion(regionElement, t('alreadyOccupied'));
                    showMessage(t('alreadyOccupied'));
                    resetSelectionState(); // å·²å é¢†åŒºåŸŸç‚¹å‡»æ˜¯æ— æ•ˆæ“ä½œï¼Œé‡ç½®é€‰æ‹©
                }
            }
            
            // æ˜¾ç¤ºè§£é™¤æˆ˜äº‰åŒºåŸŸå¼¹çª—
            function showResolveCombatModal(pathId, index) {
                const region = gameState.regions[pathId][index];

                // å¦‚æœä¸æ˜¯æˆ˜äº‰åŒºåŸŸæˆ–ä¸æ˜¯å·²æ¢ç´¢çŠ¶æ€ï¼Œç›´æ¥è¿”å›
                if (region.type !== 'combat' || region.status !== 'explored' || !region.combatData) {
                    return;
                }

                // åˆ›å»ºå¼¹çª—å…ƒç´  (modalOverlay, modalContent ç­‰) ... ä¿æŒä¸å˜
                // åˆ›å»ºå¼¹çª—å…ƒç´ 
                const modalOverlay = document.createElement('div');
                modalOverlay.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
                
                const modalContent = document.createElement('div');
                modalContent.className = 'bg-white dark:bg-gray-800 p-5 rounded-lg shadow-lg max-w-md w-full mx-4';
                
                // æˆ˜äº‰åŒºåŸŸä¿¡æ¯
                const combatTier = region.combatData.tier;
                const requirement = region.combatData.requirement;
                const effect = region.combatData.effect;

                // ... æˆ˜äº‰åŒºåŸŸä¿¡æ¯ (title, descriptionContainer) ... ä¿æŒä¸å˜
                // æ ‡é¢˜
                const title = document.createElement('h3');
                title.className = `text-xl font-bold mb-3 text-center ${combatTier === 'orange' ? 'text-orange-500' : combatTier === 'purple' ? 'text-purple-500' : 'text-blue-500'}`;
                title.textContent = `${region.combatData.name} (${PATH_NAMES[pathId]} ${region.rank}çº§)`;
                
                // æˆ˜äº‰åŒºåŸŸæè¿°
                const descriptionContainer = document.createElement('div');
                descriptionContainer.className = 'mb-4 p-3 bg-gray-100 dark:bg-gray-700 rounded';
                
                const requirementTitle = document.createElement('div');
                requirementTitle.className = 'font-bold mb-1';
                requirementTitle.textContent = 'è§£é™¤æ¡ä»¶:';
                
                const requirementDesc = document.createElement('div');
                requirementDesc.className = 'mb-2 text-sm';
                requirementDesc.textContent = requirement.display;
                
                const effectTitle = document.createElement('div');
                effectTitle.className = 'font-bold mb-1';
                effectTitle.textContent = 'æœªè§£é™¤æ•ˆæœ:';
                
                const effectDesc = document.createElement('div');
                effectDesc.className = 'text-sm text-red-500 dark:text-red-400';
                
                // æ›¿æ¢æ•ˆæœæè¿°ä¸­çš„å‚æ•°
                let effectDescription = effect.description;
                if (effect.type === 'income_loss') {
                    effectDescription = effectDescription.replace('{points}', effect.points);
                } else {
                    effectDescription = effectDescription.replace('{count}', effect.severity);
                }
                
                effectDesc.textContent = effectDescription;
                
                descriptionContainer.appendChild(requirementTitle);
                descriptionContainer.appendChild(requirementDesc);
                descriptionContainer.appendChild(effectTitle);
                descriptionContainer.appendChild(effectDesc);

                // é€‰æ‹©åŒºåŸŸå®¹å™¨
                const selectionContainer = document.createElement('div');
                selectionContainer.className = 'mb-4';

                const selectionTitle = document.createElement('div');
                selectionTitle.className = 'font-bold mb-2';
                selectionTitle.textContent = 'é€‰æ‹©è§£é™¤æ–¹å¼:';

                // ä½¿ç”¨å¤šé€‰æ‰‹ç‰Œè§£é™¤çš„é€‰é¡¹
                const resolveButton = document.createElement('button');
                resolveButton.className = 'bg-primary hover:bg-indigo-700 text-white px-4 py-2 rounded-lg w-full mb-2';
                resolveButton.textContent = `ä½¿ç”¨æ‰‹ç‰Œè§£é™¤ (${region.combatData.requirement.display})`; // æ˜¾ç¤ºå…·ä½“æ¡ä»¶
                resolveButton.addEventListener('click', () => {
                    // å…³é—­å¼¹çª—
                    document.body.removeChild(modalOverlay);
                    // è°ƒç”¨æ–°çš„ç»Ÿä¸€å°è¯•è§£é™¤å‡½æ•°
                    attemptResolveCombatWithCards(pathId, index);
                    // æ³¨æ„ï¼šattemptResolveCombatWithCards ä¼šå¤„ç†æˆåŠŸ/å¤±è´¥ã€æ—¥å¿—ã€é‡ç½®é€‰æ‹©ã€æ›´æ–°UIå’Œä¿å­˜å†å²
                });

                // æ¥å—è´Ÿé¢æ•ˆæœå¹¶ç»“æŸå›åˆçš„é€‰é¡¹
                const acceptEffectButton = document.createElement('button');
                acceptEffectButton.className = 'bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded-lg w-full mb-4';
                acceptEffectButton.textContent = 'æ¥å—æ•ˆæœå¹¶ç»“æŸå›åˆ';
                acceptEffectButton.addEventListener('click', () => {
                    // å…³é—­å¼¹çª—
                    document.body.removeChild(modalOverlay);
                    // ç©å®¶ä¸»åŠ¨é€‰æ‹©æ¥å—æƒ©ç½šï¼Œç«‹å³ç»“æŸå›åˆã€‚endTurn å‡½æ•°ä¼šè‡ªåŠ¨æ£€æµ‹åˆ°è¿™ä¸ªæœªè§£é™¤çš„æˆ˜äº‰åŒºåŸŸå¹¶åº”ç”¨æƒ©ç½šã€‚
                    endTurn();
                    // endTurn å‡½æ•°ä¼šå¤„ç†æƒ©ç½šã€åŒºåŸŸçŠ¶æ€ã€æ—¥å¿—ã€æŠ½ç‰Œã€æ›´æ–°UIå’Œä¿å­˜å†å²
                });


                selectionContainer.appendChild(selectionTitle);
                selectionContainer.appendChild(resolveButton);
                selectionContainer.appendChild(acceptEffectButton);

                // å–æ¶ˆæŒ‰é’®
                const cancelButton = document.createElement('button');
                cancelButton.className = 'bg-gray-200 dark:bg-gray-700 hover:bg-gray-300 dark:hover:bg-gray-600 text-gray-700 dark:text-gray-300 px-4 py-2 rounded-lg w-full';
                cancelButton.textContent = 'å–æ¶ˆ';
                cancelButton.addEventListener('click', () => {
                    document.body.removeChild(modalOverlay);
                    // å–æ¶ˆå¼¹çª—ä¸è¿›è¡Œä»»ä½•æ¸¸æˆæ“ä½œï¼Œä¸å½±å“å½“å‰é€‰æ‹©çŠ¶æ€
                });

                
                // ç»„è£…å¼¹çª—
                modalContent.appendChild(title);
                modalContent.appendChild(descriptionContainer);
                modalContent.appendChild(selectionContainer);
                modalContent.appendChild(cancelButton);
                
                modalOverlay.appendChild(modalContent);
                document.body.appendChild(modalOverlay);
            }
            
            function resolveCombatSuccessfully(pathId, index, usedCardIndices) { // <-- ç¡®ä¿è¿™é‡Œæœ‰ usedCardIndices å‚æ•°
                const region = gameState.regions[pathId][index];

                // å°†æˆ˜äº‰åŒºåŸŸè½¬å˜ä¸ºå›å£°åŒºåŸŸ
                region.type = 'echo';
                region.combatData.blocking = false;  // è§£é™¤é˜»å¡
                region.combatData = null; // è§£é™¤åæ¸…é™¤æˆ˜äº‰æ•°æ®
                region.wonderData = null; // ç¡®ä¿ç±»å‹æ˜¯å›å£°ï¼Œä¸æ˜¯å¥‡è§‚
                region.wonderEffect = null; // æ¸…é™¤å¯èƒ½æ®‹ç•™çš„å¥‡è§‚æ•ˆæœ

                // å°†ç”¨äºè§£é™¤çš„å¡ç‰ŒåŠ å…¥å¼ƒç‰Œå †å¹¶ä»æ‰‹ç‰Œä¸­ç§»é™¤
                // æŒ‰ç…§ç´¢å¼•ä»å¤§åˆ°å°æ’åºï¼Œä»¥ä¾¿ splice æ“ä½œä¸ä¼šå½±å“åç»­ç´¢å¼•
                const indicesToRemove = [...usedCardIndices].sort((a, b) => b - a); // <-- è¿™é‡Œç°åœ¨ä½¿ç”¨ usedCardIndices

                 for (const cardIndex of indicesToRemove) {
                    const card = gameState.hand[cardIndex]; // åœ¨ splice ç§»é™¤ä¹‹å‰è·å–å¡ç‰Œ

                    // å°†å¡ç‰ŒåŠ å…¥å¼ƒç‰Œå †
                    gameState.discardPile.push(card);

                    // ä»æ‰‹ç‰Œä¸­ç§»é™¤
                    gameState.hand[cardIndex] = -1;
                }

                gameState.hand = gameState.hand.filter(card => card !== -1); // è¿‡æ»¤æ‰ -1ï¼Œç§»é™¤ç©ºä½
                // æ›´æ–°å¼ƒç‰Œå †è®¡æ•°
                updateDiscardCount();

                // æ›´æ–°åŒºåŸŸæ˜¾ç¤º (æ›´æ–°è§£é™¤åçš„åŒºåŸŸ)
                updateRegionDisplay(pathId, index);

                // è®°å½•æ“ä½œ (å¦‚æœæ—¥å¿—æ²¡æœ‰åœ¨ attemptResolveCombatWithCards ä¸­è¯¦ç»†è®°å½•çš„è¯ï¼Œå¯ä»¥åœ¨è¿™é‡Œè¡¥å……)
                // addLogEntry(`è§£é™¤æˆ˜äº‰æˆåŠŸ: ${PATH_NAMES[pathId]} ${region.rank}çº§`); // ç¤ºä¾‹ç²¾ç®€æ—¥å¿—

                // æ˜¾ç¤ºæˆåŠŸæ¶ˆæ¯
                showMessage(`æˆåŠŸè§£é™¤æˆ˜äº‰åŒºåŸŸï¼åŒºåŸŸå˜ä¸ºå›å£°åŒºåŸŸ`);

                // é‡ç½®é€‰æ‹©çŠ¶æ€ (æ¸…é™¤ gameState.selectedCards)
                resetSelectionState();

                // é‡æ–°æ¸²æŸ“æ‰‹ç‰Œ (å› ä¸ºæ‰‹ç‰Œæ•°é‡å˜åŒ–äº†)
                renderHand();

                // æ›´æ–°å³ä¸‹è§’ä¿¡æ¯æ  (æ‰‹ç‰Œ/å¼ƒç‰Œæ•°é‡å˜åŒ–)
                updateCornerInfo();

                // æ›´æ–°æ‰€æœ‰èŠ±è‰²æ”¶è·å¥‡è§‚çš„å¾—åˆ† (å› ä¸ºå¼ƒç‰Œå¯èƒ½å½±å“èŠ±è‰²æ•°é‡)
                updateAllSuitBonusWonders();

                // ä¿å­˜æ¸¸æˆçŠ¶æ€åˆ°å†å²è®°å½•
                addToHistory(saveGameState());
            }
            
            // å¤„ç†æ¥å—æˆ˜äº‰åŒºåŸŸè´Ÿé¢æ•ˆæœå¹¶è§£é™¤æˆ˜äº‰åŒºåŸŸ
            function resolveCombatWithPenalty(pathId, index) {
                const region = gameState.regions[pathId][index];
                // Preserve combat data for logging before clearing it
                const originalCombatData = region.combatData;
                const effect = originalCombatData.effect;

                // åº”ç”¨è´Ÿé¢æ•ˆæœ (è¿™å¯èƒ½ä¼šæ”¹å˜å…¶ä»–åŒºåŸŸçš„çŠ¶æ€ï¼Œå¯¹äº exploration_loss å¯èƒ½ä¼šå°†æ­¤åŒºåŸŸæœ¬èº«ä¹Ÿæ”¹å› unexplored)
                applyNegativeEffect(pathId, index, effect);


                // --- æœ€ç»ˆç¡®å®šè§¦å‘æ­¤æƒ©ç½šçš„æˆ˜äº‰åŒºåŸŸ (index) çš„çŠ¶æ€ ---
                region.type = 'forgotten'; // å§‹ç»ˆå˜ä¸ºé—å¿˜ç±»å‹
                region.combatData = null;   // æ¸…é™¤æˆ˜äº‰æ•°æ®
                region.wonderData = null;   // æ¸…é™¤å¥‡è§‚æ•°æ®
                region.wonderEffect = null; // æ¸…é™¤å¥‡è§‚æ•ˆæœ
                region.points = 0;          // é—å¿˜åŒºåŸŸå¾—åˆ†0

                // æ ¹æ®æ•ˆæœç±»å‹è®¾ç½®æœ€ç»ˆçŠ¶æ€
                if (effect.type === 'exploration_loss') {
                    // å¦‚æœæ˜¯æ¨¡å› å…¥ä¾µï¼Œæœ€ç»ˆçŠ¶æ€æ˜¯æœªæ¢ç´¢
                    region.status = 'unexplored';
                } else {
                    // å…¶ä»–æ•ˆæœï¼Œæœ€ç»ˆçŠ¶æ€æ˜¯å·²æ¢ç´¢
                    region.status = 'explored';
                }

                region.blocking = false; // å§‹ç»ˆè§£é™¤å¯¹åç»­æ ¼å­çš„é˜»ç¢

                // æ›´æ–°åŒºåŸŸæ˜¾ç¤º (æ›´æ–°è§¦å‘åŒºåŸŸ)
                updateRegionDisplay(pathId, index);

                // è®°å½•åˆ°æ¸¸æˆæ—¥å¿—
                let effectDescForLog = effect.description.replace('{count}', effect.severity).replace('{points}', effect.points);
                // Use originalCombatData for name in log if available
                addLogEntry(`æ¥å—æˆ˜äº‰æ•ˆæœ: ${PATH_NAMES[pathId]} ${region.rank}çº§ã€Œ${originalCombatData ? originalCombatData.name : 'æˆ˜äº‰åŒºåŸŸ'}ã€ï¼ŒåŒºåŸŸå˜ä¸ºé—å¿˜ï¼ˆ${region.status === 'unexplored' ? 'æœªæ¢ç´¢' : 'å·²æ¢ç´¢'}ï¼‰ï¼Œå—åˆ°è´Ÿé¢æ•ˆæœï¼š${effectDescForLog}`);

                // Note: updateAllSuitBonusWonders is handled by effect functions if needed or at the end of endTurn.
            }
            
            // åº”ç”¨æˆ˜äº‰åŒºåŸŸçš„è´Ÿé¢æ•ˆæœ
            function applyNegativeEffect(pathId, index, effect) {
                const severity = effect.severity; // æ•ˆæœä¸¥é‡ç¨‹åº¦ï¼ˆæ•°é‡ï¼‰

                switch(effect.type) {
                    case 'occupy_loss':
                        removeHighestScoringOccupations(pathId, severity, false);
                        break;

                    case 'wonder_loss':
                        removeHighestScoringOccupations(pathId, severity, true);
                        break;

                    case 'income_loss':
                        // æ ¹æ®ä¸¥é‡ç¨‹åº¦ç¡®å®šæ å¤ºçš„å€ç‡
                        let pillageMultiplier;
                        if (severity === 3) pillageMultiplier = 10; // æ©™çº§
                        else if (severity === 2) pillageMultiplier = 5; // ç´«çº§
                        else pillageMultiplier = 3; // è“çº§ (severity 1)

                        // è®°å½•æ å¤ºæƒ©ç½šå€ç‡
                        recordPillagePenalty(pathId, pillageMultiplier);
                        // å®é™…æ‰£åˆ†åœ¨ endTurn ä¸­ç»“ç®—
                        break;

                    case 'exploration_loss':
                        revertTopExploredRegions(pathId, severity);
                        break;

                    case 'area_loss':
                        convertToForgottenRegions(pathId, index, severity);
                        break;
                }
            }
            
            // ç§»é™¤è·¯å¾„ä¸Šå¾—åˆ†æœ€é«˜çš„Nä¸ªå é¢†åŒºåŸŸ
           
            // ç§»é™¤è·¯å¾„ä¸Šå¾—åˆ†æœ€é«˜çš„Nä¸ªå é¢†åŒºåŸŸï¼ˆä¸åŒ…æ‹¬å¥‡è§‚ï¼Œæˆ–åªåŒ…æ‹¬å¥‡è§‚ï¼‰
            function removeHighestScoringOccupations(pathId, count, wondersOnly) {
                // è·å–è¯¥è·¯å¾„çš„æ‰€æœ‰å·²å é¢†åŒºåŸŸ (æ ¹æ® wondersOnly è¿‡æ»¤)
                const occupiedRegions = [];
                for (let i = 0; i < gameState.regions[pathId].length; i++) {
                    const region = gameState.regions[pathId][i];
                    if (region.status === 'occupied') {
                        if ((wondersOnly && region.type === 'wonder') ||
                            (!wondersOnly && region.type !== 'wonder' && region.type !== 'forgotten')) { // é—å¿˜åŒºåŸŸä¹Ÿä¸èƒ½è¢«æ™®é€šæ²¦é™·ç§»é™¤
                            occupiedRegions.push({index: i, region, points: region.points});
                        }
                    }
                }

                // æŒ‰å¾—åˆ†ä»é«˜åˆ°ä½æ’åº
                occupiedRegions.sort((a, b) => b.points - a.points);

                // ç¡®å®šå®é™…ç§»é™¤æ•°é‡
                const actualCount = Math.min(count, occupiedRegions.length);
                const removedRegions = [];

                // ç§»é™¤åŒºåŸŸå¹¶åŠ å…¥å¼ƒç‰Œå †
                for (let i = 0; i < actualCount; i++) {
                    const { index, region } = occupiedRegions[i];

                    let regionInfo = `${PATH_NAMES[pathId]} ${region.rank}`;
                    if (region.type === 'wonder' && region.wonderData) regionInfo += ` å¥‡è§‚ã€Œ${region.wonderData.name}ã€`;
                    removedRegions.push(`${regionInfo} (${region.points}åˆ†/å›åˆ)`);

                    if (region.occupyCard) {
                        gameState.discardPile.push(region.occupyCard);
                    }

                    // é‡ç½®åŒºåŸŸçŠ¶æ€ä¸ºå·²æ¢ç´¢
                    region.status = 'explored'; // å˜ä¸ºå¯é‡æ–°å é¢†
                    region.occupyCard = null;
                    region.points = 0;

                    if (region.type === 'wonder' && region.wonderEffect) {
                        region.wonderEffect = null; // ç§»é™¤å¥‡è§‚æ•ˆæœ
                    }

                    updateRegionDisplay(pathId, index);
                }

                // --- æ–°å¢ï¼šå¦‚æœç§»é™¤æ•°é‡ä¸è¶³ï¼Œåº”ç”¨ç½šåˆ† ---
                const deficit = count - actualCount;
                if (deficit > 0) {
                    const penalty = deficit * 100;
                    gameState.score -= penalty;
                    scoreDisplay.textContent = gameState.score; // æ›´æ–°UIå¾—åˆ†
                    updateCornerInfo(); // æ›´æ–°æ‰€æœ‰ä¿¡æ¯
                    addLogEntry(`ã€Œ${wondersOnly ? 'å¥‡è¿¹æ²¦é™·' : 'æ²¦é™·'}ã€æ•ˆæœ: ç§»é™¤äº†${actualCount}ä¸ªå é¢†åŒºåŸŸï¼Œç¼ºå°‘${deficit}ä¸ªï¼Œæ¯ç¼ºå°‘ä¸€ä¸ªæŸå¤±100åˆ†ï¼Œæ€»æŸå¤±${penalty}åˆ†`);
                }
                // --- æ–°å¢ç»“æŸ ---

                // æ›´æ–°å¼ƒç‰Œå †è®¡æ•°
                updateDiscardCount();

                // è®°å½•åˆ°æ¸¸æˆæ—¥å¿—
                if (removedRegions.length > 0) {
                    addLogEntry(`ã€Œ${wondersOnly ? 'å¥‡è¿¹æ²¦é™·' : 'æ²¦é™·'}ã€æ•ˆæœ: ${removedRegions.join(', ')} è¢«ç§»é™¤`);
                } else if (deficit === 0) { // å¦‚æœå®é™…ç§»é™¤ä¸º0ä½†ä¸éœ€è¦ç½šåˆ†ï¼Œè¯´æ˜æ²¡æœ‰æ»¡è¶³æ¡ä»¶çš„åŒºåŸŸ
                    addLogEntry(`æ— æ³•æ‰§è¡Œã€Œ${wondersOnly ? 'å¥‡è¿¹æ²¦é™·' : 'æ²¦é™·'}ã€æ•ˆæœï¼š${PATH_NAMES[pathId]}ä¸Šæ²¡æœ‰${wondersOnly ? 'å¥‡è§‚' : 'æ™®é€š'}å é¢†åŒºåŸŸ`);
                }


                // æ›´æ–°æ‰€æœ‰èŠ±è‰²æ”¶è·å¥‡è§‚çš„å¾—åˆ† (å› ä¸ºå é¢†å¡è¢«ç§»é™¤äº†)
                updateAllSuitBonusWonders();
            }

            // è®°å½•æ å¤ºæƒ©ç½šçš„å€ç‡ï¼Œå°†åœ¨å›åˆç»“æŸæ—¶ç»“ç®—
            function recordPillagePenalty(pathId, multiplier) {
                if (!gameState.pillagePenalties) {
                    gameState.pillagePenalties = {};
                }
                if (!gameState.pillagePenalties[pathId]) {
                    gameState.pillagePenalties[pathId] = [];
                }
                // æ·»åŠ å½“å‰å€ç‡åˆ°è¯¥è·¯å¾„çš„å€ç‡åˆ—è¡¨
                gameState.pillagePenalties[pathId].push(multiplier);

                // è®°å½•æ—¥å¿—ï¼Œæç¤ºæƒ©ç½šå·²è§¦å‘ï¼Œä½†æœªç»“ç®—
                addLogEntry(`ã€Œæ å¤ºã€æ•ˆæœè§¦å‘: ${PATH_NAMES[pathId]}è·¯å¾„ï¼Œæœ¬å›åˆå°†é­å— ${multiplier}x å€ç‡æ”¶å…¥æŸå¤±`);
            }
            
            // åº”ç”¨è·¯å¾„æ”¶å…¥æŸå¤±
            /*
            function applyPathIncomeLoss(pathId, points) {
                // è®°å½•è¯¥è·¯å¾„è¢«å‡å°‘çš„æ”¶å…¥
                if (!gameState.incomeLoss) {
                    gameState.incomeLoss = {};
                }
                
                gameState.incomeLoss[pathId] = (gameState.incomeLoss[pathId] || 0) + points;
                
                // è®°å½•åˆ°æ¸¸æˆæ—¥å¿—
                addLogEntry(`ã€Œæ å¤ºã€æ•ˆæœ: ${PATH_NAMES[pathId]}è·¯å¾„æœ¬å›åˆå‡å°‘${points}ç‚¹æ”¶å…¥`);
            }*/
           // å°†è·¯å¾„ä¸Šæœ€é«˜çº§çš„Nä¸ªå·²æ¢ç´¢/å é¢†åŒºåŸŸæ¢å¤ä¸ºæœªæ¢ç´¢çŠ¶æ€
            // (å¯ä»¥åŒ…æ‹¬è§¦å‘æ•ˆæœçš„æˆ˜äº‰åŒºåŸŸæœ¬èº«)
            function revertTopExploredRegions(pathId, count) { // Simplified: No need to pass triggering index here anymore

                // è·å–è¯¥è·¯å¾„æ‰€æœ‰ å·²æ¢ç´¢ æˆ– å·²å é¢† çš„åŒºåŸŸ
                const potentialRegionsToRevert = [];
                for (let i = 0; i < gameState.regions[pathId].length; i++) {
                    const region = gameState.regions[pathId][i];
                    if (region.status === 'explored' || region.status === 'occupied') {
                        potentialRegionsToRevert.push({index: i, rank: region.rank, occupied: region.status === 'occupied'});
                    }
                }

                // å¦‚æœæ²¡æœ‰å¯è¿˜åŸåŒºåŸŸ
                if (potentialRegionsToRevert.length === 0) {
                    // --- æ–°å¢ï¼šå¦‚æœæ•°é‡ä¸å¤Ÿï¼Œåº”ç”¨ç½šåˆ† ---
                    const deficit = count;
                    if (deficit > 0) {
                        const penalty = deficit * 100;
                        gameState.score -= penalty;
                        scoreDisplay.textContent = gameState.score;
                        updateCornerInfo();
                        addLogEntry(`ã€Œæ¨¡å› å…¥ä¾µã€æ•ˆæœ: ${PATH_NAMES[pathId]}ä¸Šæ²¡æœ‰å¯è¿˜åŸåŒºåŸŸï¼Œç¼ºå°‘${deficit}ä¸ªï¼Œæ¯ç¼ºå°‘ä¸€ä¸ªæŸå¤±100åˆ†ï¼Œæ€»æŸå¤±${penalty}åˆ†`);
                    } else {
                        // Log if count is 0, but no regions found
                        addLogEntry(`æ— æ³•æ‰§è¡Œã€Œæ¨¡å› å…¥ä¾µã€æ•ˆæœï¼š${PATH_NAMES[pathId]}ä¸Šæ²¡æœ‰å·²æ¢ç´¢/å é¢†åŒºåŸŸ`);
                    }
                    // --- æ–°å¢ç»“æŸ ---
                    return;
                }

                // æŒ‰ç­‰çº§ä»é«˜åˆ°ä½æ’åº
                potentialRegionsToRevert.sort((a, b) => b.rank - a.rank);

                // ç¡®å®šå®é™…è¿˜åŸæ•°é‡ï¼ˆæœ€å¤šcountä¸ªï¼‰
                const actualCount = Math.min(count, potentialRegionsToRevert.length);
                const revertedRegionsInfo = []; // ç”¨äºæ—¥å¿—è®°å½•

                // å¯¹å‰ actualCount ä¸ªåŒºåŸŸè¿›è¡Œå¤„ç†
                for (let i = 0; i < actualCount; i++) {
                    const { index, rank, occupied } = potentialRegionsToRevert[i];
                    const region = gameState.regions[pathId][index]; // è·å–åŒºåŸŸå½“å‰çŠ¶æ€

                    // å¦‚æœè¿™ä¸ªåŒºåŸŸåœ¨å¤„ç†è¿‡ç¨‹ä¸­çŠ¶æ€å˜äº† (ä¸åº”è¯¥å‘ç”Ÿä½†ä¿é™©)
                    if (region.status === 'unexplored') continue;

                    // è®°å½•è¢«è¿˜åŸçš„åŒºåŸŸä¿¡æ¯
                    let regionDescription = `${PATH_NAMES[pathId]} ${rank}`;
                    if (region.type === 'wonder' && region.wonderData) regionDescription += ` å¥‡è§‚ã€Œ${region.wonderData.name}ã€`;
                    else if (region.type === 'combat' && region.combatData) regionDescription += ` æˆ˜äº‰ã€Œ${region.combatData.name}ã€`; // æ¨¡å› å…¥ä¾µä¼šå½±å“æˆ˜äº‰åŒºåŸŸæœ¬èº«
                    else if (region.type === 'echo') regionDescription += ` (å›å£°åŒºåŸŸ)`;
                    else if (region.type === 'forgotten') regionDescription += ` (é—å¿˜åŒºåŸŸ)`; // æ¨¡å› å…¥ä¾µå¯èƒ½å½±å“å…¶ä»–é—å¿˜åŒºåŸŸ

                    revertedRegionsInfo.push(regionDescription);


                    // å¦‚æœåŒºåŸŸæ˜¯å é¢†çŠ¶æ€ï¼Œå°†å¡ç‰Œå¼ƒæ‰
                    if (region.status === 'occupied') {
                        if (region.occupyCard) {
                            gameState.discardPile.push(region.occupyCard);
                            region.occupyCard = null;
                        }
                        region.points = 0; // å é¢†å¾—åˆ†å½’é›¶
                        // å¦‚æœæ˜¯å é¢†çš„å¥‡è§‚ï¼Œç§»é™¤æ•ˆæœ
                        if (region.type === 'wonder' && region.wonderEffect) {
                            region.wonderEffect = null;
                        }
                    }


                    // *** å…³é”®ä¿®æ”¹ï¼šè®¾ç½®çŠ¶æ€ä¸ºæœªæ¢ç´¢ï¼Œå¦‚æœæ˜¯åŸæˆ˜äº‰åŒºåŸŸï¼ŒåŒæ—¶æ”¹ä¸ºé—å¿˜ç±»å‹ ***
                    region.status = 'unexplored';
                    // å¦‚æœè¢«è¿˜åŸçš„åŒºåŸŸæ˜¯æˆ˜æ–—åŒºåŸŸï¼Œå®ƒç°åœ¨å˜ä¸ºé—å¿˜åŒºåŸŸ
                    if (region.type === 'combat') { // æ³¨æ„ï¼šè¿™é‡Œåˆ¤æ–­ type === 'combat' æ˜¯æŒ‡åŸå§‹ç±»å‹
                        // å¦‚æœè§¦å‘åŒºåŸŸé€šè¿‡æ­¤æ•ˆæœè¢«è¿˜åŸï¼Œåˆ™å°†å…¶ç±»å‹æ”¹ä¸º forgotten
                        // ä½†è¿™ä¸ªé€»è¾‘åº”è¯¥åœ¨ resolveCombatWithPenalty ä¸­å¤„ç†æ›´å¥½ï¼Œä¿è¯è§¦å‘åŒºåŸŸçš„æœ€ç»ˆçŠ¶æ€
                        // è¿™é‡Œçš„ revertTopExploredRegions åº”è¯¥åªè´Ÿè´£å°†åŒºåŸŸçŠ¶æ€æ”¹å› unexplored å’Œå¼ƒç‰Œ
                        // type å˜ä¸º forgotten çš„é€»è¾‘ç”± resolveCombatWithPenalty ç»Ÿä¸€å¤„ç†
                    }


                    // æ›´æ–°åŒºåŸŸæ˜¾ç¤º
                    updateRegionDisplay(pathId, index);
                }

                // --- æ–°å¢ï¼šå¦‚æœå®é™…è¿˜åŸæ•°é‡ä¸è¶³ï¼Œåº”ç”¨ç½šåˆ† ---
                const deficit = count - actualCount;
                if (deficit > 0) {
                    const penalty = deficit * 100;
                    gameState.score -= penalty;
                    scoreDisplay.textContent = gameState.score;
                    updateCornerInfo();
                    addLogEntry(`ã€Œæ¨¡å› å…¥ä¾µã€æ•ˆæœ: ç§»é™¤äº†${actualCount}ä¸ªå¯è¿˜åŸåŒºåŸŸï¼Œç¼ºå°‘${deficit}ä¸ªï¼Œæ¯ç¼ºå°‘ä¸€ä¸ªæŸå¤±100åˆ†ï¼Œæ€»æŸå¤±${penalty}åˆ†`);
                }
                // --- æ–°å¢ç»“æŸ ---


                // æ›´æ–°å¼ƒç‰Œå †è®¡æ•° (å¦‚æœå®é™…æœ‰å¼ƒç‰Œçš„è¯)
                if (actualCount > 0 && revertedRegionsInfo.length > 0) {
                    updateDiscardCount();
                    // æ›´æ–°èŠ±è‰²å¾—åˆ† (å¦‚æœå¼ƒæ‰äº†å é¢†å¡)
                    updateAllSuitBonusWonders();
                }


                // è®°å½•åˆ°æ¸¸æˆæ—¥å¿—
                if (revertedRegionsInfo.length > 0) {
                    addLogEntry(`ã€Œæ¨¡å› å…¥ä¾µã€æ•ˆæœ: ${revertedRegionsInfo.join(', ')} è¢«é‡ç½®ä¸ºæœªæ¢ç´¢çŠ¶æ€`);
                }
                // å¦‚æœ actualCount == 0 ä¸” deficit == 0, å·²ç»åœ¨ä¸Šé¢ log äº† "æ— æ³•æ‰§è¡Œ"

            }
            
            // å°†æŒ‡å®šåŒºåŸŸä¸Šæ–¹çš„Nä¸ªæ ¼å­è½¬æ¢ä¸ºé—å¿˜åŒºåŸŸ
            function convertToForgottenRegions(pathId, startIndex, count) {
                // è·å–å¯èƒ½è¢«å½±å“çš„åŒºåŸŸ
                const regions = [];
                
                // åªè·å–æ¯”startIndexç­‰çº§æ›´é«˜çš„åŒºåŸŸ
                for (let i = startIndex + 1; i < gameState.regions[pathId].length; i++) {
                    regions.push(i);
                }
                
                // å¦‚æœæ²¡æœ‰å¯è½¬æ¢çš„åŒºåŸŸï¼Œç›´æ¥è¿”å›
                if (regions.length === 0) {
                    addLogEntry(`æ— æ³•æ‰§è¡Œã€Œæœªæ¥ç ´åã€æ•ˆæœï¼š${PATH_NAMES[pathId]} ${startIndex + 1}çº§ä»¥ä¸Šæ²¡æœ‰åŒºåŸŸ`);
                    return;
                }
                
                // ç¡®å®šè¦è½¬æ¢çš„æ•°é‡
                const actualCount = Math.min(count, regions.length);
                const convertedRegions = [];
                
                // ä»startIndexå¾€ä¸Šè½¬æ¢actualCountä¸ªåŒºåŸŸ
                for (let i = 0; i < actualCount; i++) {
                    const index = regions[i];
                    const region = gameState.regions[pathId][index];
                    
                    // è®°å½•è¢«è½¬æ¢çš„åŒºåŸŸä¿¡æ¯
                    convertedRegions.push(`${PATH_NAMES[pathId]} ${region.rank}`);
                    
                    // å¦‚æœåŒºåŸŸè¢«å é¢†ï¼Œå…ˆå°†å¡ç‰Œå¼ƒæ‰
                    if (region.status === 'occupied' && region.occupyCard) {
                        gameState.discardPile.push(region.occupyCard);
                        region.occupyCard = null;
                    }
                    
                    // è½¬æ¢ä¸ºé—å¿˜åŒºåŸŸ
                    region.type = 'forgotten';
                    region.wonderData = null;
                    region.combatData = null;
                    region.wonderEffect = null;
                    region.points = 0;
                    region.status = 'explored'; // å˜ä¸ºå·²æ¢ç´¢çŠ¶æ€
                    
                    // æ›´æ–°åŒºåŸŸæ˜¾ç¤º
                    updateRegionDisplay(pathId, index);
                }
                
                // æ›´æ–°å¼ƒç‰Œå †è®¡æ•°
                updateDiscardCount();
                
                // è®°å½•åˆ°æ¸¸æˆæ—¥å¿—
                addLogEntry(`ã€Œæœªæ¥ç ´åã€æ•ˆæœ: ${convertedRegions.join(', ')} è¢«è½¬æ¢ä¸ºé—å¿˜åŒºåŸŸ`);
                
                // æ›´æ–°æ‰€æœ‰èŠ±è‰²æ”¶è·å¥‡è§‚çš„å¾—åˆ†
                updateAllSuitBonusWonders();
            }
            
            // æ¢ç´¢åŒºåŸŸ
            function exploreRegion(pathId, index, cardIndex) {
                // è·å–é€‰æ‹©çš„å¡ç‰Œç´¢å¼•ï¼ˆä½¿ç”¨selectedCardsæ•°ç»„ç¬¬ä¸€ä¸ªå…ƒç´ ï¼‰
                const selectedCardIndex = gameState.selectedCards[0];
                // è·å–é€‰æ‹©çš„å¡ç‰Œå’ŒåŒºåŸŸ
                const card = gameState.hand[selectedCardIndex];
                const region = gameState.regions[pathId][index];
                const cardRank = RANK_VALUES[card.rank];
                
                // è®¡ç®—æ¢ç´¢å¾—åˆ†
                let points = REGION_TYPES[region.type].explorePoints;
                let bonusInfo = '';
                
                // é»‘æ¡ƒæ¢ç´¢æ•ˆæœï¼šrankå€¼ç¿»å€
                // é»‘æ¡ƒçš„å¡ç‰Œåœ¨æ¢ç´¢æ—¶ï¼Œç›¸å½“äºç‚¹æ•°ç¿»å€
                let effectiveRank = cardRank;
                if (card.suit === 'spade') {
                    effectiveRank = cardRank * 2;
                    bonusInfo = `(${t('spadeBonus')}: rank ${cardRank}â†’${effectiveRank})`;
                }
                
                // å¦‚æœæœ‰æ•ˆrankå€¼å°äºåŒºåŸŸç­‰çº§ï¼Œæ— æ³•æ¢ç´¢
                if (effectiveRank < region.rank) {
                    showMessage(t('notEnoughRank'));
                    return;
                }
                
                // æ›´æ–°åˆ†æ•°
                gameState.score += points;
                scoreDisplay.textContent = gameState.score;
                
                // æ›´æ–°å³ä¸‹è§’ä¿¡æ¯æ 
                updateCornerInfo();
                
                // æ›´æ–°åŒºåŸŸçŠ¶æ€
                region.status = 'explored';
                
                // æ›´æ–°åŒºåŸŸæ˜¾ç¤º
                updateRegionDisplay(pathId, index);
                
                // ä»æ‰‹ç‰Œä¸­ç§»é™¤å¡ç‰Œï¼ŒåŠ å…¥å¼ƒç‰Œå †
                gameState.discardPile.push(card);
                gameState.hand.splice(selectedCardIndex, 1);
                
                // æ›´æ–°å¼ƒç‰Œå †è®¡æ•°
                updateDiscardCount();
                
                // é‡æ–°æ¸²æŸ“æ‰‹ç‰Œ
                renderHand();
                
                // è®°å½•æ“ä½œ
                addLogEntry(`${t('explore')}: ${PATH_NAMES[pathId]} ${region.rank} (${card.rank}${SUIT_SYMBOLS[card.suit]}) +${points}åˆ† ${bonusInfo}`);
                
                // æ˜¾ç¤ºæ¶ˆæ¯
                showMessage(t('exploreDone', {points: points}));
                
                // é‡ç½®é€‰æ‹©çŠ¶æ€
                resetSelectionState();
                
                // ä¿å­˜æ¸¸æˆçŠ¶æ€åˆ°å†å²è®°å½•
                addToHistory(saveGameState());
            }
            
            // å¤„ç†å¥‡è§‚å é¢†æ•ˆæœ
            function processWonderEffects(region, pathId) {
                const wonderTier = region.wonderData.tier;
                const effect = region.wonderData.effect;
                const tierData = WONDER_TIERS[wonderTier];
                const multiplier = tierData.effectMultiplier;
                
                let points = 0;
                let effectDescription = '';
                let immediatePoints = tierData.baseScore;
                
                // å¤„ç†ä¸åŒçš„å¥‡è§‚æ•ˆæœç±»å‹
                switch(effect.type) {
                    case 'draw':
                        // æŠ½å¡æ•ˆæœï¼šæ¯å›åˆé¢å¤–æŠ½ç‰Œ
                        // è¿™ä¸ªæ•ˆæœä¼šåœ¨endTurnä¸­å¤„ç†
                        region.wonderEffect = {
                            type: 'draw',
                            value: multiplier
                        };
                        effectDescription = `æ¯å›åˆå¤šæŠ½${multiplier}å¼ `;
                        points = 0; // è¿™ä¸ªæ•ˆæœä¸æä¾›ç›´æ¥åˆ†æ•°
                        break;
                        
                    case 'population':
                        // äººå£æ•ˆæœï¼šå¢åŠ æ‰‹ç‰Œä¸Šé™
                        region.wonderEffect = {
                            type: 'population',
                            value: multiplier // æ©™è‰²+3, ç´«è‰²+2, è“è‰²+1
                        };
                        effectDescription = `æ‰‹ç‰Œä¸Šé™+${multiplier}`;
                        points = 0; // è¿™ä¸ªæ•ˆæœä¸æä¾›ç›´æ¥åˆ†æ•°
                        break;
                        
                    case 'score':
                        // å¾—åˆ†æ•ˆæœï¼šæ¯å›åˆé¢å¤–å¾—åˆ†
                        points = 10 * multiplier; // æ©™è‰²+30/t, ç´«è‰²+20/t, è“è‰²+10/t
                        effectDescription = `æ¯å›åˆ+${points}åˆ†`;
                        break;
                        
                    case 'explore':
                        // æ¢ç´¢æ•ˆæœï¼šç«‹å³æ¢ç´¢è¯¥è·¯å¾„ä¸Šçš„é¢å¤–æ ¼å­
                        const extraExplores = multiplier;
                        
                        // æ‰¾åˆ°å½“å‰å·²æ¢ç´¢çš„æœ€é«˜ç­‰çº§åŒºåŸŸ
                        let highestExploredRank = 0;
                        for (const r of gameState.regions[pathId]) {
                            if (r.status !== 'unexplored' && r.rank > highestExploredRank) {
                                highestExploredRank = r.rank;
                            }
                        }
                        
                        // æ¢ç´¢é¢å¤–çš„æ ¼å­
                        let exploredCount = 0;
                        for (let i = 0; i < gameState.regions[pathId].length && exploredCount < extraExplores; i++) {
                            const r = gameState.regions[pathId][i];
                            if (r.rank > highestExploredRank && r.status === 'unexplored') {
                                r.status = 'explored';
                                updateRegionDisplay(pathId, i);
                                exploredCount++;
                            }
                        }
                        
                        effectDescription = `é¢å¤–æ¢ç´¢äº†${exploredCount}æ ¼`;
                        break;
                        
                    case 'heart_bonus':
                    case 'spade_bonus':
                    case 'diamond_bonus':
                    case 'club_bonus':
                        // èŠ±è‰²æ”¶è·æ•ˆæœï¼šæ ¹æ®å¥‡è§‚ç­‰çº§ï¼Œå¯¹è¯¥è·¯å¾„ä¸Šçš„å¯¹åº”èŠ±è‰²æ¯å›åˆè®¡åˆ†
                        const suit = effect.type.split('_')[0]; // 'heart', 'spade', 'diamond', 'club'
                        
                        // æ ¹æ®å¥‡è§‚ç­‰çº§è®¾ç½®ä¸åŒçš„å€ç‡
                        let bonusMultiplier;
                        if (wonderTier === 'orange') {
                            bonusMultiplier = 6; // æ©™è‰²å¥‡è§‚ï¼š6Ã—nÂ²
                        } else if (wonderTier === 'purple') {
                            bonusMultiplier = 4; // ç´«è‰²å¥‡è§‚ï¼š4Ã—nÂ²
                        } else {
                            bonusMultiplier = 3; // è“è‰²å¥‡è§‚ï¼š3Ã—nÂ²
                        }
                        
                        region.wonderEffect = {
                            type: 'suit_bonus',
                            suit: suit,
                            pathId: pathId,
                            formula: 'squared',
                            multiplier: bonusMultiplier // ä¿å­˜å€ç‡
                        };
                        
                        // è®¡ç®—å½“å‰è·¯å¾„ä¸Šå·²æœ‰çš„è¯¥èŠ±è‰²ç‰Œæ•°
                        let suitCount = 0;
                        for (const r of gameState.regions[pathId]) {
                            if (r.status === 'occupied' && r.occupyCard && r.occupyCard.suit === suit) {
                                suitCount++;
                            }
                        }
                        
                        // ä½¿ç”¨æ–°å…¬å¼ï¼šbonusMultiplier Ã— (èŠ±è‰²æ•°é‡)Â²
                        points = bonusMultiplier * (suitCount * suitCount);
                        effectDescription = `${PATH_NAMES[pathId]}è·¯å¾„ä¸Š${SUIT_SYMBOLS[suit]}ï¼š${bonusMultiplier}Ã—æ•°é‡Â²åˆ†/å›åˆ`;
                        break;
                }
                
                // ç«‹å³å¢åŠ åˆ†æ•°
                gameState.score += immediatePoints;
                scoreDisplay.textContent = gameState.score;
                
                return {
                    points,
                    effectDescription,
                    immediatePoints
                };
            }
            
            // å é¢†åŒºåŸŸ
            // å é¢†åŒºåŸŸ
        function occupyRegion(pathId, index) {
            // è·å–é€‰æ‹©çš„å¡ç‰Œç´¢å¼•ï¼ˆä½¿ç”¨selectedCardsæ•°ç»„ç¬¬ä¸€ä¸ªå…ƒç´ ï¼‰
            const selectedCardIndex = gameState.selectedCards[0];
            // è·å–é€‰æ‹©çš„å¡ç‰Œå’ŒåŒºåŸŸ
            const card = gameState.hand[selectedCardIndex];
            const region = gameState.regions[pathId][index];
            const cardRank = RANK_VALUES[card.rank];

            // æ£€æŸ¥æ˜¯å¦æ˜¯å¥‡è§‚åŒºåŸŸï¼Œéœ€è¦ç‰¹æ®Šå¤„ç†
            if (region.type === 'wonder' && region.wonderData) {
                // ... (å¥‡è§‚å é¢†é€»è¾‘ï¼Œä¿æŒä¸å˜) ...
                // æ£€æŸ¥å¡ç‰Œæ˜¯å¦æ»¡è¶³å¥‡è§‚å é¢†æ¡ä»¶
                if (!cardMeetsWonderCondition(card, region.wonderData)) {
                    // ... (æ˜¾ç¤ºé”™è¯¯æ¶ˆæ¯ï¼Œä¿æŒä¸å˜) ...
                    return; // ä¸æ»¡è¶³æ¡ä»¶ï¼Œåœæ­¢æ‰§è¡Œ
                }

                // å¤„ç†å¥‡è§‚æ•ˆæœ
                const wonderEffectResult = processWonderEffects(region, pathId);

                // æ›´æ–°åŒºåŸŸçŠ¶æ€
                region.status = 'occupied';
                region.occupyCard = card;
                region.points = wonderEffectResult.points; // æ¯å›åˆå¾—åˆ† (å¥‡è§‚æ•ˆæœå†³å®š)

                // æ›´æ–°åŒºåŸŸæ˜¾ç¤º
                updateRegionDisplay(pathId, index);

                // æ›´æ–°æ‰€æœ‰èŠ±è‰²æ”¶è·å¥‡è§‚çš„å¾—åˆ†
                updateAllSuitBonusWonders(pathId, card.suit);

                // ä»æ‰‹ç‰Œä¸­ç§»é™¤å¡ç‰Œ
                gameState.hand.splice(selectedCardIndex, 1);

                // é‡æ–°æ¸²æŸ“æ‰‹ç‰Œ
                renderHand();

                // è®°å½•æ“ä½œå’Œå¥‡è§‚æ•ˆæœ
                const wonderTierName = WONDER_TIERS[region.wonderData.tier].name;
                addLogEntry(`${t('occupy')}: ${PATH_NAMES[pathId]} ${region.rank} å¥‡è§‚ã€Œ${region.wonderData.name}ã€(${card.rank}${SUIT_SYMBOLS[card.suit]}) å³æ—¶+${wonderEffectResult.immediatePoints}åˆ† ${wonderEffectResult.points > 0 ? '+' + wonderEffectResult.points + 'åˆ†/å›åˆ' : ''} æ•ˆæœ: ${wonderEffectResult.effectDescription}`);

                // æ˜¾ç¤ºæ¶ˆæ¯
                showMessage(`å é¢†å¥‡è§‚æˆåŠŸï¼è·å¾—${wonderEffectResult.immediatePoints}åˆ†ï¼Œ${wonderEffectResult.effectDescription}`);

                // é‡ç½®é€‰æ‹©çŠ¶æ€
                resetSelectionState();

                // æ£€æŸ¥æ˜¯å¦å®Œæˆäº†æ•´æ¡è·¯å¾„çš„å¾æœ
                checkPathConquest(pathId); // å¥‡è§‚å é¢†ä¹Ÿå¯èƒ½å®Œæˆè·¯å¾„

                // ä¿å­˜æ¸¸æˆçŠ¶æ€åˆ°å†å²è®°å½•
                addToHistory(saveGameState());

                return; // å¥‡è§‚å¤„ç†å®Œæ¯•ï¼Œé€€å‡ºå‡½æ•°
            }

            
           // æ£€æŸ¥æ˜¯å¦æ˜¯é—å¿˜åŒºåŸŸ (ç°åœ¨å…è®¸å é¢†)
            if (region.type === 'forgotten') {
                // æ‰§è¡Œå é¢†é—å¿˜åŒºåŸŸçš„é€»è¾‘
                region.status = 'occupied';
                region.occupyCard = card;
                region.points = 0; // é—å¿˜åŒºåŸŸå¾—åˆ†å§‹ç»ˆä¸º0

                // æ›´æ–°åŒºåŸŸæ˜¾ç¤º
                updateRegionDisplay(pathId, index);

                // æ›´æ–°æ‰€æœ‰èŠ±è‰²æ”¶è·å¥‡è§‚çš„å¾—åˆ† (å¦‚æœå é¢†çš„ç‰ŒèŠ±è‰²è§¦å‘äº†å¥‡è§‚æ•ˆæœ)
                updateAllSuitBonusWonders(pathId, card.suit);


                // ä»æ‰‹ç‰Œä¸­ç§»é™¤å¡ç‰Œ
                gameState.hand.splice(selectedCardIndex, 1);

                // é‡æ–°æ¸²æŸ“æ‰‹ç‰Œ
                renderHand();

                // è®°å½•æ“ä½œ
                addLogEntry(`${t('occupy')}: ${PATH_NAMES[pathId]} ${region.rank} é—å¿˜åŒºåŸŸ (${card.rank}${SUIT_SYMBOLS[card.suit]}) +0åˆ†/å›åˆ`);

                // æ˜¾ç¤ºæ¶ˆæ¯
                showMessage(`å é¢†é—å¿˜åŒºåŸŸæˆåŠŸï¼è¯¥åŒºåŸŸä¸æä¾›æ¯å›åˆå¾—åˆ†ã€‚`); // å¯ä»¥è‡ªå®šä¹‰æ¶ˆæ¯

                // é‡ç½®é€‰æ‹©çŠ¶æ€
                resetSelectionState();

                // æ£€æŸ¥æ˜¯å¦å®Œæˆäº†æ•´æ¡è·¯å¾„çš„å¾æœ
                checkPathConquest(pathId); // å é¢†é—å¿˜åŒºåŸŸä¹Ÿå¯èƒ½å®Œæˆè·¯å¾„

                // ä¿å­˜æ¸¸æˆçŠ¶æ€åˆ°å†å²è®°å½•
                addToHistory(saveGameState());

                return; // é—å¿˜åŒºåŸŸå¤„ç†å®Œæ¯•ï¼Œé€€å‡ºå‡½æ•°
            }



            // ä»¥ä¸‹æ˜¯éå¥‡è§‚ã€éé—å¿˜åŒºåŸŸçš„å¸¸è§„å é¢†é€»è¾‘ (standard, echo)

            let points = 0;
            let bonusInfo = '';

            if (region.type === 'standard') {
                // ... (æ ‡å‡†åŒºåŸŸå é¢†é€»è¾‘ï¼Œä¿æŒä¸å˜) ...
                points = REGION_TYPES.standard.occupyPoints;
                if (card.suit === 'heart') {
                    points = 2;
                    bonusInfo = `(${t('heartBonus')}: 1â†’2)`;
                }
            } else if (region.type === 'echo') {
                // ... (å›å£°åŒºåŸŸå é¢†é€»è¾‘ï¼Œä¿æŒä¸å˜) ...
                points = cardRank * 2;
                if (card.suit === 'heart') {
                    let originalPoints = points;
                    points = cardRank * 3;
                    bonusInfo = `(${t('heartBonus')}: ${originalPoints}â†’${points})`;
                }
                if (!bonusInfo) {
                    bonusInfo = t('echoBonus');
                } else {
                    bonusInfo += ` ${t('echoBonus')}`;
                }
            }

            // æ›´æ–°åŒºåŸŸçŠ¶æ€
            region.status = 'occupied';
            region.occupyCard = card;
            region.points = points;

            // æ›´æ–°åŒºåŸŸæ˜¾ç¤º
            updateRegionDisplay(pathId, index);

            // æ›´æ–°æ‰€æœ‰èŠ±è‰²æ”¶è·å¥‡è§‚çš„å¾—åˆ†æ˜¾ç¤º
            updateAllSuitBonusWonders(pathId, card.suit); // ä¼ é€’å é¢†çš„è·¯å¾„å’ŒèŠ±è‰²

            // ä»æ‰‹ç‰Œä¸­ç§»é™¤å¡ç‰Œ
            gameState.hand.splice(selectedCardIndex, 1);

            // é‡æ–°æ¸²æŸ“æ‰‹ç‰Œ
            renderHand();

            // è®°å½•æ“ä½œ
            addLogEntry(`${t('occupy')}: ${PATH_NAMES[pathId]} ${region.rank} (${card.rank}${SUIT_SYMBOLS[card.suit]}) +${points}åˆ†/å›åˆ ${bonusInfo}`);

            // æ˜¾ç¤ºæ¶ˆæ¯
            showMessage(t('occupyDone', {points: points}));

            // é‡ç½®é€‰æ‹©çŠ¶æ€
            resetSelectionState();

            // æ£€æŸ¥æ˜¯å¦å®Œæˆäº†æ•´æ¡è·¯å¾„çš„å¾æœ
            checkPathConquest(pathId); // å¸¸è§„å é¢†ä¹Ÿå¯èƒ½å®Œæˆè·¯å¾„

            // ä¿å­˜æ¸¸æˆçŠ¶æ€åˆ°å†å²è®°å½•
            addToHistory(saveGameState());
        }
            
          // æ›´æ–°åŒºåŸŸæ˜¾ç¤º
        function updateRegionDisplay(pathId, index) {
            const region = gameState.regions[pathId][index];
            const regionContainer = document.getElementById(`${pathId}-regions`);

            // æ³¨æ„ï¼šæˆ‘ä»¬å€’åºæ¸²æŸ“äº†åŒºåŸŸï¼Œæ‰€ä»¥ç´¢å¼•éœ€è¦è°ƒæ•´
            const displayIndex = 12 - index;
            const regionElement = regionContainer.children[displayIndex];

            // æ¸…ç©ºç°æœ‰å†…å®¹
            regionElement.innerHTML = '';

            // æ›´æ–°æ ·å¼
            regionElement.className = 'rounded-md w-16 h-24 md:w-20 md:h-30 border shadow-md flex flex-col items-center justify-center cursor-pointer relative';


            // æ ¹æ®åŒºåŸŸçŠ¶æ€å’Œç±»å‹è®¾ç½®åŸºç¡€æ ·å¼
            if (region.status === 'unexplored') {
                regionElement.classList.add('bg-gray-400', 'dark:bg-gray-700');
            } else if (region.status === 'explored') {
                regionElement.classList.add('bg-white', 'dark:bg-gray-600'); // å·²æ¢ç´¢åŸºç¡€è‰²
            } else if (region.status === 'occupied') {
                regionElement.classList.add('bg-blue-100', 'dark:bg-blue-800'); // å é¢†åŸºç¡€è‰²
            }

            // ç‰¹æ®Šç±»å‹æ ·å¼è¦†ç›–åŸºç¡€æ ·å¼ (å¥‡è§‚, æˆ˜äº‰, å›å£°, é—å¿˜)
            if (region.type === 'wonder' && region.wonderData) {
                const tierClass = `wonder-${region.wonderData.tier}`;
                regionElement.classList.add(tierClass);
            } else if (region.type === 'combat' && region.combatData) {
                const tierClass = `combat-${region.combatData.tier}`;
                regionElement.classList.add(tierClass);
            } else if (region.type === 'echo' && region.status !== 'occupied') { // å›å£°å›¾æ ‡åªåœ¨éå é¢†æ—¶æ˜¾ç¤ºï¼Œé¢œè‰²åœ¨åŸºç¡€æ ·å¼ä¸­
                regionElement.classList.add('bg-green-200', 'dark:bg-green-800'); // å›å£°åŒºåŸŸé¢œè‰²
            } else if (region.type === 'forgotten') {
                regionElement.classList.add('bg-gray-200', 'dark:bg-gray-700', 'opacity-75'); // é—å¿˜åŒºåŸŸé¢œè‰²
            }


            // åŒºåŸŸç­‰çº§æ˜¾ç¤ºï¼ˆé¡¶éƒ¨ï¼‰
            const rankElement = document.createElement('div');
            rankElement.className = 'text-sm font-bold absolute top-1 left-1';
            rankElement.textContent = index + 1;
            regionElement.appendChild(rankElement);


            // æ ¹æ®åŒºåŸŸç±»å‹å’ŒçŠ¶æ€æ·»åŠ ä¸åŒçš„å†…å®¹

            // --- é—å¿˜åŒºåŸŸæ˜¾ç¤º (æ— è®ºçŠ¶æ€) ---
            if (region.type === 'forgotten') {
                const typeLabel = document.createElement('div');
                typeLabel.className = 'absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 text-xs font-bold text-gray-500 dark:text-gray-400';
                typeLabel.textContent = t('forgottenRegion');
                regionElement.appendChild(typeLabel);

                // å¦‚æœæ˜¯å é¢†çŠ¶æ€ï¼Œæ˜¾ç¤ºå¡ç‰Œå’Œ0åˆ†
                if (region.status === 'occupied' && region.occupyCard) {
                    const card = region.occupyCard;
                    // å¡ç‰Œä¿¡æ¯ï¼ˆä¸­å¿ƒæˆ–ä¸‹æ–¹ï¼‰
                    const cardInfo = document.createElement('div');
                    cardInfo.className = 'flex flex-col items-center justify-center mt-4'; // Add margin to not overlap label

                    const cardRank = document.createElement('div');
                    cardRank.className = 'text-base font-bold'; // Slightly larger for center
                    cardRank.textContent = card.rank;

                    const cardSuit = document.createElement('div');
                    cardSuit.className = `${card.suit} text-xl`; // Slightly larger for center
                    cardSuit.textContent = SUIT_SYMBOLS[card.suit];

                    cardInfo.appendChild(cardRank);
                    cardInfo.appendChild(cardSuit);
                    regionElement.appendChild(cardInfo);

                    // å¾—åˆ†æ˜¾ç¤ºï¼ˆåº•éƒ¨ï¼‰- é—å¿˜åŒºåŸŸå§‹ç»ˆæ˜¯ +0
                    const pointsElement = document.createElement('div');
                    pointsElement.className = 'absolute bottom-1 right-1 text-xs font-bold bg-blue-200 dark:bg-blue-600 px-1 rounded';
                    pointsElement.textContent = `+0`;
                    regionElement.appendChild(pointsElement);
                }

            }
            // --- å¥‡è§‚åŒºåŸŸæ˜¾ç¤º (æ— è®ºçŠ¶æ€) ---
            else if (region.type === 'wonder' && region.wonderData) {
                // ... (å¥‡è§‚æ˜¾ç¤ºé€»è¾‘ï¼Œä¿æŒä¸å˜) ...
                if (region.status === 'unexplored') {
                    const unknownElement = document.createElement('div');
                    unknownElement.className = 'text-lg font-bold text-white text-center';
                    unknownElement.textContent = '???';
                    regionElement.appendChild(unknownElement);
                } else if (region.status === 'explored') {
                    const nameElement = document.createElement('div'); nameElement.className = 'text-xs font-bold text-center px-1 mb-1'; nameElement.textContent = region.wonderData.name; regionElement.appendChild(nameElement);
                    const conditionElement = document.createElement('div'); conditionElement.className = 'text-xs text-center'; conditionElement.textContent = 'éœ€è¦: Jã€Qã€Kã€Aæˆ–çº¢å¿ƒ'; regionElement.appendChild(conditionElement);
                    const effectElement = document.createElement('div'); effectElement.className = 'text-xs text-center mt-1 px-1'; const effectText = region.wonderData.effect.name; effectElement.textContent = `[${effectText}]`; regionElement.appendChild(effectElement);
                } else if (region.status === 'occupied') {
                    const nameElement = document.createElement('div'); nameElement.className = 'text-xs font-bold text-center px-1 mb-1'; nameElement.textContent = region.wonderData.name; regionElement.appendChild(nameElement);
                    if (region.occupyCard) {
                        const card = region.occupyCard; const cardElement = document.createElement('div'); cardElement.className = 'flex items-center justify-center'; const cardRank = document.createElement('div'); cardRank.className = 'text-sm font-bold'; cardRank.textContent = card.rank; const cardSuit = document.createElement('div'); cardSuit.className = `${card.suit} text-lg`; cardSuit.textContent = SUIT_SYMBOLS[card.suit]; cardElement.appendChild(cardRank); cardElement.appendChild(cardSuit); regionElement.appendChild(cardElement);
                    }
                    const effectElement = document.createElement('div'); effectElement.className = 'text-xs text-center mt-1 px-1'; const effectText = region.wonderData.effect.name; effectElement.textContent = `[${effectText}]`; regionElement.appendChild(effectElement);
                    if (region.points > 0) { // åªåœ¨å¥‡è§‚å¾—åˆ† > 0 æ—¶æ˜¾ç¤ºåˆ†æ•°
                        const pointsElement = document.createElement('div'); pointsElement.className = 'absolute bottom-1 right-1 text-xs font-bold bg-blue-200 dark:bg-blue-600 px-1 rounded'; pointsElement.textContent = `+${region.points}`; regionElement.appendChild(pointsElement);
                    }
                }
            }
            // --- æˆ˜äº‰åŒºåŸŸæ˜¾ç¤º (æ— è®ºçŠ¶æ€) ---
            else if (region.type === 'combat' && region.combatData) {
                // ... (æˆ˜äº‰åŒºåŸŸæ˜¾ç¤ºé€»è¾‘ï¼Œä¿æŒä¸å˜) ...
                if (region.status === 'unexplored') {
                    const unknownElement = document.createElement('div');
                    unknownElement.className = 'text-lg font-bold text-white text-center';
                    unknownElement.textContent = '???';
                    regionElement.appendChild(unknownElement);
                } else if (region.status === 'explored') {
                    const nameElement = document.createElement('div'); nameElement.className = 'text-xs font-bold text-center px-1 mb-1'; nameElement.textContent = region.combatData.name; regionElement.appendChild(nameElement);
                    const conditionElement = document.createElement('div'); conditionElement.className = 'text-xs text-center'; conditionElement.textContent = region.combatData.requirement.display; regionElement.appendChild(conditionElement);
                    const effectElement = document.createElement('div'); effectElement.className = 'text-xs text-center mt-1 px-1 text-red-500 dark:text-red-400'; effectElement.textContent = region.combatData.effect.name; regionElement.appendChild(effectElement);
                    const clickPrompt = document.createElement('div'); clickPrompt.className = 'text-xs text-center mt-1 animate-pulse'; clickPrompt.textContent = t('clickToResolveCombat'); regionElement.appendChild(clickPrompt);
                }
            }
            // --- å…¶ä»–åŒºåŸŸ (standard, echo) æ˜¾ç¤º ---
            else {
                // çŠ¶æ€æ ‡è¯† - åªæœ‰åœ¨éå é¢†çŠ¶æ€æ—¶æ‰æ·»åŠ 
                if (region.status !== 'occupied') {
                    const statusIndicator = document.createElement('div');
                    statusIndicator.className = 'absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 text-xs font-bold';
                    if (region.status === 'unexplored') {
                        statusIndicator.textContent = t('unexploredRegion');
                        statusIndicator.className += ' text-gray-100 dark:text-gray-300';
                    } else if (region.status === 'explored') {
                        statusIndicator.textContent = t('exploredRegion');
                        statusIndicator.className += ' text-green-600 dark:text-green-400';
                    }
                    regionElement.appendChild(statusIndicator);
                }

                // å›å£°åŒºåŸŸæ ‡è¯† (æ— è®ºçŠ¶æ€ï¼Œä½†åœ¨å é¢†æ—¶å¯èƒ½ä¸å¡ç‰Œé‡å ï¼Œå› æ­¤åªåœ¨éå é¢†æ—¶æ˜¾ç¤ºèƒŒæ™¯é¢œè‰²åŒºåˆ†ï¼Œå›¾æ ‡å¯ä»¥åœ¨å é¢†åä¹Ÿæ˜¾ç¤º)
                if (region.type === 'echo') {
                    const typeIndicator = document.createElement('div');
                    typeIndicator.className = 'absolute top-1 right-1 w-2 h-2 rounded-full bg-green-400 dark:bg-green-300'; // Echo icon
                    regionElement.appendChild(typeIndicator);
                }

                // å¦‚æœæ˜¯å é¢†çŠ¶æ€ï¼Œæ˜¾ç¤ºå¡ç‰Œå’Œå¾—åˆ†
                if (region.status === 'occupied' && region.occupyCard) {
                    const card = region.occupyCard;

                    // å¡ç‰Œä¿¡æ¯ï¼ˆä¸­é—´ï¼‰
                    const cardInfo = document.createElement('div');
                    cardInfo.className = 'flex flex-col items-center justify-center';

                    const cardRank = document.createElement('div');
                    cardRank.className = 'text-lg font-bold';
                    cardRank.textContent = card.rank;

                    const cardSuit = document.createElement('div');
                    cardSuit.className = `${card.suit} text-2xl`;
                    cardSuit.textContent = SUIT_SYMBOLS[card.suit];

                    cardInfo.appendChild(cardRank);
                    cardInfo.appendChild(cardSuit);
                    regionElement.appendChild(cardInfo);

                    // å¾—åˆ†æ˜¾ç¤ºï¼ˆåº•éƒ¨ï¼‰
                    const pointsElement = document.createElement('div');
                    pointsElement.className = 'absolute bottom-1 right-1 text-xs font-bold bg-blue-200 dark:bg-blue-600 px-1 rounded';
                    pointsElement.textContent = `+${region.points}`;
                    regionElement.appendChild(pointsElement);
                }
            }
        }
            
            // å¼ƒç‰Œï¼ˆæ”¯æŒå¤šé€‰ï¼‰
            function discardCard() {
                if (gameState.selectedCards.length === 0) {
                    showMessage('è¯·å…ˆé€‰æ‹©è¦å¼ƒæ‰çš„æ‰‹ç‰Œ');
                    return;
                }
                
                // æŒ‰ç…§ç´¢å¼•ä»å¤§åˆ°å°æ’åºï¼ˆå…ˆå¤„ç†åé¢çš„ç´¢å¼•é¿å…åˆ é™¤å½±å“å‰é¢çš„ç´¢å¼•ï¼‰
                const sortedIndices = [...gameState.selectedCards].sort((a, b) => b - a);
                
                // è®°å½•å¼ƒæ‰çš„ç‰Œ
                const discardedCards = [];
                
                // å¤„ç†æ¯å¼ é€‰ä¸­çš„ç‰Œ
                for (const index of sortedIndices) {
                    // è·å–é€‰ä¸­çš„å¡ç‰Œ
                    const card = gameState.hand[index];
                    discardedCards.push(`${card.rank}${SUIT_SYMBOLS[card.suit]}`);
                    
                    // åŠ å…¥å¼ƒç‰Œå †
                    gameState.discardPile.push(card);
                    
                    // ä»æ‰‹ç‰Œä¸­ç§»é™¤
                    gameState.hand.splice(index, 1);
                }
                
                // æ›´æ–°å¼ƒç‰Œå †è®¡æ•°
                updateDiscardCount();
                
                // è®°å½•æ“ä½œ
                if (discardedCards.length === 1) {
                    addLogEntry(`å¼ƒç‰Œ: ${discardedCards[0]}`);
                } else {
                    addLogEntry(`å¼ƒç‰Œ: ${discardedCards.join(', ')}`);
                }
                
                // é‡ç½®é€‰æ‹©çŠ¶æ€
                resetSelectionState();
                
                // é‡æ–°æ¸²æŸ“æ‰‹ç‰Œ
                renderHand();
                
                // æ˜¾ç¤ºæ¶ˆæ¯
                if (discardedCards.length === 1) {
                    showMessage(`å·²å¼ƒæ‰ ${discardedCards[0]}`);
                } else {
                    showMessage(`å·²å¼ƒæ‰ ${discardedCards.length} å¼ ç‰Œ`);
                }
                
                // ä¿å­˜æ¸¸æˆçŠ¶æ€åˆ°å†å²è®°å½•
                addToHistory(saveGameState());
            }
            
            // æ˜¾ç¤ºå¼ƒç‰Œæç¤º
            function showDiscardPrompt() {
                // åˆ›å»ºå¼¹çª—æç¤º
                const promptOverlay = document.createElement('div');
                promptOverlay.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
                
                const promptBox = document.createElement('div');
                promptBox.className = 'bg-white dark:bg-gray-800 p-5 rounded-lg shadow-lg max-w-md w-full mx-4 text-center';
                
                const title = document.createElement('h3');
                title.className = 'text-xl font-bold mb-3';
                title.textContent = 'æ‰‹ç‰Œå·²è¾¾ä¸Šé™';
                
                const message = document.createElement('p');
                message.className = 'mb-4';
                message.textContent = 'æ‚¨çš„æ‰‹ç‰Œå·²è¾¾åˆ°ä¸Šé™(10å¼ )ã€‚è¯·å…ˆå¼ƒæ‰ä¸€äº›æ‰‹ç‰Œï¼Œç„¶åå†ç»“æŸå›åˆã€‚';
                
                const button = document.createElement('button');
                button.className = 'bg-primary hover:bg-indigo-700 text-white px-4 py-2 rounded-lg';
                button.textContent = 'ç¡®å®š';
                button.addEventListener('click', () => {
                    document.body.removeChild(promptOverlay);
                });
                
                promptBox.appendChild(title);
                promptBox.appendChild(message);
                promptBox.appendChild(button);
                promptOverlay.appendChild(promptBox);
                
                document.body.appendChild(promptOverlay);
            }
            
            // è·å–å½“å‰æ‰‹ç‰Œä¸Šé™
            function getCurrentHandLimit() {
                // åŸºç¡€æ‰‹ç‰Œä¸Šé™
                let handLimit = 10;
                
                // åªæœ‰å½“æ¸¸æˆåŒºåŸŸå·²ç»åˆå§‹åŒ–æ—¶æ‰è®¡ç®—å¥‡è§‚æ•ˆæœ
                if (!gameState.regions || Object.keys(gameState.regions).length === 0) {
                    return handLimit;
                }
                
                // è®¡ç®—å¥‡è§‚å¸¦æ¥çš„æ‰‹ç‰Œä¸Šé™æå‡
                for (const pathId of PATHS) {
                    // ç¡®ä¿è¯¥è·¯å¾„å­˜åœ¨ä¸”å¯è¿­ä»£
                    if (gameState.regions[pathId] && Array.isArray(gameState.regions[pathId])) {
                        for (const region of gameState.regions[pathId]) {
                            if (region.status === 'occupied' && 
                                region.type === 'wonder' && 
                                region.wonderData && 
                                region.wonderEffect &&
                                region.wonderEffect.type === 'population') {
                                handLimit += region.wonderEffect.value;
                            }
                        }
                    }
                }
                
                return handLimit;
            }
            
            // ç»“æŸå›åˆ
            function endTurn() {
                // è·å–å½“å‰æ‰‹ç‰Œä¸Šé™
                const currentHandLimit = getCurrentHandLimit();

                // å¦‚æœæ‰‹ç‰Œå·²æ»¡ä¸”ç‰Œåº“è¿˜æœ‰ç‰Œï¼Œæç¤ºç©å®¶å…ˆå¼ƒç‰Œ
                if (gameState.hand.length >= currentHandLimit && gameState.deck.length > 0) {
                    showDiscardPrompt();
                    return;
                }

                // --- æ–°å¢ï¼šå¤„ç†æœªè§£é™¤çš„æˆ˜äº‰åŒºåŸŸ ---
                const unresolvedCombatZones = [];
                for (const pathId of PATHS) {
                    for (let i = 0; i < gameState.regions[pathId].length; i++) {
                        const region = gameState.regions[pathId][i];
                        // æŸ¥æ‰¾å·²æ¢ç´¢çš„æˆ˜äº‰åŒºåŸŸä¸”ä»ç„¶é˜»å¡ä¸‹ä¸€æ ¼çš„åŒºåŸŸ
                        if (region.status === 'explored' &&
                            region.type === 'combat' &&
                            region.combatData &&
                            region.combatData.blocking) // ç†è®ºä¸Šå·²æ¢ç´¢æœªè§£é™¤çš„æˆ˜äº‰åŒºblockingåº”è¯¥ä¸ºtrue
                        {
                            unresolvedCombatZones.push({ pathId: pathId, index: i });
                        }
                    }
                }

                // å¯¹æ¯ä¸ªæœªè§£é™¤çš„æˆ˜äº‰åŒºåŸŸåº”ç”¨æƒ©ç½šå¹¶è½¬æ¢ä¸ºé—å¿˜åŒºåŸŸ
                if (unresolvedCombatZones.length > 0) {
                    addLogEntry("å›åˆç»“æŸï¼Œå¤„ç†æœªè§£é™¤çš„æˆ˜äº‰åŒºåŸŸ...");
                    for (const { pathId, index } of unresolvedCombatZones) {
                        const region = gameState.regions[pathId][index];
                        // è°ƒç”¨å¤„ç†æƒ©ç½šçš„å‡½æ•°ï¼Œè¿™å°†åº”ç”¨æ•ˆæœå¹¶è½¬æ¢ä¸ºé—å¿˜åŒºåŸŸ
                        resolveCombatWithPenalty(pathId, index);
                        // resolveCombatWithPenalty å†…éƒ¨ä¼šæ›´æ–°åŒºåŸŸçŠ¶æ€å’Œæ—¥å¿—
                    }
                }
                // --- æ–°å¢ç»“æŸ ---


                // è®¡ç®—å›åˆå¾—åˆ†å’Œå¥‡è§‚æ•ˆæœ
                let turnPoints = 0;
                let extraDraws = 0;  // è®°å½•å¥‡è§‚æä¾›çš„é¢å¤–æŠ½ç‰Œæ¬¡æ•°
                let wonderEffects = []; // è®°å½•æ¿€æ´»çš„å¥‡è§‚æ•ˆæœ
                let lossEffects = []; // è®°å½•æ”¶å…¥æŸå¤±æ•ˆæœ

                // éå†æ‰€æœ‰åŒºåŸŸï¼Œç»“ç®—å é¢†åŒºåŸŸçš„åˆ†æ•°å’Œå¥‡è§‚æ•ˆæœ
                for (const pathId of PATHS) {
                    // è®¡ç®—å½“å‰è·¯å¾„çš„æ€»æ”¶å…¥ï¼ˆä¸å«æ”¶å…¥æŸå¤±ï¼‰
                    let pathIncome = 0;

                    for (const region of gameState.regions[pathId]) {
                        // ç´¯è®¡è¯¥è·¯å¾„çš„æ‰€æœ‰æ”¶å…¥ (åªè®¡ç®—å é¢†åŒºåŸŸ)
                        if (region.status === 'occupied' && region.points > 0) {
                            pathIncome += region.points;
                        }

                        // å¤„ç†å¥‡è§‚ç‰¹æ®Šæ•ˆæœ (ä»…é’ˆå¯¹å é¢†çŠ¶æ€çš„å¥‡è§‚)
                        if (region.status === 'occupied' && region.type === 'wonder' && region.wonderData && region.wonderEffect) {
                            const effect = region.wonderEffect;

                            // å¤„ç†æŠ½å¡æ•ˆæœ (è®°å½•ä¸‹æ¥ï¼Œç¨åç»Ÿä¸€æŠ½ç‰Œ)
                            if (effect.type === 'draw') {
                                extraDraws += effect.value;
                                wonderEffects.push(`ã€Œ${region.wonderData.name}ã€: å¤šæŠ½${effect.value}å¼ `);
                            }

                            // å¤„ç†èŠ±è‰²åŠ æˆæ•ˆæœ (é‡æ–°è®¡ç®—åˆ†æ•°å¹¶è®°å½•)
                            if (effect.type === 'suit_bonus') {
                                // é‡æ–°è®¡ç®—èŠ±è‰²æ•°é‡å’Œå¾—åˆ†
                                if (effect.formula === 'squared') {
                                    // è®¡ç®—è¯¥è·¯å¾„ä¸ŠåŒ¹é…èŠ±è‰²çš„æ•°é‡
                                    let suitCount = 0;
                                    for (const r of gameState.regions[effect.pathId]) {
                                        if (r.status === 'occupied' && r.occupyCard && r.occupyCard.suit === effect.suit) {
                                            suitCount++;
                                        }
                                    }

                                    // ä½¿ç”¨å¯¹åº”å€ç‡Ã—nÂ²å…¬å¼è®¡ç®—å¾—åˆ†
                                    const newPoints = effect.multiplier * (suitCount * suitCount);

                                    // æ›´æ–°åŒºåŸŸå¾—åˆ† (è¿™ä¸ªå¾—åˆ†ä¼šåœ¨æœ¬æ¬¡å¾ªç¯ä¸­çš„pathIncome += region.points;ä¸­è¢«ç´¯åŠ )
                                    region.points = newPoints;

                                    // è®°å½•æ•ˆæœæè¿°
                                    wonderEffects.push(`ã€Œ${region.wonderData.name}ã€: ${PATH_NAMES[effect.pathId]}è·¯å¾„ä¸Š${SUIT_SYMBOLS[effect.suit]}(${suitCount}ä¸ª): ${newPoints}åˆ†/å›åˆ`);

                                    // é‡æ–°æ¸²æŸ“è¿™ä¸ªå¥‡è§‚çš„æ˜¾ç¤ºï¼Œä»¥æ›´æ–°åˆ†æ•°
                                    // æˆ‘ä»¬åœ¨å¾ªç¯ç»“æŸå‰ç»Ÿä¸€æ›´æ–°åŒºåŸŸæ˜¾ç¤ºï¼Œæ‰€ä»¥è¿™é‡Œä¸éœ€è¦
                                    // updateRegionDisplay(pathId, i); // è¿™é‡Œçš„ i éœ€è¦è·å– region åœ¨ pathId æ•°ç»„ä¸­çš„å®é™…ç´¢å¼•
                                } else {
                                    // å¦‚æœæ˜¯å…¶ä»–ç±»å‹çš„èŠ±è‰²æ”¶è·æ•ˆæœ (è™½ç„¶ç›®å‰åªæœ‰ squared)
                                    wonderEffects.push(`ã€Œ${region.wonderData.name}ã€: ${PATH_NAMES[effect.pathId]}è·¯å¾„ä¸Šçš„${SUIT_SYMBOLS[effect.suit]}æ”¶è·æ•ˆæœ (è®¡ç®—å·²åŒ…å«åœ¨å¾—åˆ†ä¸­)`);
                                }
                            } else {
                                // Other wonder effects (draw, population, score, explore)
                                if (effect.type === 'draw') wonderEffects.push(`ã€Œ${region.wonderData.name}ã€: å¤šæŠ½${effect.value}å¼ `);
                                if (effect.type === 'population') wonderEffects.push(`ã€Œ${region.wonderData.name}ã€: æ‰‹ç‰Œä¸Šé™+${effect.value}`);
                                if (effect.type === 'score') wonderEffects.push(`ã€Œ${region.wonderData.name}ã€: æ¯å›åˆ+${region.points}åˆ†`); // Use region.points for score effect
                                if (effect.type === 'explore') { /* explore is immediate, log entry in processWonderEffects */ }
                            }
                            // å…¶ä»–å¥‡è§‚æ•ˆæœï¼ˆå¦‚äººå£ï¼‰åœ¨ calculatePointsPerTurn æˆ– getCurrentHandLimit ä¸­å¤„ç†ï¼Œä¸éœ€è¦åœ¨è¿™é‡Œç´¯åŠ åˆ†æ•°
                        }
                    }

                    // --- æ–°å¢ï¼šç»“ç®—æ å¤ºæƒ©ç½š ---
                    if (gameState.pillagePenalties && gameState.pillagePenalties[pathId] && gameState.pillagePenalties[pathId].length > 0) {
                        // ç´¯åŠ è¯¥è·¯å¾„æ‰€æœ‰çš„æ å¤ºå€ç‡
                        const totalMultiplier = gameState.pillagePenalties[pathId].reduce((sum, mult) => sum + mult, 0);
                        // è®¡ç®—æŸå¤±ç‚¹æ•° (è·¯å¾„æ”¶å…¥ * æ€»å€ç‡)ï¼ŒæŸå¤±æœ€å¤šä¸è¶…è¿‡å½“å‰è·¯å¾„æ€»æ”¶å…¥ï¼ˆæ”¶å…¥ä¸ä¼šå˜æˆè´Ÿæ•°ï¼‰
                        const lossAmount = pathIncome * totalMultiplier; // è®¡ç®—æ€»æŸå¤±ç‚¹æ•°
                        const actualLoss = lossAmount; // å®é™…æŸå¤±ç‚¹æ•° (ç›®å‰æ²¡æœ‰ç‰¹æ®Šè§„åˆ™ï¼Œå®é™…æŸå¤±ç­‰äºè®¡ç®—å‡ºçš„æŸå¤±)
                        //Math.min(lossAmount, pathIncome); // å®é™…æŸå¤±ä¸è¶…è¿‡å½“å‰æ”¶å…¥

                        if (actualLoss > 0) {
                            addLogEntry(`ã€Œæ å¤ºã€æ•ˆæœç»“ç®—: ${PATH_NAMES[pathId]}è·¯å¾„æ”¶å…¥ ${pathIncome}åˆ†ï¼Œæ€»å€ç‡ ${totalMultiplier}xï¼Œå®é™…æŸå¤± ${actualLoss}åˆ†`);
                            pathIncome -= actualLoss; // ä»è·¯å¾„æ”¶å…¥ä¸­æ‰£é™¤æŸå¤±
                        } else if (lossAmount > 0) { // å¦‚æœæŸå¤±ç‚¹æ•° > 0 ä½†å®é™…æŸå¤±ä¸º0 (å› ä¸º pathIncome æ˜¯ 0)
                            addLogEntry(`ã€Œæ å¤ºã€æ•ˆæœç»“ç®—: ${PATH_NAMES[pathId]}è·¯å¾„æ”¶å…¥ ${pathIncome}åˆ†ï¼Œæ€»å€ç‡ ${totalMultiplier}xï¼Œæ— å®é™…æ”¶å…¥æŸå¤±`);
                        }
                        // æ³¨æ„ï¼šå³ä½¿ lossAmount æ˜¯ 0 (ä¾‹å¦‚ pathIncome æ˜¯ 0)ï¼ŒrecordPillagePenalty ä»ç„¶è®°å½•äº†æƒ©ç½šè§¦å‘æ—¥å¿—ã€‚è¿™é‡Œæ˜¯ç»“ç®—æ—¥å¿—ã€‚
                    }

                    // å°†è¯¥è·¯å¾„çš„æ”¶å…¥åŠ å…¥æ€»å¾—åˆ†
                    turnPoints += pathIncome;
                }


                gameState.pillagePenalties = {};

                // é‡æ–°æ¸²æŸ“æ‰€æœ‰åŒºåŸŸï¼Œç¡®ä¿èŠ±è‰²æ”¶è·å¥‡è§‚çš„åˆ†æ•°æ›´æ–°æ˜¾ç¤º
                updateAllRegionsDisplay();

                // æ¸…é™¤æœ¬å›åˆçš„æ”¶å…¥æŸå¤±æ•ˆæœï¼Œå› ä¸ºå·²ç»å¤„ç†è¿‡äº†
                gameState.incomeLoss = {};


                // æ›´æ–°æ€»åˆ†
                gameState.score += turnPoints;
                scoreDisplay.textContent = gameState.score;

                // æ›´æ–°å³ä¸‹è§’ä¿¡æ¯æ  (åŒ…æ‹¬æ¯å›åˆå¾—åˆ†)
                updateCornerInfo();

                // å¢åŠ å›åˆæ•°
                gameState.turn++;
                turnCounter.textContent = gameState.turn;

                // è®°å½•æ“ä½œå’Œå¥‡è§‚æ•ˆæœã€æ”¶å…¥æŸå¤±
                let logMessage = `${t('turnEnded', {points: turnPoints})}`;
                if (wonderEffects.length > 0) {
                    logMessage += ` (å¥‡è§‚: ${wonderEffects.join(", ")})`;
                }
                /*
                if (lossEffects.length > 0) {
                    logMessage += ` (æƒ©ç½š: ${lossEffects.join(", ")})`;
                }*/
                addLogEntry(logMessage);

                // æŠ½ç‰Œå¤„ç† - å…ˆæŠ½åŸºç¡€ç‰Œï¼Œç„¶åæŠ½å¥‡è§‚æä¾›çš„é¢å¤–ç‰Œ
                let cardsDrawn = [];

                // åŸºç¡€æŠ½ç‰Œ - æ¯å›åˆæŠ½1å¼  (å³ä½¿ç‰Œåº“ç©ºä¹Ÿå°è¯•ï¼ŒdrawCardä¼šè¿”å›null)
                const baseDrawCard = drawCard();
                if (baseDrawCard) {
                    gameState.hand.push(baseDrawCard);
                    cardsDrawn.push(`${baseDrawCard.rank}${SUIT_SYMBOLS[baseDrawCard.suit]}`);
                }


                // å¥‡è§‚é¢å¤–æŠ½ç‰Œ
                for (let i = 0; i < extraDraws; i++) {
                    const extraCard = drawCard();
                    if (extraCard) {
                        gameState.hand.push(extraCard);
                        cardsDrawn.push(`${extraCard.rank}${SUIT_SYMBOLS[extraCard.suit]}`);
                    } else {
                        // å¦‚æœç‰Œåº“æŠ½ç©ºäº†ï¼Œåœæ­¢é¢å¤–æŠ½ç‰Œ
                        break;
                    }
                }


                // è®°å½•æŠ½ç‰Œ
                if (cardsDrawn.length > 0) {
                    const drawMessage = cardsDrawn.length === 1
                        ? `æŠ½äº†ä¸€å¼ ç‰Œ: ${cardsDrawn[0]}`
                        : `æŠ½äº†${cardsDrawn.length}å¼ ç‰Œ: ${cardsDrawn.join(", ")}`;
                    addLogEntry(drawMessage);
                } else if (gameState.deck.length === 0) {
                    // å¦‚æœç‰Œåº“ç©ºäº†ï¼Œä¸”æ²¡æœ‰æŠ½åˆ°ç‰Œï¼Œè®°å½•ä¸€ä¸‹
                    addLogEntry(`ç‰Œåº“å·²ç©ºï¼Œæ²¡æœ‰æŠ½åˆ°ç‰Œ`);
                }


                // é‡æ–°æ¸²æŸ“æ‰‹ç‰Œ
                renderHand();

                // æ˜¾ç¤ºæ¶ˆæ¯ (å¯ä»¥ç®€åŒ–ï¼Œä¸»è¦ä¿¡æ¯å·²ç»åœ¨æ—¥å¿—é‡Œ)
                // showMessage(t('turnEnded', {points: turnPoints}));


                // æ£€æŸ¥æ¸¸æˆæ˜¯å¦ç»“æŸ
                checkGameOver();

                // ä¿å­˜æ¸¸æˆçŠ¶æ€åˆ°å†å²è®°å½•
                addToHistory(saveGameState());
            }
            
            /*
            // æ£€æŸ¥æ¸¸æˆæ˜¯å¦ç»“æŸ
            function checkGameOver() {
                // å¦‚æœæ²¡æœ‰ç‰Œå¯æŠ½å¹¶ä¸”æ‰‹ç‰Œä¸ºç©ºï¼Œæ¸¸æˆç»“æŸ
                if (gameState.deck.length === 0 && gameState.hand.length === 0) {
                    gameState.gameOver = true;
                    
                    // æ˜¾ç¤ºç»“æœå¼¹çª—
                    finalScoreDisplay.textContent = gameState.score;
                    resultModal.classList.remove('hidden');
                }
            }*/
            function checkGameOver() {
                if (gameState.turn > 80) {
                    gameState.gameOver = true;

                    // æ˜¾ç¤ºç»“æœå¼¹çª—
                    finalScoreDisplay.textContent = gameState.score;
                    resultModal.classList.remove('hidden');
                }
                    
            }
            
            // åˆ›å»ºå¹¶æ´—ç‰Œ
            function createDeck() {
                const deck = [];
                
                for (const suit of SUITS) {
                    for (const rank of RANKS) {
                        deck.push({ suit, rank });
                    }
                }
                
                return deck;
            }
            
            // Fisher-Yatesæ´—ç‰Œï¼Œä½¿ç”¨seededRandom
            function shuffleDeck(deck) {
                const shuffled = [...deck];
                
                for (let i = shuffled.length - 1; i > 0; i--) {
                    const j = Math.floor(seededRandom() * (i + 1));
                    [shuffled[i], shuffled[j]] = [shuffled[j], shuffled[i]];
                }
                
                return shuffled;
            }
            
            // æŠ½ä¸€å¼ ç‰Œ
            function drawCard() {
                if (gameState.deck.length === 0) {
                    return null;
                }
                
                remainingCardsDisplay.textContent = gameState.deck.length - 1;
                return gameState.deck.pop();
            }
            
            // æ¸²æŸ“æ‰‹ç‰Œ
            function renderHand() {
                // è·å–å½“å‰æ‰‹ç‰Œä¸Šé™
                const currentHandLimit = getCurrentHandLimit();
                
                // æ›´æ–°æ‰‹ç‰Œä¸Šé™æ˜¾ç¤º
                const handLimitEl = document.getElementById('hand-limit');
                const rulesHandLimitEl = document.getElementById('rules-hand-limit');
                
                if (handLimitEl) handLimitEl.textContent = currentHandLimit;
                if (rulesHandLimitEl) rulesHandLimitEl.textContent = currentHandLimit;
                
                handContainer.innerHTML = '';
                
                if (gameState.hand.length === 0) {
                    const emptyText = document.createElement('div');
                    emptyText.className = 'text-gray-400 dark:text-gray-600 text-center w-full py-4';
                    emptyText.textContent = 'æ²¡æœ‰æ‰‹ç‰Œ';
                    handContainer.appendChild(emptyText);
                } else {
                    gameState.hand.forEach((card, index) => {
                        const cardElement = document.createElement('div');
                        const isSelected = gameState.selectedCards.includes(index);
                        cardElement.className = `card hand-card transition-transform duration-200 w-16 h-24 md:w-20 md:h-30 bg-white dark:bg-gray-800 border border-gray-300 dark:border-gray-700 rounded-lg shadow-md flex flex-col items-center justify-center ${isSelected ? 'border-primary border-2 -translate-y-4' : ''}`;
                        cardElement.dataset.index = index;
                        
                        // å¡ç‰Œå†…å®¹
                        const rankElement = document.createElement('div');
                        rankElement.className = 'text-sm md:text-base';
                        rankElement.textContent = card.rank;
                        
                        const suitElement = document.createElement('div');
                        suitElement.className = `${card.suit} text-lg md:text-2xl`;
                        suitElement.textContent = SUIT_SYMBOLS[card.suit];
                        
                        cardElement.appendChild(rankElement);
                        cardElement.appendChild(suitElement);
                        
                        // æ·»åŠ ç‚¹å‡»äº‹ä»¶
                        cardElement.addEventListener('click', () => selectCard(index));
                        
                        handContainer.appendChild(cardElement);
                    });
                }
                
                // æ›´æ–°æ‰‹ç‰Œè®¡æ•°
                const handCountEl = document.getElementById('hand-count');
                if (handCountEl) {
                    handCountEl.textContent = gameState.hand.length;
                    
                    // å¦‚æœæ‰‹ç‰Œæ¥è¿‘ä¸Šé™ï¼Œé«˜äº®æ˜¾ç¤º
                    const warningThreshold = Math.max(8, currentHandLimit - 2); // åªæœ‰æ¥è¿‘ä¸Šé™æ‰æ˜¾ç¤ºè­¦å‘Š
                    
                    if (gameState.hand.length >= warningThreshold) {
                        handCountEl.className = 'font-bold';
                        if (gameState.hand.length >= currentHandLimit) {
                            handCountEl.className += ' text-red-500 dark:text-red-400';
                        } else {
                            handCountEl.className += ' text-yellow-500 dark:text-yellow-400';
                        }
                    } else {
                        handCountEl.className = '';
                    }
                }
                
                // æ›´æ–°å¼ƒç‰ŒæŒ‰é’®çŠ¶æ€
                const discardBtn = document.getElementById('discard-btn');
                if (discardBtn) {
                    discardBtn.disabled = gameState.selectedCards.length === 0;
                    discardBtn.classList.toggle('opacity-50', gameState.selectedCards.length === 0);
                }
            }
            
            // é€‰æ‹©æ‰‹ç‰Œï¼ˆæ”¯æŒå¤šé€‰ï¼‰
            function selectCard(index) {
                // æ£€æŸ¥è¯¥ç‰Œæ˜¯å¦å·²ç»è¢«é€‰ä¸­
                const cardIndex = gameState.selectedCards.indexOf(index);
                
                if (cardIndex !== -1) {
                    // å¦‚æœå·²ç»é€‰ä¸­ï¼Œå–æ¶ˆé€‰æ‹©
                    gameState.selectedCards.splice(cardIndex, 1);
                } else {
                    // å¦åˆ™æ·»åŠ åˆ°é€‰ä¸­åˆ—è¡¨
                    gameState.selectedCards.push(index);
                }
                
                // æ›´æ–°é€‰ä¸­å¡ç‰Œæ•°é‡æ˜¾ç¤º
                const selectedCountEl = document.getElementById('selected-count');
                if (selectedCountEl) {
                    selectedCountEl.textContent = gameState.selectedCards.length;
                }
                
                // æ›´æ–°æ“ä½œä¿¡æ¯æç¤º
                if (gameState.selectedCards.length === 0) {
                    actionInfoElement.textContent = '';
                } else if (gameState.selectedCards.length === 1) {
                    const card = gameState.hand[gameState.selectedCards[0]];
                    actionInfoElement.textContent = `å·²é€‰æ‹©: ${card.rank}${SUIT_SYMBOLS[card.suit]} - ç‚¹å‡»åŒºåŸŸæ‰§è¡Œæ“ä½œ`;
                } else {
                    actionInfoElement.textContent = `å·²é€‰æ‹© ${gameState.selectedCards.length} å¼ ç‰Œ`;
                }
                
                // æ›´æ–°å¼ƒç‰ŒæŒ‰é’®çŠ¶æ€
                const discardBtn = document.getElementById('discard-btn');
                if (discardBtn) {
                    discardBtn.disabled = gameState.selectedCards.length === 0;
                    discardBtn.classList.toggle('opacity-50', gameState.selectedCards.length === 0);
                }
                
                // é‡æ–°æ¸²æŸ“æ‰‹ç‰Œï¼Œæ˜¾ç¤ºé€‰ä¸­çŠ¶æ€
                renderHand();
            }
            
            // é€‰æ‹©è¡ŒåŠ¨
            function selectAction(action) {
                // å¦‚æœå·²ç»é€‰æ‹©äº†è¿™ä¸ªè¡ŒåŠ¨ï¼Œå–æ¶ˆé€‰æ‹©
                if (gameState.selectedAction === action) {
                    resetSelectionState();
                } else {
                    gameState.selectedAction = action;
                    gameState.selectedCard = null; // é‡ç½®é€‰ä¸­çš„å¡ç‰Œ
                    
                    // æ›´æ–°æŒ‰é’®æ ·å¼
                    document.getElementById('explore-btn').classList.toggle('ring-2', action === 'explore');
                    document.getElementById('occupy-btn').classList.toggle('ring-2', action === 'occupy');
                    
                    // æ˜¾ç¤ºç›¸å…³æç¤º
                    if (action === 'explore') {
                        showMessage(t('infoSelectCardToExplore'));
                    } else if (action === 'occupy') {
                        showMessage(t('infoSelectCardToOccupy'));
                    }
                }
                
                // æ›´æ–°æ“ä½œä¿¡æ¯
                updateActionInfo();
            }
            
            // é‡ç½®é€‰æ‹©çŠ¶æ€
            function resetSelectionState() {
                gameState.selectedAction = '';
                gameState.selectedCards = [];
                
                // æ›´æ–°é€‰ä¸­å¡ç‰Œæ•°é‡æ˜¾ç¤º
                const selectedCountEl = document.getElementById('selected-count');
                if (selectedCountEl) {
                    selectedCountEl.textContent = 0;
                }
                
                // é‡æ–°æ¸²æŸ“æ‰‹ç‰Œ
                renderHand();
                
                // æ¸…ç©ºæ“ä½œä¿¡æ¯
                actionInfoElement.textContent = '';
            }
            
            // æ›´æ–°æ“ä½œä¿¡æ¯
            function updateActionInfo() {
                if (!gameState.selectedAction) {
                    actionInfoElement.textContent = '';
                    return;
                }
                
                if (gameState.selectedCard === null) {
                    actionInfoElement.textContent = t('selectCard');
                } else {
                    const card = gameState.hand[gameState.selectedCard];
                    
                    if (gameState.selectedAction === 'explore') {
                        actionInfoElement.textContent = `æ¢ç´¢: ä½¿ç”¨ ${card.rank}${SUIT_SYMBOLS[card.suit]} æ¢ç´¢æœªå é¢†åŒºåŸŸ`;
                    } else if (gameState.selectedAction === 'occupy') {
                        actionInfoElement.textContent = `å é¢†: ä½¿ç”¨ ${card.rank}${SUIT_SYMBOLS[card.suit]} å é¢†å·²æ¢ç´¢åŒºåŸŸ`;
                    }
                }
            }
            
            // æ˜¾ç¤ºæ¶ˆæ¯
            function showMessage(message) {
                gameMessageElement.textContent = message;
                
                // æ·»åŠ åŠ¨ç”»æ•ˆæœ
                gameMessageElement.classList.add('text-primary');
                setTimeout(() => {
                    gameMessageElement.classList.remove('text-primary');
                }, 2000);
            }
            
            // æ·»åŠ æ—¥å¿—æ¡ç›®
            function addLogEntry(message) {
                const logEntry = document.createElement('div');
                logEntry.className = 'mb-1 pb-1 border-b border-gray-200 dark:border-gray-700';
                
                // å›åˆå‰ç¼€
                const turnPrefix = document.createElement('span');
                turnPrefix.className = 'font-bold';
                turnPrefix.textContent = `[${gameState.turn}] `;
                
                logEntry.appendChild(turnPrefix);
                logEntry.appendChild(document.createTextNode(message));
                
                gameLogElement.insertBefore(logEntry, gameLogElement.firstChild);
                
                // è®°å½•åˆ°æ—¥å¿—æ•°æ®
                gameLogData.push({
                    turn: gameState.turn,
                    message: message,
                    timestamp: new Date().toISOString(),
                    score: gameState.score
                });
            }
            
            // ä¿å­˜æ¸¸æˆçŠ¶æ€
            function saveGameState() {
                return {
                    deck: [...gameState.deck],
                    hand: [...gameState.hand],
                    discardPile: [...gameState.discardPile],
                    score: gameState.score,
                    turn: gameState.turn,
                    currentSeed: gameState.currentSeed,
                    regions: JSON.parse(JSON.stringify(gameState.regions)),
                    gameOver: gameState.gameOver,
                    conqueredPaths: gameState.conqueredPaths ? {...gameState.conqueredPaths} : {}, // Save conquered paths
                    pillagePenalties: gameState.pillagePenalties ? JSON.parse(JSON.stringify(gameState.pillagePenalties)) : {} // <-- æ–°å¢ï¼šä¿å­˜æ å¤ºæƒ©ç½š
                };
            }

            
            // å°†æ–°çŠ¶æ€æ·»åŠ åˆ°å†å²è®°å½•
            function addToHistory(state) {
                // å¦‚æœåœ¨å†å²ä¸­é—´ç‚¹è¿›è¡Œäº†æ–°æ“ä½œï¼Œåˆ é™¤è¯¥ç‚¹ä¹‹åçš„æ‰€æœ‰å†å²
                if (currentHistoryIndex >= 0 && currentHistoryIndex < history.length - 1) {
                    history = history.slice(0, currentHistoryIndex + 1);
                }
                
                // æ·»åŠ æ–°çŠ¶æ€åˆ°å†å²è®°å½•
                history.push(state);
                currentHistoryIndex = history.length - 1;
                
                // æ›´æ–°æ’¤é”€æŒ‰é’®çŠ¶æ€
                updateUndoButton();
            }
            
            // æ¢å¤æ¸¸æˆçŠ¶æ€
            function restoreGameState(state) {
                // æ¢å¤æ‰€æœ‰æ¸¸æˆçŠ¶æ€
                gameState.deck = [...state.deck];
                gameState.hand = [...state.hand];
                gameState.discardPile = [...state.discardPile];
                gameState.score = state.score;
                gameState.turn = state.turn;
                gameState.currentSeed = state.currentSeed;
                gameState.regions = JSON.parse(JSON.stringify(state.regions));
                gameState.gameOver = state.gameOver;
                gameState.conqueredPaths = state.conqueredPaths ? {...state.conqueredPaths} : {}; // Restore conquered paths
                gameState.pillagePenalties = state.pillagePenalties ? JSON.parse(JSON.stringify(state.pillagePenalties)) : {}; // <-- æ–°å¢ï¼šæ¢å¤æ å¤ºæƒ©ç½š

                // é‡ç½®é€‰æ‹©çŠ¶æ€
                resetSelectionState();
                
                // æ›´æ–°UI
                scoreDisplay.textContent = gameState.score;
                turnCounter.textContent = gameState.turn;
                remainingCardsDisplay.textContent = gameState.deck.length;
                
                // é‡æ–°æ¸²æŸ“æ‰‹ç‰Œ
                renderHand();
                
                // æ›´æ–°æ‰€æœ‰åŒºåŸŸæ˜¾ç¤º
                updateAllRegionsDisplay();
                
                // æ›´æ–°æ’¤é”€æŒ‰é’®çŠ¶æ€
                updateUndoButton();
                
                // å¦‚æœæ¸¸æˆç»“æŸï¼Œæ˜¾ç¤ºç»“æœå¼¹çª—
                if (gameState.gameOver) {
                    finalScoreDisplay.textContent = gameState.score;
                    resultModal.classList.remove('hidden');
                } else {
                    resultModal.classList.add('hidden');
                }
            }
            
            // æ›´æ–°æ‰€æœ‰åŒºåŸŸæ˜¾ç¤º
            function updateAllRegionsDisplay() {
                for (const pathId of PATHS) {
                    for (let i = 0; i < 13; i++) {
                        updateRegionDisplay(pathId, i);
                    }
                }
            }
            
            // æ›´æ–°æ‰€æœ‰èŠ±è‰²æ”¶è·å¥‡è§‚çš„åˆ†æ•°
            function updateAllSuitBonusWonders(changedPathId = null, changedSuit = null) {
                // éå†æ‰€æœ‰è·¯å¾„å¯»æ‰¾èŠ±è‰²æ”¶è·å¥‡è§‚
                for (const pathId of PATHS) {
                    for (let i = 0; i < 13; i++) {
                        const region = gameState.regions[pathId][i];
                        
                        // æ£€æŸ¥æ˜¯å¦æ˜¯å·²å é¢†çš„å¥‡è§‚ä¸”æœ‰èŠ±è‰²æ”¶è·æ•ˆæœ
                        if (region.status === 'occupied' && 
                            region.type === 'wonder' && 
                            region.wonderData && 
                            region.wonderEffect && 
                            region.wonderEffect.type === 'suit_bonus') {
                            
                            const effect = region.wonderEffect;
                            
                            // å¦‚æœæŒ‡å®šäº†changedPathIdå’ŒchangedSuitï¼Œåªæ›´æ–°å—å½±å“çš„å¥‡è§‚
                            if (changedPathId && changedSuit) {
                                // å¦‚æœå¥‡è§‚ç›‘æ§çš„è·¯å¾„ä¸æ˜¯å˜æ›´çš„è·¯å¾„ï¼Œæˆ–è€…ç›‘æ§çš„èŠ±è‰²ä¸æ˜¯å˜æ›´çš„èŠ±è‰²ï¼Œåˆ™è·³è¿‡
                                if (effect.pathId !== changedPathId || effect.suit !== changedSuit) {
                                    continue;
                                }
                            }
                            
                            // è®¡ç®—è¯¥è·¯å¾„ä¸ŠåŒ¹é…èŠ±è‰²çš„æ•°é‡
                            let suitCount = 0;
                            for (const r of gameState.regions[effect.pathId]) {
                                if (r.status === 'occupied' && r.occupyCard && r.occupyCard.suit === effect.suit) {
                                    suitCount++;
                                }
                            }
                            
                            // æ ¹æ®å¥‡è§‚ç­‰çº§ä½¿ç”¨ä¸åŒå€ç‡è®¡ç®—æ–°çš„å¾—åˆ†
                            let multiplier;
                            if (region.wonderData.tier === 'orange') {
                                multiplier = 6; // æ©™è‰²å¥‡è§‚ï¼š6Ã—nÂ²
                            } else if (region.wonderData.tier === 'purple') {
                                multiplier = 4; // ç´«è‰²å¥‡è§‚ï¼š4Ã—nÂ²
                            } else {
                                multiplier = 3; // è“è‰²å¥‡è§‚ï¼š3Ã—nÂ²
                            }
                            
                            const newPoints = multiplier * (suitCount * suitCount);
                            
                            // å¦‚æœå¾—åˆ†å‘ç”Ÿå˜åŒ–ï¼Œæ›´æ–°åŒºåŸŸå¾—åˆ†
                            if (region.points !== newPoints) {
                                region.points = newPoints;
                                // æ›´æ–°åŒºåŸŸæ˜¾ç¤º
                                updateRegionDisplay(pathId, i);
                            }
                        }
                    }
                }
            }
            
            // æ›´æ–°æ’¤é”€æŒ‰é’®çŠ¶æ€
            function updateUndoButton() {
                const undoBtn = document.getElementById('undo-btn');
                
                undoBtn.disabled = currentHistoryIndex <= 0;
                undoBtn.classList.toggle('opacity-50', currentHistoryIndex <= 0);
            }
            
            // æ’¤é”€æ“ä½œ
            function undoMove() {
                if (currentHistoryIndex > 0) {
                    currentHistoryIndex--;
                    restoreGameState(history[currentHistoryIndex]);
                }
            }
            
            // åˆ›å»ºä¸€ä¸ªç§å­éšæœºæ•°ç”Ÿæˆå™¨
            function createSeededRandom(seed) {
                // ç®€å•çš„å“ˆå¸Œå‡½æ•°
                let hash = Array.from(seed).reduce((acc, char) => {
                    return ((acc << 5) - acc) + char.charCodeAt(0) | 0;
                }, 0);
                
                return function() {
                    const x = Math.sin(hash++) * 10000;
                    return x - Math.floor(x);
                };
            }
            
            // æ˜¾ç¤ºæç¤ºä¿¡æ¯
            function showToast(message) {
                toastElement.textContent = message;
                toastElement.classList.add('opacity-100');
                
                setTimeout(() => {
                    toastElement.classList.remove('opacity-100');
                }, 2000);
            }
            
            // å¤åˆ¶ç§å­
            function copySeed() {
                navigator.clipboard.writeText(gameState.currentSeed).then(() => {
                    showToast(t('copied'));
                });
            }
            
            // åˆ†äº«æ¸¸æˆ
            function shareGame() {
                let shareUrl;
                
                // å¤„ç† about:srcdoc ç‰¹æ®Šæƒ…å†µï¼ˆåœ¨ Poe ç¯å¢ƒä¸­ï¼‰
                if (!window.location.href || window.location.href === "about:srcdoc") {
                    // åœ¨ Poe iframe ä¸­ä½¿ç”¨å›ºå®šçš„ URL
                    shareUrl = "https://poe.com/4XPoker";
                } else {
                    // åœ¨å…¶ä»–ç¯å¢ƒä¸­ä½¿ç”¨å½“å‰ URL çš„åŸºç¡€éƒ¨åˆ†
                    const url = new URL(window.location.href);
                    shareUrl = url.origin + url.pathname;
                }
                
                // ä½¿ç”¨ code å‚æ•°æ›¿ä»£ seed å‚æ•°
                shareUrl += "?code=" + encodeURIComponent(gameState.currentSeed);
                
                const shareText = t('shareText', {
                    score: gameState.score,
                    seed: gameState.currentSeed
                });
                
                // å°†å®Œæ•´çš„åˆ†äº«é“¾æ¥æ·»åŠ åˆ°æ–‡æœ¬æœ«å°¾
                const fullShareText = `${shareText}\n${shareUrl}`;
                
                navigator.clipboard.writeText(fullShareText).then(() => {
                    showToast(t('copied'));
                }).catch(err => {
                    console.error('Share failed:', err);
                });
            }
            
            // æ›´æ–°å¼ƒç‰Œå †è®¡æ•°
            function updateDiscardCount() {
                const discardCountEl = document.getElementById('discard-count');
                if (discardCountEl) {
                    discardCountEl.textContent = gameState.discardPile.length;
                }
            }
            
            // è®¡ç®—æ¯å›åˆæ€»å¾—åˆ†
            function calculatePointsPerTurn() {
                let totalPoints = 0;
                
                // éå†æ‰€æœ‰åŒºåŸŸï¼Œè®¡ç®—å é¢†åŒºåŸŸçš„åˆ†æ•°
                for (const pathId of PATHS) {
                    for (const region of gameState.regions[pathId]) {
                        // ç´¯åŠ æ‰€æœ‰å é¢†åŒºåŸŸçš„å¾—åˆ†
                        if (region.status === 'occupied' && region.points > 0) {
                            totalPoints += region.points;
                        }
                    }
                }
                
                return totalPoints;
            }
            
            // æ›´æ–°å³ä¸‹è§’å’Œæµ®åŠ¨ä¿¡æ¯æ 
            function updateCornerInfo() {
                // å³ä¸‹è§’ä¿¡æ¯æ 
                const scoreCorner = document.getElementById('score-corner');
                const turnCorner = document.getElementById('turn-corner');
                const remainingCorner = document.getElementById('remaining-corner');
                const discardCorner = document.getElementById('discard-corner');
                const pointsPerTurn = document.getElementById('points-per-turn');
                
                // æµ®åŠ¨ä¿¡æ¯æ 
                const floatScore = document.getElementById('float-score');
                const floatTurn = document.getElementById('float-turn');
                const floatDeck = document.getElementById('float-deck');
                const floatDiscard = document.getElementById('float-discard');
                const floatPointsPerTurn = document.getElementById('float-points-per-turn');
                const estimatedScore = document.getElementById('estimated-score');
                
                // è®¡ç®—æ¯å›åˆå¾—åˆ†
                const points = calculatePointsPerTurn();
                
                // æ›´æ–°å³ä¸‹è§’ä¿¡æ¯
                if (scoreCorner) scoreCorner.textContent = gameState.score;
                if (turnCorner) turnCorner.textContent = gameState.turn;
                if (remainingCorner) remainingCorner.textContent = gameState.deck.length;
                if (discardCorner) discardCorner.textContent = gameState.discardPile.length;
                
                // æ›´æ–°æ¯å›åˆå¾—åˆ†
                if (pointsPerTurn) {
                    pointsPerTurn.textContent = '+' + points;
                    
                    // æ ¹æ®å¾—åˆ†è°ƒæ•´æ˜¾ç¤ºæ ·å¼
                    if (points >= 300) {
                        pointsPerTurn.className = 'text-red-500 dark:text-red-400 font-bold';
                    } else if (points >= 200) {
                        pointsPerTurn.className = 'text-yellow-500 dark:text-yellow-400 font-bold';
                    } else if (points > 0) {
                        pointsPerTurn.className = 'text-green-600 dark:text-green-400 font-bold';
                    } else {
                        pointsPerTurn.className = 'text-gray-600 dark:text-gray-400';
                    }
                }
                
                // æ›´æ–°æµ®åŠ¨åŒºåŸŸä¿¡æ¯
                if (floatScore) floatScore.textContent = gameState.score;
                if (floatTurn) floatTurn.textContent = gameState.turn;
                if (floatDeck) floatDeck.textContent = gameState.deck.length;
                if (floatDiscard) floatDiscard.textContent = gameState.discardPile.length;
                
                // æ›´æ–°æµ®åŠ¨åŒºåŸŸæ¯å›åˆå¾—åˆ†
                if (floatPointsPerTurn) {
                    floatPointsPerTurn.textContent = '+' + points;
                    
                    // æ ¹æ®å¾—åˆ†è°ƒæ•´æ˜¾ç¤ºæ ·å¼
                    if (points >= 300) {
                        floatPointsPerTurn.className = 'text-red-500 dark:text-red-400 font-bold';
                    } else if (points >= 200) {
                        floatPointsPerTurn.className = 'text-yellow-500 dark:text-yellow-400 font-bold';
                    } else if (points > 0) {
                        floatPointsPerTurn.className = 'text-green-600 dark:text-green-400 font-bold';
                    } else {
                        floatPointsPerTurn.className = 'text-gray-600 dark:text-gray-400';
                    }
                }
                
                // è®¡ç®—å¹¶æ›´æ–°é¢„è®¡å¾—åˆ†
                if (estimatedScore) {
                    // è®¡ç®—é¢„è®¡å‰©ä½™å›åˆæ•°
                    // å›åˆæ•° = å‰©ä½™ç‰Œæ•° / æ¯å›åˆèµ·ç‰Œæ•°
                    // é»˜è®¤æ¯å›åˆèµ·1å¼ ç‰Œ
                    let cardsPerTurn = 1;
                    
                    // è®¡ç®—æ¯å›åˆé¢å¤–æŠ½ç‰Œæ•°
                    let extraDraws = 0;
                    for (const pathId of PATHS) {
                        for (const region of gameState.regions[pathId]) {
                            if (region.status === 'occupied' && 
                                region.type === 'wonder' && 
                                region.wonderData && 
                                region.wonderEffect &&
                                region.wonderEffect.type === 'draw') {
                                extraDraws += region.wonderEffect.value;
                            }
                        }
                    }
                    
                    // è°ƒæ•´æ¯å›åˆèµ·ç‰Œæ•°
                    cardsPerTurn += extraDraws;
                    
                    // è®¡ç®—é¢„è®¡å‰©ä½™å›åˆæ•°ï¼ˆæœ€å°‘1å›åˆï¼‰
                    //const estimatedRemainingTurns = Math.max(1, Math.ceil(gameState.deck.length / cardsPerTurn));
                    // æ”¹ä¸º 80å›åˆå‡å»å½“å‰å›åˆ
                    const estimatedRemainingTurns = Math.max(0, Math.ceil(80 - gameState.turn));
                    
                    // è®¡ç®—æœ€ç»ˆé¢„è®¡å¾—åˆ†
                    const finalEstimatedScore = gameState.score + (points * estimatedRemainingTurns);
                    
                    // æ›´æ–°é¢„è®¡å¾—åˆ†æ˜¾ç¤º
                    estimatedScore.textContent = finalEstimatedScore;
                    
                    // æ ¹æ®é¢„è®¡å¾—åˆ†è°ƒæ•´æ˜¾ç¤ºæ ·å¼
                    if (finalEstimatedScore >= 300) {
                        estimatedScore.className = 'text-red-500 dark:text-red-400 font-bold';
                    } else if (finalEstimatedScore >= 200) {
                        estimatedScore.className = 'text-yellow-500 dark:text-yellow-400 font-bold';
                    } else if (finalEstimatedScore >= 100) {
                        estimatedScore.className = 'text-green-500 dark:text-green-400 font-bold';
                    } else {
                        estimatedScore.className = 'text-yellow-600 dark:text-yellow-400';
                    }
                }
            }
            
            // å¼€å§‹æ–°æ¸¸æˆ
            function startGame(seed = null) {
                // ç”Ÿæˆæˆ–ä½¿ç”¨æä¾›çš„ç§å­
                gameState.currentSeed = seed || crypto.randomUUID();
                seedDisplay.textContent = gameState.currentSeed;
                
                // åˆå§‹åŒ–éšæœºæ•°ç”Ÿæˆå™¨
                seededRandom = createSeededRandom(gameState.currentSeed);
                
                // é‡ç½®æ¸¸æˆçŠ¶æ€
                gameState.deck = createDeck();
                gameState.deck = shuffleDeck(gameState.deck);
                gameState.hand = [];
                gameState.discardPile = [];
                gameState.score = 0;
                gameState.turn = 1;
                gameState.gameOver = false;
                
                // é‡ç½®é€‰æ‹©çŠ¶æ€
                resetSelectionState();
                
                // åˆå§‹åŒ–æ¸¸æˆåŒºåŸŸ
                initializeGameRegions();
                
                // æŠ½5å¼ èµ·å§‹æ‰‹ç‰Œ
                for (let i = 0; i < 5; i++) {
                    if (gameState.deck.length > 0) {
                        gameState.hand.push(drawCard());
                    }
                }
                
                // æ›´æ–°UI
                scoreDisplay.textContent = gameState.score;
                turnCounter.textContent = gameState.turn;
                remainingCardsDisplay.textContent = gameState.deck.length;
                updateDiscardCount();
                
                // æ›´æ–°å³ä¸‹è§’ä¿¡æ¯æ 
                updateCornerInfo();
                
                // æ¸²æŸ“æ‰‹ç‰Œ
                renderHand();
                
                // éšè—ç»“æœå¼¹çª—
                resultModal.classList.add('hidden');
                
                // é‡ç½®æ¸¸æˆæ—¥å¿—
                gameLogElement.innerHTML = '';
                gameLogData = [];
                
                // æ·»åŠ æ¸¸æˆå¼€å§‹æ—¥å¿—
                addLogEntry(t('gameStart'));
                
                // é‡ç½®å†å²è®°å½•å¹¶ä¿å­˜åˆå§‹çŠ¶æ€
                history = [];
                currentHistoryIndex = -1;
                addToHistory(saveGameState());
            }
            
            // æ£€æŸ¥æ˜¯å¦å®Œæˆäº†æ•´æ¡è·¯å¾„çš„å¾æœ
            function checkPathConquest(pathId) {
                // é¦–å…ˆæ£€æŸ¥è¯¥è·¯å¾„æ˜¯å¦å·²ç»è¢«å®Œå…¨å¾æœ
                const path = gameState.regions[pathId];
                const allOccupied = path.every(region => region.status === 'occupied');
                
                // å¦‚æœè·¯å¾„å·²ç»è¢«å®Œå…¨å¾æœï¼Œä¸”æ²¡æœ‰è¢«æ ‡è®°ä¸ºå·²å¾æœ
                if (allOccupied && !(gameState.conqueredPaths && gameState.conqueredPaths[pathId])) {
                    // åˆå§‹åŒ–å·²å¾æœè·¯å¾„è®°å½•
                    if (!gameState.conqueredPaths) {
                        gameState.conqueredPaths = {};
                    }
                    
                    // å¦‚æœè¯¥è·¯å¾„å·²ç»è¢«å¾æœï¼Œåˆ™è¿”å›
                    if (gameState.conqueredPaths[pathId]) {
                        return;
                    }
                    
                    // æ ‡è®°è¯¥è·¯å¾„ä¸ºå·²å¾æœ
                    gameState.conqueredPaths[pathId] = true;
                    
                    // è®¡ç®—å¥–åŠ±åˆ†æ•°
                    // 1. åŸºäºéšæœºç§å­é€‰æ‹©ä¸€ä¸ªèŠ±è‰²
                    const suitIndex = Math.floor(seededRandom() * SUITS.length);
                    const randomSuit = SUITS[suitIndex];
                    
                    // 2. è®¡ç®—è¯¥è·¯å¾„ä¸Šè¯¥èŠ±è‰²çš„æ•°é‡
                    let suitCount = 0;
                    for (const region of path) {
                        if (region.occupyCard && region.occupyCard.suit === randomSuit) {
                            suitCount++;
                        }
                    }
                    
                    // 3. è®¡ç®—å¥–åŠ±åˆ†æ•°: 200 * num^2
                    const bonusPoints = 200 * (suitCount * suitCount);
                    
                    // æ›´æ–°æ¸¸æˆæ€»åˆ†
                    gameState.score += bonusPoints;
                    scoreDisplay.textContent = gameState.score;
                    
                    // æ›´æ–°å³ä¸‹è§’ä¿¡æ¯æ 
                    updateCornerInfo();
                    
                    // å‡†å¤‡å¹¶æ˜¾ç¤ºå¾æœæˆå°±ä¿¡æ¯
                    const pathName = PATH_NAMES[pathId];
                    const conquestMessages = {
                        'land': `æ‚¨å¾æœäº†æ•´ä¸ª${pathName}ï¼å¤§åœ°åœ¨æ‚¨çš„è„šä¸‹è‡£æœï¼Œæ–‡æ˜çš„ç§å­å·²ç»éå¸ƒæ¯ä¸€å¯¸åœŸåœ°ã€‚`,
                        'ocean': `æ‚¨å¾æœäº†æ•´ä¸ª${pathName}ï¼æµ©ç€šçš„æµ·æ´‹å·²æˆä¸ºæ‚¨çš„é¢†åœ°ï¼Œèˆ°é˜Ÿæ‰€å‘æŠ«é¡ã€‚`,
                        'desert': `æ‚¨å¾æœäº†æ•´ä¸ª${pathName}ï¼è’èŠœä¹‹åœ°ä¹Ÿç»½æ”¾å‡ºæ‚¨æ–‡æ˜çš„èŠ±æœµï¼Œæ²¡æœ‰ä»»ä½•åœ°æ–¹èƒ½é˜»æŒ¡æ‚¨çš„æ‰©å¼ ã€‚`,
                        'sky': `æ‚¨å¾æœäº†æ•´ä¸ª${pathName}ï¼æ‚¨çš„æ°‘æ—å·²ç»æŒæ¡äº†åˆ¶ç©ºæƒï¼Œä»äº‘ç«¯ä¿¯ç°æ•´ä¸ªä¸–ç•Œã€‚`
                    };
                    
                    // æ˜¾ç¤ºå¾æœå¼¹çª—
                    const conquestModal = document.getElementById('conquest-modal');
                    const conquestMessage = document.getElementById('conquest-message');
                    const conquestPoints = document.getElementById('conquest-points');
                    
                    conquestMessage.textContent = conquestMessages[pathId];
                    conquestPoints.textContent = bonusPoints;
                    conquestModal.classList.remove('hidden');
                    
                    // æ·»åŠ å…³é—­æŒ‰é’®äº‹ä»¶
                    document.getElementById('conquest-close').addEventListener('click', () => {
                        conquestModal.classList.add('hidden');
                    }, { once: true });
                    
                    // è®°å½•åˆ°æ¸¸æˆæ—¥å¿—
                    const suitSymbol = SUIT_SYMBOLS[randomSuit];
                    addLogEntry(`<span class="font-bold text-yellow-500">ã€${pathName}å¾æœè€…ã€‘</span> å¾æœäº†æ•´ä¸ª${pathName}ï¼å¥–åŠ±: +${bonusPoints}åˆ† (200Ã—${suitSymbol}æ•°é‡Â²ï¼Œ${suitCount}ä¸ª${suitSymbol})`);
                }
            }
            
            // ç¿»è¯‘å‡½æ•°
            function t(key, replacements = {}) {
                let text = LANGUAGES[currentLanguage][key] || LANGUAGES['en'][key] || key;
                
                // åº”ç”¨æ›¿æ¢
                for (const [placeholder, value] of Object.entries(replacements)) {
                    text = text.replace(`{${placeholder}}`, value);
                }
                
                return text;
            }
            
            // æ£€æµ‹ç”¨æˆ·çš„æµè§ˆå™¨è¯­è¨€
            function detectBrowserLanguage() {
                const browserLang = navigator.language || navigator.userLanguage;
                const shortLang = browserLang.split('-')[0];
                
                // æ£€æŸ¥æ˜¯å¦æœ‰å®Œå…¨åŒ¹é…
                if (LANGUAGES[browserLang]) {
                    return browserLang;
                }
                
                // æ£€æŸ¥è¯­è¨€åŒ¹é…
                for (const lang in LANGUAGES) {
                    if (lang.startsWith(shortLang)) {
                        return lang;
                    }
                }
                
                // é»˜è®¤ä¸ºä¸­æ–‡
                return 'zh-CN';
            }
            
            // åº”ç”¨ç¿»è¯‘
            function applyTranslations() {
                document.querySelectorAll('[data-i18n]').forEach(element => {
                    const key = element.getAttribute('data-i18n');
                    element.textContent = t(key);
                });
            }
            
            // æ£€æŸ¥æš—é»‘æ¨¡å¼
            function checkDarkMode() {
                if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
                    document.documentElement.classList.add('dark');
                }
                
                window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', event => {
                    if (event.matches) {
                        document.documentElement.classList.add('dark');
                    } else {
                        document.documentElement.classList.remove('dark');
                    }
                });
            }
            
            // åˆå§‹åŒ–äº‹ä»¶ç›‘å¬å™¨
            function setupEventListeners() {
                // æ–°æ¸¸æˆæŒ‰é’®
                document.getElementById('new-game-btn').addEventListener('click', () => startGame());
                
                // æ’¤é”€æŒ‰é’®
                document.getElementById('undo-btn').addEventListener('click', undoMove);
                
                // ç»“æŸå›åˆæŒ‰é’®
                document.getElementById('end-turn-btn').addEventListener('click', endTurn);
                
                // å¼ƒç‰ŒæŒ‰é’®
                document.getElementById('discard-btn').addEventListener('click', discardCard);
                
                // å¤åˆ¶ç§å­æŒ‰é’®
                document.getElementById('copy-seed').addEventListener('click', copySeed);
                
                // åˆ†äº«æ¸¸æˆæŒ‰é’®
                document.getElementById('share-game').addEventListener('click', shareGame);
                
                // é¡¶éƒ¨ç§å­è¾“å…¥æ¡†éšæœºç§å­æŒ‰é’®
                document.getElementById('random-seed-btn').addEventListener('click', () => {
                    const newSeed = crypto.randomUUID();
                    const seedInput = document.getElementById('seed-input');
                    seedInput.value = newSeed;
                    seedInput.classList.add('bg-yellow-100', 'dark:bg-yellow-900');
                    setTimeout(() => {
                        seedInput.classList.remove('bg-yellow-100', 'dark:bg-yellow-900');
                    }, 1000);
                });
                
                // é¡¶éƒ¨ç§å­è¾“å…¥æ¡†å¼€å§‹æ¸¸æˆæŒ‰é’®
                document.getElementById('start-seed-game').addEventListener('click', () => {
                    const seedInput = document.getElementById('seed-input');
                    const seed = seedInput.value.trim();
                    if (seed) {
                        startGame(seed);
                        // æ›´æ–°æ¸¸æˆæ§åˆ¶åŒºçš„ç§å­æ˜¾ç¤º
                        seedDisplay.textContent = seed;
                    } else {
                        seedInput.classList.add('border-red-500');
                        setTimeout(() => {
                            seedInput.classList.remove('border-red-500');
                        }, 1000);
                    }
                });
                
                // ç§å­è¾“å…¥æ¡†å›è½¦é”®è§¦å‘å¼€å§‹æ¸¸æˆ
                document.getElementById('seed-input').addEventListener('keydown', (e) => {
                    if (e.key === 'Enter') {
                        document.getElementById('start-seed-game').click();
                    }
                });
                
                // éšæœºç§å­æŒ‰é’®ï¼ˆé¡¶éƒ¨ä¿¡æ¯åŒºï¼‰
                document.getElementById('random-seed').addEventListener('click', () => {
                    const newSeed = crypto.randomUUID();
                    // æ›´æ–°æ˜¾ç¤ºå’Œæ¸¸æˆçŠ¶æ€ä¸­çš„ç§å­
                    seedDisplay.textContent = newSeed;
                    gameState.currentSeed = newSeed;
                    
                    // åŒæ—¶æ›´æ–°ç§å­è¾“å…¥æ¡†
                    const seedInput = document.getElementById('seed-input');
                    if (seedInput) {
                        seedInput.value = newSeed;
                    }
                    
                    // é«˜äº®æ˜¾ç¤ºæç¤ºå·²æ›´æ–°
                    seedDisplay.classList.add('bg-yellow-100', 'dark:bg-yellow-900');
                    setTimeout(() => {
                        seedDisplay.classList.remove('bg-yellow-100', 'dark:bg-yellow-900');
                    }, 1000);
                });
                
                // æ˜¾ç¤ºè¾“å…¥ç§å­å¼¹çª—
            function showSeedInputPrompt() {
                // åˆ›å»ºå¼¹çª—æç¤º
                const promptOverlay = document.createElement('div');
                promptOverlay.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
                
                const promptBox = document.createElement('div');
                promptBox.className = 'bg-white dark:bg-gray-800 p-5 rounded-lg shadow-lg max-w-md w-full mx-4';
                
                const title = document.createElement('h3');
                title.className = 'text-xl font-bold mb-3 text-center';
                title.textContent = 'è¾“å…¥ç§å­';
                
                const message = document.createElement('p');
                message.className = 'mb-4 text-sm text-gray-600 dark:text-gray-400';
                message.textContent = 'è¾“å…¥ä¸€ä¸ªç§å­å€¼æ¥å¼€å§‹ç›¸åŒçš„æ¸¸æˆï¼Œæˆ–ä½¿ç”¨å½“å‰ç§å­é‡ç©ã€‚';
                
                const inputContainer = document.createElement('div');
                inputContainer.className = 'mb-4';
                
                const input = document.createElement('input');
                input.type = 'text';
                input.className = 'w-full p-2 border border-gray-300 dark:border-gray-600 rounded bg-white dark:bg-gray-700 text-gray-800 dark:text-gray-200';
                input.placeholder = 'è¾“å…¥ç§å­å€¼';
                input.value = gameState.currentSeed;
                input.spellcheck = false;
                
                inputContainer.appendChild(input);
                
                const buttonContainer = document.createElement('div');
                buttonContainer.className = 'flex justify-between gap-3';
                
                const startButton = document.createElement('button');
                startButton.className = 'bg-primary hover:bg-indigo-700 text-white px-4 py-2 rounded-lg flex-1';
                startButton.textContent = 'å¼€å§‹æ¸¸æˆ';
                startButton.addEventListener('click', () => {
                    const seed = input.value.trim();
                    if (seed) {
                        document.body.removeChild(promptOverlay);
                        startGame(seed);
                    } else {
                        input.classList.add('border-red-500');
                    }
                });
                
                const cancelButton = document.createElement('button');
                cancelButton.className = 'bg-gray-200 dark:bg-gray-700 hover:bg-gray-300 dark:hover:bg-gray-600 text-gray-700 dark:text-gray-300 px-4 py-2 rounded-lg flex-1';
                cancelButton.textContent = 'å–æ¶ˆ';
                cancelButton.addEventListener('click', () => {
                    document.body.removeChild(promptOverlay);
                });
                
                buttonContainer.appendChild(startButton);
                buttonContainer.appendChild(cancelButton);
                
                promptBox.appendChild(title);
                promptBox.appendChild(message);
                promptBox.appendChild(inputContainer);
                promptBox.appendChild(buttonContainer);
                promptOverlay.appendChild(promptBox);
                
                document.body.appendChild(promptOverlay);
                
                // è‡ªåŠ¨èšç„¦è¾“å…¥æ¡†
                setTimeout(() => {
                    input.focus();
                    input.select();
                }, 100);
                
                // æ·»åŠ æŒ‰å›è½¦é”®æäº¤
                input.addEventListener('keydown', (e) => {
                    if (e.key === 'Enter') {
                        startButton.click();
                    }
                });
            }
            
            // è¾“å…¥ç§å­æŒ‰é’®
            document.getElementById('input-seed').addEventListener('click', () => {
                showSeedInputPrompt();
            });
                
                // æ¸¸æˆç»“æŸå¼¹çª—çš„æŒ‰é’®
                document.getElementById('play-again').addEventListener('click', () => startGame());
                document.getElementById('replay-same-seed').addEventListener('click', () => startGame(gameState.currentSeed));
                document.getElementById('share-result').addEventListener('click', shareGame);
                
                // å†å²æµè§ˆå™¨æŒ‰é’®
                document.getElementById('history-btn').addEventListener('click', () => {
                    // æ˜¾ç¤ºå†å²æµè§ˆå™¨
                    const historyModal = document.getElementById('history-modal');
                    if (historyModal) {
                        historyModal.classList.remove('hidden');
                    }
                });
                
                // å†å²æµè§ˆå™¨çš„å–æ¶ˆæŒ‰é’®
                document.getElementById('history-cancel').addEventListener('click', () => {
                    const historyModal = document.getElementById('history-modal');
                    if (historyModal) {
                        historyModal.classList.add('hidden');
                    }
                });
            }
            
            // åˆå§‹åŒ–
            function init() {
                // è®¾ç½®å½“å‰è¯­è¨€
                currentLanguage = detectBrowserLanguage();
                
                // åº”ç”¨ç¿»è¯‘
                applyTranslations();
                
                // æ£€æŸ¥æš—é»‘æ¨¡å¼
                checkDarkMode();
                
                // è®¾ç½®äº‹ä»¶ç›‘å¬å™¨
                setupEventListeners();
                
                // æ£€æŸ¥URLæ˜¯å¦åŒ…å«ç§å­å‚æ•°ï¼ˆæ”¯æŒcodeæˆ–seedå‚æ•°ï¼‰
                let seedFromURL = null;
                try {
                    const urlParams = new URLSearchParams(window.location.search);
                    // ä¼˜å…ˆä½¿ç”¨codeå‚æ•°ï¼Œå¦‚æœæ²¡æœ‰åˆ™å°è¯•ä½¿ç”¨seedå‚æ•°
                    seedFromURL = urlParams.get('code') || urlParams.get('seed');
                } catch (error) {
                    console.error("Error parsing URL parameters:", error);
                }
                
                // å¦‚æœæœ‰URLç§å­ï¼ŒåŒæ—¶æ›´æ–°ç§å­è¾“å…¥æ¡†
                if (seedFromURL) {
                    const seedInput = document.getElementById('seed-input');
                    if (seedInput) {
                        seedInput.value = seedFromURL;
                    }
                }
                
                // å¼€å§‹æ¸¸æˆ
                startGame(seedFromURL);
            }

            function renderHistoryBoard(state) {
                const historyBoardElement = document.getElementById('history-board');
                if (!historyBoardElement) return;

                historyBoardElement.innerHTML = ''; // æ¸…ç©ºé¢æ¿

                // åˆ›å»ºè·¯å¾„æ ‡é¢˜
                const pathTitles = document.createElement('div');
                pathTitles.className = 'grid grid-cols-4 gap-2 mb-2 text-center';
                // æ³¨æ„ï¼šè¿™é‡Œéœ€è¦è°ƒæ•´å®½åº¦ï¼Œä½¿å…¶ä¸ä¸‹æ–¹åŒºåŸŸæ ¼å­å¯¹é½
                pathTitles.style.width = 'fit-content'; // æˆ–è€…ä¸€ä¸ªå›ºå®šçš„å®½åº¦
                pathTitles.style.margin = '0 auto'; // å±…ä¸­

                PATHS.forEach(pathId => {
                    const title = document.createElement('div');
                    title.className = `text-white rounded px-1 py-1 text-center font-bold text-xs w-16 md:w-20 mx-auto flex items-center justify-center bg-${pathId}`; // ä½¿ç”¨è·¯å¾„é¢œè‰²
                    title.textContent = PATH_NAMES[pathId]; // ä½¿ç”¨ç¿»è¯‘çš„è·¯å¾„åç§°
                    pathTitles.appendChild(title);
                });
                historyBoardElement.appendChild(pathTitles);


                // åˆ›å»ºåŒºåŸŸå®¹å™¨ï¼Œæ¨¡æ‹Ÿä¸»æ¸¸æˆåŒºåŸŸçš„ç»“æ„
                const gameAreaContainer = document.createElement('div');
                gameAreaContainer.className = 'flex justify-center';
                const regionsGrid = document.createElement('div');
                regionsGrid.className = 'grid grid-cols-4 gap-2';
                regionsGrid.style.width = 'fit-content'; // æˆ–è€…ä¸€ä¸ªå›ºå®šçš„å®½åº¦

                // ä¸ºæ¯æ¡è·¯å¾„åˆ›å»ºåˆ—å®¹å™¨
                const pathContainers = {};
                PATHS.forEach(pathId => {
                    pathContainers[pathId] = document.createElement('div');
                    pathContainers[pathId].className = 'flex flex-col gap-1';
                    regionsGrid.appendChild(pathContainers[pathId]);
                });

                // éå†æ‰€æœ‰åŒºåŸŸï¼Œå¹¶æ¸²æŸ“åˆ°å¯¹åº”çš„è·¯å¾„å®¹å™¨ä¸­ (å€’åºæ¸²æŸ“)
                PATHS.forEach(pathId => {
                    const pathRegions = state.regions[pathId];
                    for (let i = 12; i >= 0; i--) { // ä»13åˆ°1
                        const region = pathRegions[i];
                        const regionElement = document.createElement('div');

                        // ä½¿ç”¨ä¸ä¸»æ¸¸æˆåŒºåŸŸç›¸åŒçš„å°ºå¯¸å’ŒåŸºç¡€æ ·å¼
                        regionElement.className = 'rounded-md w-16 h-24 md:w-20 md:h-30 border shadow-md flex flex-col items-center justify-center relative';

                        // æ ¹æ®åŒºåŸŸçŠ¶æ€å’Œç±»å‹è®¾ç½®æ ·å¼ (å¤åˆ¶ updateRegionDisplay ä¸­çš„é€»è¾‘)
                        if (region.status === 'unexplored') {
                            regionElement.classList.add('bg-gray-400', 'dark:bg-gray-700');
                        } else if (region.status === 'explored') {
                            regionElement.classList.add('bg-white', 'dark:bg-gray-600');
                            if (region.type === 'forgotten') {
                                regionElement.classList.add('bg-gray-200', 'dark:bg-gray-700', 'opacity-75');
                            }
                        } else if (region.status === 'occupied') {
                            regionElement.classList.add('bg-blue-100', 'dark:bg-blue-800');
                        }

                        if (region.type === 'echo' && region.status !== 'occupied') {
                            regionElement.classList.add('bg-green-200', 'dark:bg-green-800');
                        }
                        if (region.type === 'wonder' && region.wonderData) {
                            const tierClass = `wonder-${region.wonderData.tier}`;
                            regionElement.classList.add(tierClass);
                        }
                        if (region.type === 'combat' && region.combatData) {
                            const tierClass = `combat-${region.combatData.tier}`;
                            regionElement.classList.add(tierClass);
                        }


                        // åŒºåŸŸç­‰çº§æ˜¾ç¤º
                        const rankElement = document.createElement('div');
                        rankElement.className = 'text-sm font-bold absolute top-1 left-1';
                        rankElement.textContent = i + 1; // æ˜¾ç¤ºæ•°å­—1-13
                        regionElement.appendChild(rankElement);


                        // æ ¹æ®åŒºåŸŸç±»å‹å’ŒçŠ¶æ€æ·»åŠ ä¸åŒçš„å†…å®¹ (å¤åˆ¶ updateRegionDisplay ä¸­çš„é€»è¾‘)
                        if (region.type === 'wonder' && region.wonderData) {
                            if (region.status === 'unexplored') {
                                const unknownElement = document.createElement('div');
                                unknownElement.className = 'text-lg font-bold text-white text-center';
                                unknownElement.textContent = '???';
                                regionElement.appendChild(unknownElement);
                            }
                            else if (region.status === 'explored') {
                                const nameElement = document.createElement('div');
                                nameElement.className = 'text-xs font-bold text-center px-1 mb-1';
                                nameElement.textContent = region.wonderData.name;
                                regionElement.appendChild(nameElement);

                                const conditionElement = document.createElement('div');
                                conditionElement.className = 'text-xs text-center';
                                conditionElement.textContent = 'éœ€è¦: Jã€Qã€Kã€Aæˆ–çº¢å¿ƒ';
                                regionElement.appendChild(conditionElement);

                                const effectElement = document.createElement('div');
                                effectElement.className = 'text-xs text-center mt-1 px-1';
                                const effectText = region.wonderData.effect.name;
                                effectElement.textContent = `[${effectText}]`;
                                regionElement.appendChild(effectElement);
                            }
                            else if (region.status === 'occupied') {
                                const nameElement = document.createElement('div');
                                nameElement.className = 'text-xs font-bold text-center px-1 mb-1';
                                nameElement.textContent = region.wonderData.name;
                                regionElement.appendChild(nameElement);

                                if (region.occupyCard) {
                                    const card = region.occupyCard;
                                    const cardElement = document.createElement('div');
                                    cardElement.className = 'flex items-center justify-center';
                                    const cardRank = document.createElement('div'); cardRank.className = 'text-sm font-bold'; cardRank.textContent = card.rank;
                                    const cardSuit = document.createElement('div'); cardSuit.className = `${card.suit} text-lg`; cardSuit.textContent = SUIT_SYMBOLS[card.suit];
                                    cardElement.appendChild(cardRank); cardElement.appendChild(cardSuit); regionElement.appendChild(cardElement);
                                }
                                const effectElement = document.createElement('div');
                                effectElement.className = 'text-xs text-center mt-1 px-1';
                                const effectText = region.wonderData.effect.name;
                                effectElement.textContent = `[${effectText}]`;
                                regionElement.appendChild(effectElement);

                                if (region.points > 0) {
                                    const pointsElement = document.createElement('div');
                                    pointsElement.className = 'absolute bottom-1 right-1 text-xs font-bold bg-blue-200 dark:bg-blue-600 px-1 rounded';
                                    pointsElement.textContent = `+${region.points}`;
                                    regionElement.appendChild(pointsElement);
                                }
                            }
                        }
                        else if (region.type === 'combat' && region.combatData) {
                            if (region.status === 'unexplored') {
                                const unknownElement = document.createElement('div');
                                unknownElement.className = 'text-lg font-bold text-white text-center';
                                unknownElement.textContent = '???';
                                regionElement.appendChild(unknownElement);
                            } else if (region.status === 'explored') {
                                const nameElement = document.createElement('div');
                                nameElement.className = 'text-xs font-bold text-center px-1 mb-1';
                                nameElement.textContent = region.combatData.name;
                                regionElement.appendChild(nameElement);
                                const conditionElement = document.createElement('div');
                                conditionElement.className = 'text-xs text-center';
                                conditionElement.textContent = region.combatData.requirement.display;
                                regionElement.appendChild(conditionElement);
                                const effectElement = document.createElement('div');
                                effectElement.className = 'text-xs text-center mt-1 px-1 text-red-500 dark:text-red-400';
                                effectElement.textContent = region.combatData.effect.name;
                                regionElement.appendChild(effectElement);
                                // No click prompt in history view
                            }
                        }
                        else if (region.type === 'forgotten') {
                            const statusIndicator = document.createElement('div');
                            statusIndicator.className = 'absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 text-xs font-bold';
                            statusIndicator.textContent = t('forgottenRegion');
                            statusIndicator.className += ' text-gray-500 dark:text-gray-400';
                            regionElement.appendChild(statusIndicator);
                        }
                        else { // standard, echo
                            if (region.status !== 'occupied') {
                                const statusIndicator = document.createElement('div');
                                statusIndicator.className = 'absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 text-xs font-bold';
                                if (region.status === 'unexplored') {
                                    statusIndicator.textContent = t('unexploredRegion');
                                    statusIndicator.className += ' text-gray-100 dark:text-gray-300';
                                } else if (region.status === 'explored') {
                                    statusIndicator.textContent = t('exploredRegion');
                                    statusIndicator.className += ' text-green-600 dark:text-green-400';
                                }
                                regionElement.appendChild(statusIndicator);
                            }
                            if (region.type === 'echo') {
                                const typeIndicator = document.createElement('div');
                                typeIndicator.className = 'absolute top-1 right-1 w-2 h-2 rounded-full bg-green-400 dark:bg-green-300';
                                regionElement.appendChild(typeIndicator);
                            }
                            if (region.status === 'occupied' && region.occupyCard) {
                                const card = region.occupyCard;
                                const cardInfo = document.createElement('div');
                                cardInfo.className = 'flex flex-col items-center justify-center';
                                const cardRank = document.createElement('div'); cardRank.className = 'text-lg font-bold'; cardRank.textContent = card.rank;
                                const cardSuit = document.createElement('div'); cardSuit.className = `${card.suit} text-2xl`; cardSuit.textContent = SUIT_SYMBOLS[card.suit];
                                cardInfo.appendChild(cardRank); cardInfo.appendChild(cardSuit); regionElement.appendChild(cardInfo);

                                const pointsElement = document.createElement('div');
                                pointsElement.className = 'absolute bottom-1 right-1 text-xs font-bold bg-blue-200 dark:bg-blue-600 px-1 rounded';
                                pointsElement.textContent = `+${region.points}`;
                                regionElement.appendChild(pointsElement);
                            }
                        }


                        pathContainers[pathId].appendChild(regionElement);
                    }
                });

                gameAreaContainer.appendChild(regionsGrid);
                historyBoardElement.appendChild(gameAreaContainer);
            }

            // åœ¨å†å²æµè§ˆå™¨æ‰“å¼€æ—¶è°ƒç”¨æ­¤å‡½æ•°
            document.getElementById('history-btn').addEventListener('click', () => {
                const historyModal = document.getElementById('history-modal');
                if (historyModal) {
                    // é‡ç½®æµè§ˆç´¢å¼•åˆ°å½“å‰çŠ¶æ€
                    currentBrowsingIndex = currentHistoryIndex;
                    updateHistoryDisplay(); // æ›´æ–°å†å²æµè§ˆå™¨æ˜¾ç¤º

                    historyModal.classList.remove('hidden');
                }
            });

            // æ›´æ–°å†å²æµè§ˆå™¨æ˜¾ç¤ºçš„å‡½æ•°
            function updateHistoryDisplay() {
                if (currentBrowsingIndex < 0 || currentBrowsingIndex >= history.length) {
                    console.error("Invalid history index:", currentBrowsingIndex);
                    return;
                }

                const state = history[currentBrowsingIndex];
                const historyTurnEl = document.getElementById('history-turn');
                const historyIndexEl = document.getElementById('history-index');
                const historyTotalEl = document.getElementById('history-total');
                const historyScoreEl = document.getElementById('history-score');
                const historyActionDescEl = document.getElementById('history-action-desc');
                const historyPrevBtn = document.getElementById('history-prev');
                const historyNextBtn = document.getElementById('history-next');


                historyTurnEl.textContent = state.turn;
                historyIndexEl.textContent = currentBrowsingIndex;
                historyTotalEl.textContent = history.length -1; // æ˜¾ç¤ºæ€»æ“ä½œæ•° (åˆå§‹çŠ¶æ€ç´¢å¼•0ä¸è®¡å…¥æ“ä½œ)
                historyScoreEl.textContent = state.score;

                // TODO: Fetch and display action description based on index and previous state? Or store descriptions in history?
                // For now, display the log message for this step (if available).
                // The gameLogData records *after* the action, so index 'i' corresponds to the state *after* logData[i-1]'s action.
                const logIndex = currentBrowsingIndex > 0 ? currentBrowsingIndex -1 : 0; // Initial state (0) has no action description
                if (gameLogData.length > logIndex) {
                    historyActionDescEl.textContent = currentBrowsingIndex === 0 ? "æ¸¸æˆå¼€å§‹" : gameLogData[logIndex].message.replace(/<[^>]*>/g, ''); // ç§»é™¤HTMLæ ‡ç­¾
                } else {
                    historyActionDescEl.textContent = "---";
                }


                renderHistoryBoard(state); // æ¸²æŸ“é¢æ¿

                // æ›´æ–°å‰è¿›/åé€€æŒ‰é’®çŠ¶æ€
                historyPrevBtn.disabled = currentBrowsingIndex <= 0;
                historyPrevBtn.classList.toggle('opacity-50', currentBrowsingIndex <= 0);
                historyNextBtn.disabled = currentBrowsingIndex >= history.length - 1;
                historyNextBtn.classList.toggle('opacity-50', currentBrowsingIndex >= history.length - 1);
            }


            // æ·»åŠ å†å²æµè§ˆå™¨å‰è¿›/åé€€æŒ‰é’®äº‹ä»¶
            document.getElementById('history-prev').addEventListener('click', () => {
                if (currentBrowsingIndex > 0) {
                    currentBrowsingIndex--;
                    updateHistoryDisplay();
                }
            });

            document.getElementById('history-next').addEventListener('click', () => {
                if (currentBrowsingIndex < history.length - 1) {
                    currentBrowsingIndex++;
                    updateHistoryDisplay();
                }
            });

            // å†å²æµè§ˆå™¨é€‰æ‹©å½“å‰çŠ¶æ€æŒ‰é’®
            document.getElementById('history-select').addEventListener('click', () => {
                if (currentBrowsingIndex >= 0 && currentBrowsingIndex < history.length) {
                    // æ¢å¤åˆ°é€‰ä¸­çš„å†å²çŠ¶æ€
                    currentHistoryIndex = currentBrowsingIndex; // è®¾ç½®å½“å‰å†å²ç´¢å¼•
                    restoreGameState(history[currentHistoryIndex]); // æ¢å¤æ¸¸æˆçŠ¶æ€

                    // å…³é—­å†å²æµè§ˆå™¨
                    const historyModal = document.getElementById('history-modal');
                    if (historyModal) {
                        historyModal.classList.add('hidden');
                    }

                    // æç¤ºç”¨æˆ·å·²æ¢å¤çŠ¶æ€
                    showMessage(`å·²æ¢å¤åˆ°å›åˆ ${gameState.turn} çš„çŠ¶æ€`);
                }
            });
            
            // å½“é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–æ¸¸æˆ
            window.addEventListener('DOMContentLoaded', init);
        </script>
    </div>
</body>
</html>
